# Grafana datasource provisioning for Prometheus
# Auto-configures Prometheus as the default data source

apiVersion: 1

datasources:
  - name: Prometheus
    uid: prometheus
    type: prometheus
    access: proxy
    url: http://prometheus:9090
    isDefault: true
    editable: false
    jsonData:
      timeInterval: '15s'
      httpMethod: POST

  # Alertmanager datasource for alert integration
  - name: Alertmanager
    uid: alertmanager
    type: alertmanager
    access: proxy
    url: http://alertmanager:9093
    isDefault: false
    editable: false
    jsonData:
      implementation: prometheus
      handleGrafanaManagedAlerts: false

  # JSON API datasource for direct backend API access
  - name: Backend-API
    uid: Backend-API
    type: marcusolsson-json-datasource
    access: proxy
    url: http://backend:8000
    isDefault: false
    editable: false
    jsonData:
      tlsSkipVerify: true

  # Jaeger datasource for distributed tracing with metric correlations
  - name: Jaeger
    uid: PC9A941E8F2E49454
    type: jaeger
    access: proxy
    url: http://jaeger:16686
    isDefault: false
    editable: false
    jsonData:
      nodeGraph:
        enabled: true
      # Trace-to-Profile integration (NEM-4129): Click from trace span to Pyroscope profile
      tracesToProfiles:
        datasourceUid: pyroscope
        profileTypeId: 'process_cpu:cpu:nanoseconds:cpu:nanoseconds'
        customQuery: true
        query: '{service_name="${__span.tags["service.name"]}", trace_id="${__span.traceId}"}'
        tags:
          - key: service.name
            value: service
      tracesToMetrics:
        datasourceUid: prometheus
        spanStartTimeShift: '-5m'
        spanEndTimeShift: '5m'
        tags:
          - key: 'service.name'
            value: 'service'
          - key: 'db.system'
            value: 'db_system'
          - key: 'http.method'
            value: 'method'
          - key: 'http.status_code'
            value: 'status_code'
        queries:
          # Pipeline Health
          - name: 'Pipeline Errors/min'
            query: 'rate(hsi_pipeline_errors_total[1m]) * 60'
          - name: 'Detection Queue Depth'
            query: 'hsi_detection_queue_depth'
          - name: 'Analysis Queue Depth'
            query: 'hsi_analysis_queue_depth'
          - name: 'Circuit Breaker State'
            query: 'hsi_circuit_breaker_state'
          - name: 'System Health'
            query: 'hsi_system_healthy_healthy'

          # AI Service Latencies
          - name: 'YOLO26 Latency (p95)'
            query: 'histogram_quantile(0.95, rate(yolo26_inference_latency_seconds_bucket[5m]))'
          - name: 'Nemotron Tokens/sec'
            query: 'hsi_nemotron_tokens_per_second'
          - name: 'Florence Latency (p95)'
            query: 'histogram_quantile(0.95, rate(florence_inference_latency_seconds_bucket[5m]))'
          - name: 'CLIP Latency (p95)'
            query: 'histogram_quantile(0.95, rate(clip_inference_latency_seconds_bucket[5m]))'
          - name: 'Enrichment Latency (p95)'
            query: 'histogram_quantile(0.95, rate(enrichment_inference_latency_seconds_bucket[5m]))'

          # Batch Processing
          - name: 'Batch Latency (avg)'
            query: 'hsi_batch_latency_avg_ms'
          - name: 'Batch Latency (p95)'
            query: 'hsi_batch_latency_p95_ms'
          - name: 'Batch Latency (p99)'
            query: 'hsi_batch_latency_p99_ms'
          - name: 'Detect Latency (p95)'
            query: 'hsi_detect_latency_p95_ms'
          - name: 'Analyze Latency (p95)'
            query: 'hsi_analyze_latency_p95_ms'

          # Database Performance
          - name: 'DB Query Latency (p95)'
            query: 'histogram_quantile(0.95, rate(hsi_db_query_duration_seconds_bucket[5m]))'
          - name: 'Slow Queries/min'
            query: 'rate(hsi_slow_queries_total[1m]) * 60'
          - name: 'Database Health'
            query: 'hsi_database_healthy_healthy'

          # Redis/Cache Performance
          - name: 'Redis Commands/sec'
            query: 'rate(redis_commands_processed_total[1m])'
          - name: 'Redis Memory MB'
            query: 'redis_memory_used_bytes / 1024 / 1024'
          - name: 'Cache Hit Rate %'
            query: '100 * hsi_cache_hits_total / (hsi_cache_hits_total + hsi_cache_misses_total)'
          - name: 'Redis Clients'
            query: 'redis_connected_clients'
          - name: 'Redis Health'
            query: 'hsi_redis_healthy_healthy'

          # GPU Metrics
          - name: 'GPU Utilization %'
            query: 'hsi_gpu_utilization'
          - name: 'GPU Temperature C'
            query: 'hsi_gpu_temperature'
          - name: 'GPU Memory Used MB'
            query: 'hsi_gpu_memory_used_mb'
          - name: 'GPU Memory Total MB'
            query: 'hsi_gpu_memory_total_mb'
          - name: 'GPU Power Watts'
            query: 'hsi_gpu_power_limit_watts'

          # LLM/Nemotron Specific
          - name: 'LLM Context Utilization %'
            query: '100 * hsi_llm_context_utilization_sum / hsi_llm_context_utilization_count'
          - name: 'Prompt Tokens (avg)'
            query: 'hsi_prompt_tokens_sum / hsi_prompt_tokens_count'
          - name: 'Prompts Truncated/min'
            query: 'rate(hsi_prompts_truncated_total[1m]) * 60'
          - name: 'High Utilization Prompts/min'
            query: 'rate(hsi_prompts_high_utilization_total[1m]) * 60'

          # Enrichment Model Zoo
          - name: 'Enrichment Calls/min'
            query: 'rate(hsi_enrichment_model_calls_total[1m]) * 60'
          - name: 'Enrichment Errors/min'
            query: 'rate(hsi_enrichment_model_errors_total[1m]) * 60'
          - name: 'Enrichment Success Rate %'
            query: '100 * hsi_enrichment_success_rate'
          - name: 'Partial Batches/min'
            query: 'rate(hsi_enrichment_partial_batches_total[1m]) * 60'

          # Detection Metrics
          - name: 'Detections/min'
            query: 'rate(hsi_detections_processed_total[1m]) * 60'
          - name: 'Filtered (Low Conf)/min'
            query: 'rate(hsi_detections_filtered_low_confidence_total[1m]) * 60'
          - name: 'Avg Confidence'
            query: 'hsi_detection_confidence_sum / hsi_detection_confidence_count'

          # Event Metrics
          - name: 'Events Created/min'
            query: 'rate(hsi_events_created_total[1m]) * 60'
          - name: 'High Risk Events/min'
            query: 'rate(hsi_events_by_risk_level_total{level="high"}[1m]) * 60'
          - name: 'Critical Events/min'
            query: 'rate(hsi_events_by_risk_level_total{level="critical"}[1m]) * 60'
          - name: 'Avg Risk Score'
            query: 'hsi_risk_score_sum / hsi_risk_score_count'

          # Cost Tracking
          - name: 'Daily Cost USD'
            query: 'hsi_daily_cost_usd'
          - name: 'Monthly Cost USD'
            query: 'hsi_monthly_cost_usd'
          - name: 'Cost per Detection'
            query: 'hsi_cost_per_detection_usd'
          - name: 'Cost per Event'
            query: 'hsi_cost_per_event_usd'

          # SLO Metrics
          - name: 'API Availability (1h)'
            query: '100 * hsi:api_availability:ratio_rate1h'
          - name: 'API Success Rate (5m)'
            query: '100 * hsi:api_requests:success_rate_5m'
          - name: 'Error Budget Remaining %'
            query: '100 * hsi:error_budget:api_availability_remaining'

          # Worker Pool
          - name: 'Workers Active'
            query: 'hsi_worker_active_count'
          - name: 'Workers Busy'
            query: 'hsi_worker_busy_count'
          - name: 'Workers Idle'
            query: 'hsi_worker_idle_count'

  # Loki datasource for log aggregation with trace correlation
  - name: Loki
    uid: loki
    type: loki
    access: proxy
    url: http://loki:3100
    isDefault: false
    editable: false
    jsonData:
      maxLines: 1000
      derivedFields:
        # Link logs to traces via trace_id
        - name: TraceID
          matcherRegex: 'trace_id=([a-f0-9]{32})'
          url: '${__value.raw}'
          datasourceUid: PC9A941E8F2E49454
          urlDisplayLabel: 'View Trace'

  # Pyroscope datasource for continuous profiling
  - name: Pyroscope
    uid: pyroscope
    type: grafana-pyroscope-datasource
    access: proxy
    url: http://pyroscope:4040
    isDefault: false
    editable: false
    jsonData:
      # Profile-to-Trace navigation: Link back to Jaeger traces from Pyroscope
      tracesToProfiles:
        datasourceUid: PC9A941E8F2E49454
        tags:
          - key: service.name
            value: service
        profileTypeId: 'process_cpu:cpu:nanoseconds:cpu:nanoseconds'
        customQuery: true
        query: '{service_name="${__span.tags["service.name"]}", trace_id="${__span.traceId}"}'

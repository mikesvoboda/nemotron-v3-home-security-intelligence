# SLI/SLO Recording Rules for Home Security Intelligence
# These rules pre-compute Service Level Indicators for efficient dashboard queries
# Updated to use actual metric names from backend/core/metrics.py

groups:
  # API Availability SLI
  # Uses blackbox probe success as availability indicator since backend doesn't expose http_requests_total
  - name: api_availability_sli
    interval: 30s
    rules:
      # Request success rate based on blackbox probe
      - record: hsi:api_requests:success_rate_5m
        expr: |
          avg_over_time(probe_success{job="blackbox-http-ready"}[5m])

      # API availability over different windows using blackbox probes
      - record: hsi:api_availability:ratio_rate1h
        expr: |
          avg_over_time(probe_success{job="blackbox-http-ready"}[1h])

      - record: hsi:api_availability:ratio_rate6h
        expr: |
          avg_over_time(probe_success{job="blackbox-http-ready"}[6h])

      - record: hsi:api_availability:ratio_rate1d
        expr: |
          avg_over_time(probe_success{job="blackbox-http-ready"}[1d])

      - record: hsi:api_availability:ratio_rate30d
        expr: |
          avg_over_time(probe_success{job="blackbox-http-ready"}[30d])

  # =============================================================================
  # Detection and Analysis Latency SLI Recording Rules
  # These rules pre-compute P95 and P99 latencies for SLI/SLO dashboard panels
  # =============================================================================

  # Detection Latency SLI - RT-DETR object detection latency
  - name: detection_latency_sli
    interval: 30s
    rules:
      # P95 detection latency over 5 minute window
      - record: hsi:detection_latency:p95_5m
        expr: histogram_quantile(0.95, sum(rate(hsi_stage_duration_seconds_bucket{stage="detect"}[5m])) by (le))

      # P99 detection latency over 5 minute window
      - record: hsi:detection_latency:p99_5m
        expr: histogram_quantile(0.99, sum(rate(hsi_stage_duration_seconds_bucket{stage="detect"}[5m])) by (le))

      # Detection success rate (complement of error rate)
      - record: hsi:detection:success_rate_5m
        expr: 1 - (sum(rate(hsi_pipeline_errors_total{error_type="detection"}[5m])) / (sum(rate(hsi_detections_processed_total[5m])) + 0.001))

      # Percentage of detections within SLO (< 2s)
      - record: hsi:detection_latency:within_slo_rate5m
        expr: sum(rate(hsi_stage_duration_seconds_bucket{stage="detect",le="2"}[5m])) / (sum(rate(hsi_stage_duration_seconds_count{stage="detect"}[5m])) + 0.001)

  # Analysis Latency SLI - LLM analysis latency (Nemotron)
  - name: analysis_latency_sli
    interval: 30s
    rules:
      # P95 analysis latency over 5 minute window
      - record: hsi:analysis_latency:p95_5m
        expr: histogram_quantile(0.95, sum(rate(hsi_stage_duration_seconds_bucket{stage="analyze"}[5m])) by (le))

      # P99 analysis latency over 5 minute window
      - record: hsi:analysis_latency:p99_5m
        expr: histogram_quantile(0.99, sum(rate(hsi_stage_duration_seconds_bucket{stage="analyze"}[5m])) by (le))

      # Analysis success rate (complement of error rate)
      - record: hsi:analysis:success_rate_5m
        expr: 1 - (sum(rate(hsi_pipeline_errors_total{error_type="analysis"}[5m])) / (sum(rate(hsi_events_created_total[5m])) + 0.001))

      # Percentage of analyses within SLO (< 30s)
      - record: hsi:analysis_latency:within_slo_rate5m
        expr: sum(rate(hsi_stage_duration_seconds_bucket{stage="analyze",le="30"}[5m])) / (sum(rate(hsi_stage_duration_seconds_count{stage="analyze"}[5m])) + 0.001)

  # Event Processing SLI - DISABLED (metrics not implemented)
  # - name: event_processing_sli
  #   interval: 30s
  #   rules:
  #     - record: hsi:event_processing_latency:p95_5m
  #       expr: histogram_quantile(0.95, sum(rate(hsi_event_processing_duration_seconds_bucket[5m])) by (le))
  #     - record: hsi:event_processing_latency:within_slo_rate5m
  #       expr: sum(rate(hsi_event_processing_duration_seconds_bucket{le="5"}[5m])) / sum(rate(hsi_event_processing_duration_seconds_count[5m]))

  # WebSocket Availability SLI - DISABLED (metrics not implemented)
  # - name: websocket_availability_sli
  #   interval: 30s
  #   rules:
  #     - record: hsi:websocket:connection_success_rate_5m
  #       expr: sum(rate(hsi_websocket_connections_successful[5m])) / sum(rate(hsi_websocket_connection_attempts[5m]))
  #     - record: hsi:websocket:active_connections
  #       expr: sum(hsi_websocket_active_connections)

  # Infrastructure Health SLI
  - name: infrastructure_health_sli
    interval: 30s
    rules:
      # Backend health
      - record: hsi:backend:healthy
        expr: probe_success{job="blackbox-http-live", service="backend"}

      # Redis health
      - record: hsi:redis:healthy
        expr: up{job="redis"}

      # GPU memory utilization (actual metrics use MB not bytes)
      - record: hsi:gpu:memory_utilization
        expr: |
          hsi_gpu_memory_used_mb
          /
          hsi_gpu_memory_total_mb

      # GPU utilization (actual metric name, already 0-100)
      - record: hsi:gpu:utilization
        expr: hsi_gpu_utilization

  # Error Budget Calculations
  - name: error_budget
    interval: 1m
    rules:
      # API availability error budget remaining (target: 99.5%)
      - record: hsi:error_budget:api_availability_remaining
        expr: |
          1 - (
            (1 - hsi:api_availability:ratio_rate30d)
            /
            (1 - 0.995)
          )

      # Detection latency error budget remaining (target: 95% within SLO)
      - record: hsi:error_budget:detection_latency_remaining
        expr: 1 - ((1 - hsi:detection_latency:within_slo_rate5m) / (1 - 0.95))

      # Analysis latency error budget remaining (target: 95% within SLO)
      - record: hsi:error_budget:analysis_latency_remaining
        expr: 1 - ((1 - hsi:analysis_latency:within_slo_rate5m) / (1 - 0.95))

  # Burn Rate Calculations
  - name: burn_rate
    interval: 1m
    rules:
      # API availability burn rates
      - record: hsi:burn_rate:api_availability_1h
        expr: |
          (1 - hsi:api_availability:ratio_rate1h) / (1 - 0.995)

      - record: hsi:burn_rate:api_availability_6h
        expr: |
          (1 - hsi:api_availability:ratio_rate6h) / (1 - 0.995)

      - record: hsi:burn_rate:api_availability_1d
        expr: |
          (1 - hsi:api_availability:ratio_rate1d) / (1 - 0.995)

      # Detection latency burn rates
      - record: hsi:burn_rate:detection_latency_1h
        expr: (1 - avg_over_time(hsi:detection_latency:within_slo_rate5m[1h])) / (1 - 0.95)

      - record: hsi:burn_rate:detection_latency_6h
        expr: (1 - avg_over_time(hsi:detection_latency:within_slo_rate5m[6h])) / (1 - 0.95)

      # Analysis latency burn rates
      - record: hsi:burn_rate:analysis_latency_1h
        expr: (1 - avg_over_time(hsi:analysis_latency:within_slo_rate5m[1h])) / (1 - 0.95)

      - record: hsi:burn_rate:analysis_latency_6h
        expr: (1 - avg_over_time(hsi:analysis_latency:within_slo_rate5m[6h])) / (1 - 0.95)

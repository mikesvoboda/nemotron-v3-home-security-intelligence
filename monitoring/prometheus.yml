# Prometheus configuration for Home Security Intelligence
# Scrapes native Prometheus metrics from backend /api/metrics endpoint
# Also scrapes JSON endpoints via JSON exporter for health/telemetry/stats

global:
  scrape_interval: 15s
  evaluation_interval: 15s

# Alerting rules for AI pipeline monitoring
# See prometheus_rules.yml for rule definitions and severity documentation
rule_files:
  - 'prometheus_rules.yml'
  - 'prometheus-rules.yml'
  - 'alerting-rules.yml'

# Alertmanager configuration for alert delivery
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - alertmanager:9093
      timeout: 10s
      api_version: v2

scrape_configs:
  # ==========================================================================
  # Direct Native Prometheus Metrics Scraping (Preferred)
  # ==========================================================================
  # Scrapes the native Prometheus metrics endpoint directly.
  # This is the recommended approach as it:
  # - Preserves native histogram buckets for accurate percentile calculations
  # - Eliminates the JSON exporter as an intermediate failure point
  # - Reduces latency in metrics collection
  # - Properly types all metrics (counters, gauges, histograms)
  - job_name: 'hsi-backend-metrics'
    metrics_path: /api/metrics
    scrape_interval: 15s
    static_configs:
      - targets:
          - 'backend:8000'
    # Relabel to add service identification
    relabel_configs:
      - target_label: service
        replacement: 'home-security-intelligence'

  # ==========================================================================
  # JSON Exporter Scraped Endpoints (For non-Prometheus format data)
  # ==========================================================================
  # These endpoints return JSON data that needs conversion to Prometheus format.
  # Used for health checks, telemetry summaries, and stats that don't have
  # native Prometheus equivalents.

  # Backend health metrics via JSON exporter
  - job_name: 'hsi-health'
    metrics_path: /probe
    scrape_interval: 10s
    params:
      module: [health]
    static_configs:
      - targets:
          - 'http://backend:8000/api/system/health'
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: json-exporter:7979

  # Backend telemetry metrics via JSON exporter
  - job_name: 'hsi-telemetry'
    metrics_path: /probe
    scrape_interval: 10s
    params:
      module: [telemetry]
    static_configs:
      - targets:
          - 'http://backend:8000/api/system/telemetry'
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: json-exporter:7979

  # Backend stats metrics via JSON exporter
  - job_name: 'hsi-stats'
    metrics_path: /probe
    scrape_interval: 30s
    params:
      module: [stats]
    static_configs:
      - targets:
          - 'http://backend:8000/api/system/stats'
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: json-exporter:7979

  # GPU stats via JSON exporter
  - job_name: 'hsi-gpu'
    metrics_path: /probe
    scrape_interval: 10s
    params:
      module: [gpu]
    static_configs:
      - targets:
          - 'http://backend:8000/api/system/gpu'
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: json-exporter:7979

  # Direct backend liveness check (for up/down status)
  # NOTE: /api/system/health/live was removed. Use /health instead.
  - job_name: 'backend-liveness'
    metrics_path: /health
    scrape_interval: 10s
    static_configs:
      - targets:
          - 'backend:8000'

  # Redis metrics via redis_exporter
  - job_name: 'redis'
    scrape_interval: 15s
    static_configs:
      - targets:
          - 'redis-exporter:9121'

  # Prometheus self-monitoring
  - job_name: 'prometheus'
    static_configs:
      - targets:
          - 'localhost:9090'

  # JSON exporter health
  - job_name: 'json-exporter'
    static_configs:
      - targets:
          - 'json-exporter:7979'

  # =============================================================================
  # Blackbox Exporter - Synthetic Monitoring (NEM-1637)
  # =============================================================================
  # External endpoint probing for availability, latency, and health validation
  # Access probe UI at http://blackbox-exporter:9115

  # Blackbox exporter self-monitoring
  - job_name: 'blackbox-exporter'
    static_configs:
      - targets:
          - 'blackbox-exporter:9115'

  # HTTP Health probes - validates JSON health response body
  - job_name: 'blackbox-http-health'
    metrics_path: /probe
    params:
      module: [http_health]
    scrape_interval: 15s
    scrape_timeout: 10s
    static_configs:
      - targets:
          - http://backend:8000/api/system/health
        labels:
          probe_type: health
          service: backend
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115

  # HTTP Readiness probes - stricter check for load balancing decisions
  - job_name: 'blackbox-http-ready'
    metrics_path: /probe
    params:
      module: [http_ready]
    scrape_interval: 15s
    scrape_timeout: 10s
    static_configs:
      - targets:
          - http://backend:8000/api/system/health/ready
        labels:
          probe_type: readiness
          service: backend
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115

  # HTTP Liveness probes - simple availability checks
  - job_name: 'blackbox-http-live'
    metrics_path: /probe
    params:
      module: [http_live]
    scrape_interval: 10s
    scrape_timeout: 5s
    static_configs:
      - targets:
          - http://backend:8000/health
          - http://frontend:8080
        labels:
          probe_type: liveness
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115
      # Extract service name from URL for labeling
      - source_labels: [__param_target]
        regex: 'http://([^:]+):.*'
        target_label: service
        replacement: '${1}'

  # HTTP 2xx probes - basic availability for AI services
  - job_name: 'blackbox-http-2xx'
    metrics_path: /probe
    params:
      module: [http_2xx]
    scrape_interval: 30s
    scrape_timeout: 5s
    static_configs:
      - targets:
          - http://ai-detector:8090/health
          - http://ai-llm:8091/health
          - http://ai-florence:8092/health
          - http://ai-clip:8093/health
          - http://ai-enrichment:8094/health
        labels:
          probe_type: availability
          service_type: ai
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115
      # Extract AI service name from URL
      - source_labels: [__param_target]
        regex: 'http://([^:]+):.*'
        target_label: ai_service
        replacement: '${1}'

  # TCP connectivity probes - database and cache connections
  - job_name: 'blackbox-tcp'
    metrics_path: /probe
    params:
      module: [tcp_connect]
    scrape_interval: 15s
    scrape_timeout: 5s
    static_configs:
      - targets:
          - postgres:5432
          - redis:6379
        labels:
          probe_type: tcp
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115
      # Extract service name from target
      - source_labels: [__param_target]
        regex: '([^:]+):.*'
        target_label: service
        replacement: '${1}'

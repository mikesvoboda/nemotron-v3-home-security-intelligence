# JSON Exporter configuration for Home Security Intelligence
# Converts JSON API responses to Prometheus metrics
#
# Note: For string-to-number mapping, we use type: object with values: mapping.
# type: value only works with numeric JSON values.

modules:
  # System health metrics
  health:
    metrics:
      - name: hsi_system_healthy
        path: '{ .status }'
        type: object
        help: 'System health status (1=healthy, 0=unhealthy)'
        values:
          healthy: 1
          degraded: 0.5
          unhealthy: 0

      - name: hsi_database_healthy
        path: '{ .services.database.status }'
        type: object
        help: 'Database health status'
        values:
          healthy: 1
          unhealthy: 0

      - name: hsi_redis_healthy
        path: '{ .services.redis.status }'
        type: object
        help: 'Redis health status'
        values:
          healthy: 1
          unhealthy: 0

      - name: hsi_ai_healthy
        path: '{ .services.ai.status }'
        type: object
        help: 'AI services health status'
        values:
          healthy: 1
          unhealthy: 0

  # Pipeline telemetry metrics
  telemetry:
    metrics:
      # Queue depths
      - name: hsi_detection_queue_depth
        path: '{ .queues.detection_queue }'
        type: value
        help: 'Number of items in detection queue'

      - name: hsi_analysis_queue_depth
        path: '{ .queues.analysis_queue }'
        type: value
        help: 'Number of batches in analysis queue'

      # Note: Watch stage metrics removed - watch stage not currently active.
      # Re-add when file watcher latency tracking is enabled.

      # Detect stage latencies
      - name: hsi_detect_latency_avg_ms
        path: '{ .latencies.detect.avg_ms }'
        type: value
        help: 'Detect stage average latency in milliseconds'

      - name: hsi_detect_latency_p95_ms
        path: '{ .latencies.detect.p95_ms }'
        type: value
        help: 'Detect stage P95 latency in milliseconds'

      - name: hsi_detect_latency_p99_ms
        path: '{ .latencies.detect.p99_ms }'
        type: value
        help: 'Detect stage P99 latency in milliseconds'

      # Batch stage latencies
      - name: hsi_batch_latency_avg_ms
        path: '{ .latencies.batch.avg_ms }'
        type: value
        help: 'Batch stage average latency in milliseconds'

      - name: hsi_batch_latency_p95_ms
        path: '{ .latencies.batch.p95_ms }'
        type: value
        help: 'Batch stage P95 latency in milliseconds'

      - name: hsi_batch_latency_p99_ms
        path: '{ .latencies.batch.p99_ms }'
        type: value
        help: 'Batch stage P99 latency in milliseconds'

      # Analyze stage latencies
      # Note: Backend now returns zero values when no data is available (NEM-3904),
      # so default_value is no longer strictly needed. Kept as defense-in-depth.
      - name: hsi_analyze_latency_avg_ms
        path: '{ .latencies.analyze.avg_ms }'
        type: value
        help: 'Analyze stage average latency in milliseconds'
        default_value: 0

      - name: hsi_analyze_latency_p95_ms
        path: '{ .latencies.analyze.p95_ms }'
        type: value
        help: 'Analyze stage P95 latency in milliseconds'
        default_value: 0

      - name: hsi_analyze_latency_p99_ms
        path: '{ .latencies.analyze.p99_ms }'
        type: value
        help: 'Analyze stage P99 latency in milliseconds'
        default_value: 0

  # System statistics
  stats:
    metrics:
      - name: hsi_total_cameras
        path: '{ .total_cameras }'
        type: value
        help: 'Total number of cameras'

      - name: hsi_total_events
        path: '{ .total_events }'
        type: value
        help: 'Total number of events'

      - name: hsi_total_detections
        path: '{ .total_detections }'
        type: value
        help: 'Total number of detections'

      - name: hsi_uptime_seconds
        path: '{ .uptime_seconds }'
        type: value
        help: 'Application uptime in seconds'

  # GPU statistics
  gpu:
    metrics:
      - name: hsi_gpu_utilization
        path: '{ .utilization }'
        type: value
        help: 'GPU utilization percentage'

      - name: hsi_gpu_memory_used_mb
        path: '{ .memory_used }'
        type: value
        help: 'GPU memory used in MB'

      - name: hsi_gpu_memory_total_mb
        path: '{ .memory_total }'
        type: value
        help: 'Total GPU memory in MB'

      - name: hsi_gpu_temperature
        path: '{ .temperature }'
        type: value
        help: 'GPU temperature in Celsius'

      - name: hsi_inference_fps
        path: '{ .inference_fps }'
        type: value
        help: 'Inference frames per second'

      # Extended metrics for throttling detection and hardware health
      - name: hsi_gpu_fan_speed
        path: '{ .fan_speed }'
        type: value
        help: 'GPU fan speed percentage (0-100)'

      - name: hsi_gpu_sm_clock_mhz
        path: '{ .sm_clock }'
        type: value
        help: 'Current SM clock frequency in MHz'

      - name: hsi_gpu_memory_bandwidth_utilization
        path: '{ .memory_bandwidth_utilization }'
        type: value
        help: 'Memory controller utilization percentage (0-100)'

      - name: hsi_gpu_pstate
        path: '{ .pstate }'
        type: value
        help: 'GPU performance state (P0=max, P15=idle)'

      # High-value metrics for throttling and error detection
      - name: hsi_gpu_throttle_reasons
        path: '{ .throttle_reasons }'
        type: value
        help: 'GPU throttle reasons bitfield (0=none)'

      - name: hsi_gpu_power_limit_watts
        path: '{ .power_limit }'
        type: value
        help: 'GPU power limit in watts'

      - name: hsi_gpu_sm_clock_max_mhz
        path: '{ .sm_clock_max }'
        type: value
        help: 'Maximum SM clock frequency in MHz'

      - name: hsi_gpu_compute_processes
        path: '{ .compute_processes_count }'
        type: value
        help: 'Number of active GPU compute processes'

      - name: hsi_gpu_pcie_replay_counter
        path: '{ .pcie_replay_counter }'
        type: value
        help: 'PCIe replay counter (error indicator, should be low)'

      - name: hsi_gpu_temp_slowdown_threshold
        path: '{ .temp_slowdown_threshold }'
        type: value
        help: 'Temperature threshold for GPU slowdown in Celsius'

      # Medium-value metrics for hardware monitoring
      - name: hsi_gpu_memory_clock_mhz
        path: '{ .memory_clock }'
        type: value
        help: 'Current memory clock frequency in MHz'

      - name: hsi_gpu_memory_clock_max_mhz
        path: '{ .memory_clock_max }'
        type: value
        help: 'Maximum memory clock frequency in MHz'

      - name: hsi_gpu_pcie_link_gen
        path: '{ .pcie_link_gen }'
        type: value
        help: 'PCIe link generation (1-4)'

      - name: hsi_gpu_pcie_link_width
        path: '{ .pcie_link_width }'
        type: value
        help: 'PCIe link width (1, 2, 4, 8, 16)'

      - name: hsi_gpu_pcie_tx_throughput_kbs
        path: '{ .pcie_tx_throughput }'
        type: value
        help: 'PCIe TX throughput in KB/s'

      - name: hsi_gpu_pcie_rx_throughput_kbs
        path: '{ .pcie_rx_throughput }'
        type: value
        help: 'PCIe RX throughput in KB/s'

      - name: hsi_gpu_encoder_utilization
        path: '{ .encoder_utilization }'
        type: value
        help: 'Video encoder utilization percentage (0-100)'

      - name: hsi_gpu_decoder_utilization
        path: '{ .decoder_utilization }'
        type: value
        help: 'Video decoder utilization percentage (0-100)'

      - name: hsi_gpu_bar1_used_mb
        path: '{ .bar1_used }'
        type: value
        help: 'BAR1 memory used in MB'

; PgBouncer Configuration for Home Security Intelligence
; NEM-3419: Add PgBouncer for connection multiplexing
;
; Pool Mode: Transaction
;   - Connections are returned to pool after each transaction
;   - IMPORTANT: Requires disabling prepared statements in SQLAlchemy
;
; Reference: https://www.pgbouncer.org/config.html

[databases]
; Database connection to PostgreSQL
; Variables are interpolated from environment in the entrypoint script
*= host=${POSTGRES_HOST:-postgres} port=${POSTGRES_PORT:-5432}

[pgbouncer]
; Connection settings
listen_addr = 0.0.0.0
listen_port = 6432
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt
admin_users = pgbouncer
stats_users = pgbouncer

; Pool settings - transaction mode for best multiplexing
pool_mode = transaction
max_client_conn = 1000
default_pool_size = 25
min_pool_size = 5
reserve_pool_size = 5
reserve_pool_timeout = 5
max_db_connections = 50
max_user_connections = 50

; Timeouts
server_connect_timeout = 15
server_login_retry = 15
server_idle_timeout = 600
query_timeout = 0
query_wait_timeout = 120
client_idle_timeout = 0
client_login_timeout = 60
server_lifetime = 3600

; Logging
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1
log_stats = 1
stats_period = 60

; TCP settings
tcp_keepalive = 1
tcp_keepidle = 300
tcp_keepintvl = 75
tcp_keepcnt = 9

; DNS settings
dns_max_ttl = 60
dns_zone_check_period = 0
dns_nxdomain_ttl = 0

; Security
ignore_startup_parameters = extra_float_digits
application_name_add_host = 1

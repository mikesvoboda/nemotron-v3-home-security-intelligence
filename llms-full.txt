# Home Security Intelligence - Complete Deployment Guide

> AI-powered home security monitoring. Self-hosted, privacy-first. Fully containerized with GPU passthrough.

## Overview

Home Security Intelligence watches IP camera FTP uploads, runs RT-DETRv2 object detection, and uses Nemotron LLM to analyze detections and assign risk scores (0-100). Everything displays on a real-time React dashboard.

**Architecture:**

```
Cameras (FTP) --> FileWatcher --> RT-DETRv2 --> Batch Aggregator --> Nemotron --> Dashboard
     |                              (GPU)                            (GPU)           |
     v                                                                               v
/export/foscam/{camera}/     Detection Queue --> Analysis Queue        WebSocket events
```

**Stack:**

- Frontend: React + TypeScript + Tailwind + Tremor (nginx in container)
- Backend: Python FastAPI + PostgreSQL + Redis
- AI: RT-DETRv2 (detection) + Nemotron via llama.cpp (risk reasoning)
- Containers: Podman/Docker with NVIDIA GPU passthrough (CDI)

## Requirements

### Hardware

| Component | Minimum | Recommended |
|-----------|---------|-------------|
| GPU | NVIDIA 16GB VRAM | RTX A5500 24GB |
| RAM | 16GB | 32GB |
| Storage | 50GB | 100GB+ |
| CPU | 4 cores | 8+ cores |

**Tested GPUs:** RTX 3090, RTX 4090, RTX A4000, RTX A5500

### Software

- Linux (Ubuntu 22.04+, Fedora 38+)
- Podman 4.0+ with podman-compose, OR Docker 20.10+ with Docker Compose
- nvidia-container-toolkit (for GPU passthrough)
- CUDA 12.0+ drivers

## Quick Start (5 Minutes)

```bash
# 1. Clone
git clone https://github.com/mikesvoboda/nemotron-v3-home-security-intelligence.git
cd nemotron-v3-home-security-intelligence

# 2. Verify GPU passthrough is available
nvidia-smi
podman run --rm --device nvidia.com/gpu=all nvidia/cuda:12.4-base nvidia-smi

# 3. Create camera directory (or use existing)
mkdir -p /tmp/cameras/demo_camera
export CAMERA_PATH=/tmp/cameras

# 4. Start all services
podman-compose -f docker-compose.prod.yml up -d

# 5. Wait for health (~2-3 minutes for AI model loading)
watch -n 5 'podman ps --format "table {{.Names}}\t{{.Status}}"'

# 6. Verify
curl http://localhost:8000/api/system/health/ready
```

**Access Points:**

| Service | URL |
|---------|-----|
| Dashboard | http://localhost:5173 |
| API | http://localhost:8000 |
| API Docs | http://localhost:8000/docs |

## Services & Ports

| Service | Port | Container | GPU | Description |
|---------|------|-----------|-----|-------------|
| Frontend | 5173 | frontend | No | React dashboard (nginx) |
| Backend | 8000 | backend | No | FastAPI REST + WebSocket |
| PostgreSQL | 5432 | postgres | No | Event/detection storage |
| Redis | 6379 | redis | No | Queues and pub/sub |
| RT-DETRv2 | 8090 | ai-detector | Yes | Object detection (~650MB VRAM) |
| Nemotron | 8091 | ai-llm | Yes | Risk analysis LLM (~21.6GB VRAM) |

## Configuration

### Environment Variables

Create `.env` in project root (optional - defaults work for most setups):

```bash
# Database (defaults are fine for local use)
POSTGRES_USER=security
POSTGRES_PASSWORD=security_dev_password
POSTGRES_DB=security

# Camera path (where cameras FTP images)
CAMERA_PATH=/export/foscam

# AI model configuration
GPU_LAYERS=45              # Layers on GPU (max 53 for Nemotron)
CTX_SIZE=8192              # Context window size
RTDETR_CONFIDENCE=0.5      # Detection confidence threshold

# Ports (change if conflicts)
FRONTEND_PORT=5173
```

### GPU Memory Usage

With default settings (45 GPU layers, 8K context):

| Service | VRAM Usage |
|---------|------------|
| RT-DETRv2 | ~650 MB |
| Nemotron | ~21.6 GB |
| **Total** | ~22.3 GB |

**For 16GB GPU**, reduce settings:

```bash
# In docker-compose.prod.yml or .env
GPU_LAYERS=30    # Offload fewer layers
CTX_SIZE=4096    # Smaller context window
```

## Camera Setup

### Directory Structure

Cameras FTP images to subdirectories named by camera:

```
/export/foscam/
├── front_door/
│   ├── 20250115_143022.jpg
│   └── ...
├── backyard/
│   └── ...
└── garage/
    └── ...
```

### Generic IP Camera Setup

1. Configure camera to upload via FTP on motion detection
2. Set FTP destination to your server
3. Use camera name as subdirectory
4. Set `CAMERA_PATH` environment variable

### Foscam Configuration

In Foscam Web UI:

1. **Settings > Network > FTP**
   - Server: your server IP
   - Upload Path: `/front_door` (camera location)

2. **Settings > Alarm > Motion Detection**
   - Enable motion detection
   - Check "FTP Upload"
   - Set interval: 1-2 seconds

## Commands Reference

### Start/Stop

```bash
# Start all services
podman-compose -f docker-compose.prod.yml up -d

# Stop all services
podman-compose -f docker-compose.prod.yml down

# Restart single service
podman-compose -f docker-compose.prod.yml restart backend

# View logs
podman-compose -f docker-compose.prod.yml logs -f backend
podman-compose -f docker-compose.prod.yml logs -f ai-llm
```

### Health Checks

```bash
# All services status
podman ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

# Backend health
curl http://localhost:8000/api/system/health/ready

# GPU memory
nvidia-smi

# Check cameras detected
curl http://localhost:8000/api/cameras

# Check recent events
curl http://localhost:8000/api/events?limit=5
```

### Debugging

```bash
# Enter container shell
podman exec -it nemotron-v3-home-security-intelligence_backend_1 /bin/sh

# Check AI detector
curl http://localhost:8090/health

# Check Nemotron LLM
curl http://localhost:8091/health

# Database access
podman exec -it nemotron-v3-home-security-intelligence_postgres_1 psql -U security -d security
```

### Data Management

```bash
# Reset database (WARNING: deletes all data)
podman-compose -f docker-compose.prod.yml down -v
podman-compose -f docker-compose.prod.yml up -d

# Backup database
podman exec nemotron-v3-home-security-intelligence_postgres_1 pg_dump -U security security > backup.sql

# View disk usage
podman system df
```

## Troubleshooting

### Container Won't Start

**Port in use:**
```bash
# Find what's using the port
ss -tlnp | grep 8000

# Kill process or change port in docker-compose.prod.yml
```

**GPU not available:**
```bash
# Verify nvidia-container-toolkit
nvidia-container-cli info

# Test GPU passthrough
podman run --rm --device nvidia.com/gpu=all nvidia/cuda:12.4-base nvidia-smi

# If fails, reinstall nvidia-container-toolkit
```

**Permission denied on camera path:**
```bash
chmod -R 755 /export/foscam
# Or use a writable temp path
export CAMERA_PATH=/tmp/cameras
```

### AI Services Issues

**Out of VRAM:**
```bash
# Check current usage
nvidia-smi

# Reduce GPU layers in docker-compose.prod.yml
GPU_LAYERS=30  # Instead of 45

# Restart AI container
podman-compose -f docker-compose.prod.yml restart ai-llm
```

**Slow inference:**
- Check if model is loaded: `curl http://localhost:8091/health`
- First inference after start is slow (model loading)
- Verify GPU layers: more layers = faster but more VRAM

### Backend Can't Connect to AI

```bash
# Test from host
curl http://localhost:8090/health
curl http://localhost:8091/health

# Check container network
podman network inspect nemotron-v3-home-security-intelligence_security-net
```

### Frontend Shows Blank Page

```bash
# Check frontend container
podman logs nemotron-v3-home-security-intelligence_frontend_1

# Verify nginx config
podman exec nemotron-v3-home-security-intelligence_frontend_1 cat /etc/nginx/conf.d/default.conf
```

## Expected Startup Times

| Service | Time to Healthy |
|---------|----------------|
| PostgreSQL | ~10 seconds |
| Redis | ~5 seconds |
| Backend | ~30 seconds |
| Frontend | ~10 seconds |
| RT-DETRv2 | ~60 seconds (model download on first run) |
| Nemotron | ~120 seconds (model loading) |

**Total cold start:** ~3 minutes

## Systemd Integration (Linux)

Run containers as systemd services for automatic startup on boot.

### Generate Systemd Units (Podman)

```bash
# Create systemd user directory
mkdir -p ~/.config/systemd/user

# Generate systemd units for all containers
cd ~/github/nemotron-v3-home-security-intelligence
for container in $(podman ps --format "{{.Names}}"); do
    podman generate systemd --new --name "$container" > ~/.config/systemd/user/"$container".service
done

# Reload systemd
systemctl --user daemon-reload

# Enable services to start on boot
for container in $(podman ps --format "{{.Names}}"); do
    systemctl --user enable "$container".service
done

# Enable lingering (allows user services to run without login)
loginctl enable-linger $USER
```

### Quick Setup Script

```bash
#!/bin/bash
# save as: setup-systemd.sh

set -e

# Ensure containers are running first
podman-compose -f docker-compose.prod.yml up -d

# Wait for containers to be healthy
sleep 30

# Create systemd directory
mkdir -p ~/.config/systemd/user

# Generate and enable services
for container in $(podman ps --format "{{.Names}}" | grep nemotron-v3); do
    echo "Creating service for: $container"
    podman generate systemd --new --name "$container" > ~/.config/systemd/user/"$container".service
    systemctl --user enable "$container".service
done

systemctl --user daemon-reload
loginctl enable-linger $USER

echo "Systemd services created and enabled!"
echo "Services will start automatically on boot."
```

### Manage Services

```bash
# Check service status
systemctl --user status nemotron-v3-home-security-intelligence_backend_1

# Start/stop individual services
systemctl --user start nemotron-v3-home-security-intelligence_backend_1
systemctl --user stop nemotron-v3-home-security-intelligence_backend_1

# View logs via journalctl
journalctl --user -u nemotron-v3-home-security-intelligence_backend_1 -f

# Disable auto-start
systemctl --user disable nemotron-v3-home-security-intelligence_backend_1
```

### Alternative: Podman Pod with Systemd

For simpler management, create a pod and generate a single service:

```bash
# Create pod from compose
podman-compose -f docker-compose.prod.yml up -d

# Generate pod service (manages all containers together)
podman generate systemd --new --name nemotron-v3-home-security-intelligence_default > \
    ~/.config/systemd/user/home-security.service

systemctl --user daemon-reload
systemctl --user enable home-security.service
```

## Upgrading

```bash
# Pull latest code
git pull origin main

# Stop services (if using systemd)
systemctl --user stop 'nemotron-v3-home-security-intelligence_*'

# Rebuild containers
podman-compose -f docker-compose.prod.yml build

# Restart
podman-compose -f docker-compose.prod.yml up -d

# Regenerate systemd units (if container names changed)
# Re-run the setup script above
```

## Project Structure

```
nemotron-v3-home-security-intelligence/
├── docker-compose.prod.yml   # Main deployment file
├── backend/                  # FastAPI backend
│   ├── Dockerfile.prod
│   ├── api/routes/          # REST endpoints
│   ├── services/            # AI pipeline, file watcher
│   └── models/              # SQLAlchemy models
├── frontend/                 # React frontend
│   ├── Dockerfile.prod
│   ├── nginx.conf           # Reverse proxy config
│   └── src/
├── ai/
│   ├── rtdetr/              # RT-DETRv2 detector
│   │   └── Dockerfile
│   └── nemotron/            # Nemotron LLM server
│       └── Dockerfile
└── docs/                     # Additional documentation
```

## API Quick Reference

```bash
# Health
GET /api/system/health
GET /api/system/health/ready

# Cameras
GET /api/cameras
GET /api/cameras/{id}

# Events
GET /api/events
GET /api/events/{id}
GET /api/events?limit=10&offset=0

# Detections
GET /api/detections
GET /api/detections/{id}

# WebSocket (real-time events)
ws://localhost:8000/ws/events
ws://localhost:8000/ws/system
```

## Support

- GitHub Issues: https://github.com/mikesvoboda/nemotron-v3-home-security-intelligence/issues
- CLAUDE.md: Development setup and contribution guide
- docs/ROADMAP.md: Future enhancements

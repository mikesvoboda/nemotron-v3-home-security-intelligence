# Alembic Database Migrations Guide

## Purpose

The `backend/alembic/` directory contains Alembic database migration infrastructure for managing schema changes in the PostgreSQL database. Alembic is SQLAlchemy's database migration tool.

## Directory Structure

```
backend/alembic/
├── AGENTS.md            # This file
├── env.py               # Migration environment configuration
├── README               # Alembic-generated readme
├── script.py.mako       # Template for new migrations
└── versions/            # Migration scripts (see versions/AGENTS.md)
    ├── 968b0dff6a9b_initial_schema.py
    ├── 20251228_add_fts_search_vector.py
    ├── add_alerts_and_alert_rules.py
    ├── add_zones_table.py
    ├── audit_logs_table.py
    ├── add_baseline_tables.py
    ├── add_clip_path_column.py
    ├── fix_datetime_timezone.py
    ├── fix_search_vector_backfill.py
    ├── add_llm_prompt_column.py
    ├── add_event_audits_table.py
    ├── add_camera_unique_constraints.py
    ├── add_enrichment_data_column.py
    ├── add_object_types_gin_trgm_index.py
    ├── add_prompt_versions_table.py
    └── d4cdaa821492_merge_heads.py
```

## Current Migration Chain

```
968b0dff6a9b (initial_schema)
       |
20251228_fts (add_fts_search_vector)
       |
add_alerts_rules (add_alerts_and_alert_rules)
       |
add_zones_001 (add_zones_table)
       |
add_audit_logs (audit_logs_table)
       |
add_baselines (add_baseline_tables)
       |
add_clip_path (add_clip_path_column)
       |
fix_datetime_tz (fix_datetime_timezone)
       |
fix_search_vector_backfill
       |
add_llm_prompt (add_llm_prompt_column)
       |
add_event_audits (add_event_audits_table)
       |
add_camera_unique_constraints
       |
add_enrichment_data (add_enrichment_data_column)
       |
       +-----> add_object_types_gin_trgm (add_object_types_gin_trgm_index)
       |                    |
       +-----> add_prompt_versions (add_prompt_versions_table)
                            |
                            +-----> d4cdaa821492 (merge_heads)
```

Note: The migration chain includes a merge point where `add_object_types_gin_trgm` and `add_prompt_versions` were merged into `d4cdaa821492`.

## Key Files

### `env.py` - Migration Environment

Configures Alembic to use the application's SQLAlchemy models and database connection:

**Key Functions:**

- `get_database_url()` - Resolves database URL from:

  1. `DATABASE_URL` environment variable (priority)
  2. `sqlalchemy.url` in alembic.ini
  3. Default fallback: `postgresql://security:password@localhost:5432/security`

- `run_migrations_offline()` - Generate SQL scripts without database connection
- `run_migrations_online()` - Apply migrations with live database connection

**Important Details:**

- Converts async URLs to sync for Alembic compatibility:
  - `postgresql+asyncpg://` -> `postgresql://`
- Only PostgreSQL is supported (no SQLite)
- Uses `NullPool` to avoid connection issues
- Imports `backend.models.camera.Base` for metadata

### `script.py.mako` - Migration Template

Mako template for generating new migration files. Includes:

- Revision ID and down_revision
- Timestamp in docstring
- Empty `upgrade()` and `downgrade()` functions

## Common Commands

**Create a new migration (autogenerate from model changes):**

```bash
cd backend
alembic revision --autogenerate -m "description of change"
```

**Create empty migration for manual changes:**

```bash
cd backend
alembic revision -m "description of change"
```

**Apply all pending migrations:**

```bash
alembic upgrade head
```

**Rollback one migration:**

```bash
alembic downgrade -1
```

**Show current revision:**

```bash
alembic current
```

**Show migration history:**

```bash
alembic history --verbose
```

**Generate SQL without applying:**

```bash
alembic upgrade head --sql > migration.sql
```

## Environment Variables

- `DATABASE_URL` - PostgreSQL connection string (overrides alembic.ini)

Example:

```bash
export DATABASE_URL=postgresql://security:password@localhost:5432/security
```

## Best Practices

1. **Always review autogenerated migrations** - Alembic may not capture:
   - Enum value changes
   - Index/constraint renames
   - Data migrations
   - PostgreSQL-specific features (JSONB, TSVECTOR, triggers)
2. **Test migrations both ways** - Verify both `upgrade()` and `downgrade()` work
3. **Use descriptive revision messages** - Makes history easier to understand
4. **Keep migrations small** - One logical change per migration
5. **Never modify applied migrations** - Create new migrations instead

## Integration with Application

The application uses SQLAlchemy 2.0 async patterns with asyncpg, while Alembic uses synchronous connections. The `env.py` handles this by:

1. Converting the async database URL to sync format
2. Using standard psycopg2 driver for migrations
3. Sharing the same model metadata (`Base.metadata`) as the application

## Related Documentation

- `versions/AGENTS.md` - Detailed migration file documentation
- `/backend/core/database.py` - Application database module
- `/backend/models/AGENTS.md` - SQLAlchemy model documentation
- `/backend/AGENTS.md` - Backend overview

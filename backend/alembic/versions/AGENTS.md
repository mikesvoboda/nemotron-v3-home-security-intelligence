# Alembic Migration Versions - Agent Guide

## Purpose

This directory contains PostgreSQL database migration scripts managed by Alembic. Each migration file represents a schema change that can be applied (upgrade) or reversed (downgrade).

**Note:** The schema has been consolidated. Older migrations have been squashed into the initial schema for cleaner history.

## Current Migration Files

```
backend/alembic/versions/
|-- e36700c35af6_initial_schema.py              # Comprehensive initial schema
|-- a1b2c3d4e5f6_add_household_organization_model.py  # Household organization support
|-- b2c3d4e5f6g7_add_property_and_area_models.py      # Property and area models
|-- f1231ed7e32d_rename_zones_to_camera_zones.py      # Zone table rename
```

## Migration Details

### `e36700c35af6_initial_schema.py` - Initial Schema

**Revision ID:** `e36700c35af6`
**Parent:** None (first migration)

Creates the comprehensive foundational schema including:

| Table                          | Purpose                                      |
| ------------------------------ | -------------------------------------------- |
| `cameras`                      | Camera definitions and status                |
| `camera_zones`                 | Geographic regions per camera                |
| `detections`                   | Individual object detections                 |
| `events`                       | Aggregated security events with LLM analysis |
| `event_detections`             | Junction table for Event-Detection M2M       |
| `event_audits`                 | AI pipeline performance tracking             |
| `event_feedback`               | User feedback on security events             |
| `alerts`                       | Triggered alerts with delivery status        |
| `alert_rules`                  | Alert rule definitions with conditions       |
| `entities`                     | Entity tracking for re-identification        |
| `audit_logs`                   | Security-sensitive action tracking           |
| `activity_baselines`           | Per-camera activity rate by hour/day         |
| `class_baselines`              | Detection class frequency by hour            |
| `gpu_stats`                    | GPU metrics history                          |
| `logs`                         | Application log storage                      |
| `jobs`                         | Background job tracking                      |
| `job_attempts`                 | Job execution attempts                       |
| `job_logs`                     | Job log entries                              |
| `job_transitions`              | Job state transitions                        |
| `export_jobs`                  | Export job persistence                       |
| `prompt_configs`               | Current AI prompt configuration              |
| `prompt_versions`              | AI prompt version history                    |
| `notification_preferences`     | Global notification settings                 |
| `camera_notification_settings` | Per-camera notification settings             |
| `quiet_hours_periods`          | Notification quiet hours                     |
| `user_calibration`             | Personalized risk thresholds                 |
| `scene_changes`                | Scene change detection                       |
| `summaries`                    | Dashboard summaries                          |

Includes PostgreSQL-specific features:

- JSONB columns for flexible data
- TSVECTOR for full-text search
- GIN indexes for efficient JSONB/text queries
- BRIN indexes for time-series data
- Trigram indexes for LIKE queries
- Check constraints for data integrity

### `a1b2c3d4e5f6_add_household_organization_model.py`

**Revision ID:** `a1b2c3d4e5f6`
**Parent:** `e36700c35af6`

Adds household and organization models for multi-tenant support:

| Table               | Purpose                        |
| ------------------- | ------------------------------ |
| `households`        | Household definitions          |
| `household_members` | Household organization/members |

### `b2c3d4e5f6g7_add_property_and_area_models.py`

**Revision ID:** `b2c3d4e5f6g7`
**Parent:** `a1b2c3d4e5f6`

Adds property and area models for multi-site support:

| Table        | Purpose                          |
| ------------ | -------------------------------- |
| `properties` | Property/location definitions    |
| `areas`      | Area/region coverage definitions |

### `f1231ed7e32d_rename_zones_to_camera_zones.py`

**Revision ID:** `f1231ed7e32d`
**Parent:** `b2c3d4e5f6g7`

Renames `zones` table to `camera_zones` for clarity and consistency with the `CameraZone` model

## Creating New Migrations

### 1. Autogenerate from model changes

```bash
cd backend
alembic revision --autogenerate -m "description of change"
```

**Always review autogenerated migrations** - Alembic may not detect:

- Enum value changes
- Index/constraint renames
- Data migrations
- PostgreSQL-specific features (JSONB, TSVECTOR, triggers)

### 2. Empty migration for manual changes

```bash
cd backend
alembic revision -m "description of change"
```

Use for:

- Custom SQL (triggers, functions)
- Data migrations
- PostgreSQL extensions

### 3. Migration structure

```python
"""Description of migration

Revision ID: unique_id
Revises: parent_id
Create Date: timestamp
"""

from collections.abc import Sequence

import sqlalchemy as sa
from alembic import op

revision: str = "unique_id"
down_revision: str | Sequence[str] | None = "parent_id"
branch_labels: str | Sequence[str] | None = None
depends_on: str | Sequence[str] | None = None


def upgrade() -> None:
    """Apply schema changes."""
    pass


def downgrade() -> None:
    """Reverse schema changes."""
    pass
```

## Migration Patterns

### Creating ENUM types

```python
def upgrade():
    op.execute("CREATE TYPE status_enum AS ENUM ('active', 'inactive')")
    # Then use in column definition

def downgrade():
    op.drop_table("table_using_enum")
    op.execute("DROP TYPE IF EXISTS status_enum")
```

### Adding PostgreSQL triggers

```python
def upgrade():
    op.execute("""
        CREATE OR REPLACE FUNCTION my_trigger_func() RETURNS trigger AS $$
        BEGIN
            -- trigger logic
            RETURN NEW;
        END
        $$ LANGUAGE plpgsql;
    """)
    op.execute("""
        CREATE TRIGGER my_trigger
        BEFORE INSERT OR UPDATE ON my_table
        FOR EACH ROW EXECUTE FUNCTION my_trigger_func();
    """)

def downgrade():
    op.execute("DROP TRIGGER IF EXISTS my_trigger ON my_table")
    op.execute("DROP FUNCTION IF EXISTS my_trigger_func()")
```

### Adding GIN indexes for JSONB/TSVECTOR

```python
op.create_index(
    "idx_name",
    "table",
    ["column"],
    unique=False,
    postgresql_using="gin",
)
```

## Common Commands

```bash
# Apply all pending migrations
alembic upgrade head

# Rollback one migration
alembic downgrade -1

# Rollback to specific revision
alembic downgrade 968b0dff6a9b

# Show current revision
alembic current

# Show migration history
alembic history --verbose

# Generate SQL without applying
alembic upgrade head --sql > migration.sql
```

## Best Practices

1. **Test both directions** - Always verify `upgrade()` and `downgrade()` work
2. **One change per migration** - Keep migrations focused and atomic
3. **Never modify applied migrations** - Create new migrations for fixes
4. **Include data migrations** - Backfill data when adding non-nullable columns
5. **Drop indexes before columns** - Required for proper downgrade order
6. **Drop constraints before tables** - Foreign keys must be dropped first

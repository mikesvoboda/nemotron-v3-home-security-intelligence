# Alembic Migration Versions - Agent Guide

## Purpose

This directory contains PostgreSQL database migration scripts managed by Alembic. Each migration file represents a schema change that can be applied (upgrade) or reversed (downgrade).

## Migration Chain

Migrations form a linear chain. Each migration's `down_revision` points to its parent:

```
968b0dff6a9b (initial_schema)
       |
20251228_fts (add_fts_search_vector)
       |
add_alerts_rules (add_alerts_and_alert_rules)
       |
add_zones_001 (add_zones_table)
       |
add_audit_logs (audit_logs_table)
       |
add_baselines (add_baseline_tables)
```

## Migration Files

### `968b0dff6a9b_initial_schema.py`

**Revision ID:** `968b0dff6a9b`
**Parent:** None (first migration)

Creates the foundational tables:

| Table        | Purpose                            |
| ------------ | ---------------------------------- |
| `api_keys`   | API key storage with SHA256 hashes |
| `cameras`    | Camera definitions and status      |
| `gpu_stats`  | GPU metrics history                |
| `logs`       | Application log storage            |
| `detections` | Individual object detections       |
| `events`     | Aggregated security events         |

Key indexes: `idx_detections_camera_time`, `idx_events_started_at`, `idx_logs_timestamp`

### `20251228_add_fts_search_vector.py`

**Revision ID:** `20251228_fts`
**Parent:** `968b0dff6a9b`

Adds full-text search to events:

- `object_types` column (cached detection classes)
- `search_vector` TSVECTOR column
- `events_search_vector_update()` trigger function
- GIN index on `search_vector` for fast searches
- Backfills existing events with search vectors

### `add_alerts_and_alert_rules.py`

**Revision ID:** `add_alerts_rules`
**Parent:** `20251228_fts`

Creates the alerting system:

| Table         | Purpose                                |
| ------------- | -------------------------------------- |
| `alert_rules` | Alert rule definitions with conditions |
| `alerts`      | Triggered alerts with delivery status  |

PostgreSQL ENUM types created:

- `alert_severity`: low, medium, high, critical
- `alert_status`: pending, delivered, acknowledged, dismissed

### `add_zones_table.py`

**Revision ID:** `add_zones_001`
**Parent:** `add_alerts_rules`

Adds camera zone definitions:

| Table   | Purpose                       |
| ------- | ----------------------------- |
| `zones` | Geographic regions per camera |

PostgreSQL ENUM types created:

- `zone_type_enum`: entry_point, driveway, sidewalk, yard, other
- `zone_shape_enum`: rectangle, polygon

Columns: `id`, `camera_id`, `name`, `zone_type`, `coordinates` (JSONB), `shape`, `color`, `enabled`, `priority`, timestamps

### `audit_logs_table.py`

**Revision ID:** `add_audit_logs`
**Parent:** `add_zones_001`

Creates audit logging for security:

| Table        | Purpose                            |
| ------------ | ---------------------------------- |
| `audit_logs` | Security-sensitive action tracking |

Columns: `timestamp`, `action`, `resource_type`, `resource_id`, `actor`, `ip_address`, `user_agent`, `details` (JSON), `status`

### `add_baseline_tables.py`

**Revision ID:** `add_baselines`
**Parent:** `add_audit_logs`

Creates baseline tables for anomaly detection:

| Table                | Purpose                              |
| -------------------- | ------------------------------------ |
| `activity_baselines` | Per-camera activity rate by hour/day |
| `class_baselines`    | Detection class frequency by hour    |

These tables support anomaly detection by comparing current detections against historical patterns with exponential decay.

## Creating New Migrations

### 1. Autogenerate from model changes

```bash
cd backend
alembic revision --autogenerate -m "description of change"
```

**Always review autogenerated migrations** - Alembic may not detect:

- Enum value changes
- Index/constraint renames
- Data migrations
- PostgreSQL-specific features (JSONB, TSVECTOR, triggers)

### 2. Empty migration for manual changes

```bash
cd backend
alembic revision -m "description of change"
```

Use for:

- Custom SQL (triggers, functions)
- Data migrations
- PostgreSQL extensions

### 3. Migration structure

```python
"""Description of migration

Revision ID: unique_id
Revises: parent_id
Create Date: timestamp
"""

from collections.abc import Sequence

import sqlalchemy as sa
from alembic import op

revision: str = "unique_id"
down_revision: str | Sequence[str] | None = "parent_id"
branch_labels: str | Sequence[str] | None = None
depends_on: str | Sequence[str] | None = None


def upgrade() -> None:
    """Apply schema changes."""
    pass


def downgrade() -> None:
    """Reverse schema changes."""
    pass
```

## Migration Patterns

### Creating ENUM types

```python
def upgrade():
    op.execute("CREATE TYPE status_enum AS ENUM ('active', 'inactive')")
    # Then use in column definition

def downgrade():
    op.drop_table("table_using_enum")
    op.execute("DROP TYPE IF EXISTS status_enum")
```

### Adding PostgreSQL triggers

```python
def upgrade():
    op.execute("""
        CREATE OR REPLACE FUNCTION my_trigger_func() RETURNS trigger AS $$
        BEGIN
            -- trigger logic
            RETURN NEW;
        END
        $$ LANGUAGE plpgsql;
    """)
    op.execute("""
        CREATE TRIGGER my_trigger
        BEFORE INSERT OR UPDATE ON my_table
        FOR EACH ROW EXECUTE FUNCTION my_trigger_func();
    """)

def downgrade():
    op.execute("DROP TRIGGER IF EXISTS my_trigger ON my_table")
    op.execute("DROP FUNCTION IF EXISTS my_trigger_func()")
```

### Adding GIN indexes for JSONB/TSVECTOR

```python
op.create_index(
    "idx_name",
    "table",
    ["column"],
    unique=False,
    postgresql_using="gin",
)
```

## Common Commands

```bash
# Apply all pending migrations
alembic upgrade head

# Rollback one migration
alembic downgrade -1

# Rollback to specific revision
alembic downgrade 968b0dff6a9b

# Show current revision
alembic current

# Show migration history
alembic history --verbose

# Generate SQL without applying
alembic upgrade head --sql > migration.sql
```

## Best Practices

1. **Test both directions** - Always verify `upgrade()` and `downgrade()` work
2. **One change per migration** - Keep migrations focused and atomic
3. **Never modify applied migrations** - Create new migrations for fixes
4. **Include data migrations** - Backfill data when adding non-nullable columns
5. **Drop indexes before columns** - Required for proper downgrade order
6. **Drop constraints before tables** - Foreign keys must be dropped first

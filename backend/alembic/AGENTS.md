# Alembic Database Migrations Guide

## Purpose

The `backend/alembic/` directory contains Alembic database migration infrastructure for managing schema changes in the PostgreSQL database. Alembic is SQLAlchemy's database migration tool.

## Directory Structure

```
backend/alembic/
├── AGENTS.md            # This file
├── env.py               # Migration environment configuration
├── helpers.py           # Migration helper utilities
├── README               # Alembic-generated readme
├── script.py.mako       # Template for new migrations
└── versions/            # 4 migration scripts (see versions/AGENTS.md)
```

## Current Migration Chain

The migrations have been consolidated into a clean schema. Current migration chain:

1. **`e36700c35af6_initial_schema.py`** - Comprehensive initial schema

   - All core tables (cameras, detections, events, alerts, zones, etc.)
   - Full-text search with TSVECTOR and GIN indexes
   - BRIN indexes for time-series data
   - All constraints and check constraints
   - Background job infrastructure

2. **`a1b2c3d4e5f6_add_household_organization_model.py`** - Household support

   - Households and household members tables
   - Multi-tenant organization support

3. **`b2c3d4e5f6g7_add_property_and_area_models.py`** - Property/Area models

   - Properties table for multi-site support
   - Areas table for logical zone groupings

4. **`f1231ed7e32d_rename_zones_to_camera_zones.py`** - Rename zones
   - Renames `zones` table to `camera_zones` for clarity

See `versions/AGENTS.md` for detailed documentation of individual migrations.

## Key Files

### `env.py` - Migration Environment

Configures Alembic to use the application's SQLAlchemy models and database connection:

**Key Functions:**

- `get_database_url()` - Resolves database URL from:

  1. `DATABASE_URL` environment variable (priority)
  2. `sqlalchemy.url` in alembic.ini
  3. Default fallback: `postgresql://security:password@localhost:5432/security`

- `run_migrations_offline()` - Generate SQL scripts without database connection
- `run_migrations_online()` - Apply migrations with live database connection

**Important Details:**

- Converts async URLs to sync for Alembic compatibility (e.g., async driver scheme to sync driver scheme)
- Only PostgreSQL is supported (no SQLite)
- Uses `NullPool` to avoid connection issues
- Imports `backend.models.camera.Base` for metadata

### `helpers.py` - Migration Helpers

Utility functions for common migration operations:

- Index creation/dropping helpers
- Constraint management utilities
- Data migration helpers
- Idempotent operation wrappers

### `script.py.mako` - Migration Template

Mako template for generating new migration files. Includes:

- Revision ID and down_revision
- Timestamp in docstring
- Empty `upgrade()` and `downgrade()` functions

## Common Commands

**Create a new migration (autogenerate from model changes):**

```bash
cd backend
alembic revision --autogenerate -m "description of change"
```

**Create empty migration for manual changes:**

```bash
cd backend
alembic revision -m "description of change"
```

**Apply all pending migrations:**

```bash
alembic upgrade head
```

**Rollback one migration:**

```bash
alembic downgrade -1
```

**Show current revision:**

```bash
alembic current
```

**Show migration history:**

```bash
alembic history --verbose
```

**Generate SQL without applying:**

```bash
alembic upgrade head --sql > migration.sql
```

## Environment Variables

- `DATABASE_URL` - PostgreSQL connection string (overrides alembic.ini)

Example:

```bash
export DATABASE_URL=postgresql://security:password@localhost:5432/security
```

## Best Practices

1. **Always review autogenerated migrations** - Alembic may not capture:
   - Enum value changes
   - Index/constraint renames
   - Data migrations
   - PostgreSQL-specific features (JSONB, TSVECTOR, triggers)
2. **Test migrations both ways** - Verify both `upgrade()` and `downgrade()` work
3. **Use descriptive revision messages** - Makes history easier to understand
4. **Keep migrations small** - One logical change per migration
5. **Never modify applied migrations** - Create new migrations instead

## Integration with Application

The application uses SQLAlchemy 2.0 async patterns with asyncpg, while Alembic uses synchronous connections. The `env.py` handles this by:

1. Converting the async database URL to sync format
2. Using standard psycopg2 driver for migrations
3. Sharing the same model metadata (`Base.metadata`) as the application

## Related Documentation

- `versions/AGENTS.md` - Detailed migration file documentation
- `/backend/core/database.py` - Application database module
- `/backend/models/AGENTS.md` - SQLAlchemy model documentation
- `/backend/AGENTS.md` - Backend overview

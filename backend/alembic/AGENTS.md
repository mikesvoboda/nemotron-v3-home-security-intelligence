# Alembic Database Migrations Guide

## Purpose

The `backend/alembic/` directory contains Alembic database migration infrastructure for managing schema changes in the PostgreSQL database. Alembic is SQLAlchemy's database migration tool.

## Directory Structure

```
backend/alembic/
├── AGENTS.md            # This file
├── env.py               # Migration environment configuration
├── README               # Alembic-generated readme
├── script.py.mako       # Template for new migrations
└── versions/            # Migration scripts (chronological)
```

## Key Files

### `env.py` - Migration Environment

Configures Alembic to use the application's SQLAlchemy models and database connection:

**Key Functions:**

- `get_database_url()` - Resolves database URL from:

  1. `DATABASE_URL` environment variable (priority)
  2. `sqlalchemy.url` in alembic.ini
  3. Default fallback

- `run_migrations_offline()` - Generate SQL scripts without database connection
- `run_migrations_online()` - Apply migrations with live database connection

**Important Details:**

- Converts async URLs to sync for Alembic compatibility:
  - `postgresql+asyncpg://` -> `postgresql://`
- Only PostgreSQL is supported (no SQLite)
- Uses `NullPool` to avoid connection issues
- Imports `backend.models.camera.Base` for metadata

### `script.py.mako` - Migration Template

Mako template for generating new migration files. Includes:

- Revision ID and down_revision
- Timestamp in docstring
- Empty `upgrade()` and `downgrade()` functions

### `versions/` - Migration Scripts

Contains timestamped migration scripts. Each migration has:

- Unique revision ID
- Reference to previous revision (`down_revision`)
- `upgrade()` - Apply schema changes
- `downgrade()` - Reverse schema changes

## Common Commands

**Create a new migration:**

```bash
cd backend
alembic revision --autogenerate -m "description of change"
```

**Apply all pending migrations:**

```bash
alembic upgrade head
```

**Rollback one migration:**

```bash
alembic downgrade -1
```

**Show current revision:**

```bash
alembic current
```

**Show migration history:**

```bash
alembic history
```

**Generate SQL without applying:**

```bash
alembic upgrade head --sql > migration.sql
```

## Environment Variables

- `DATABASE_URL` - PostgreSQL connection string (overrides alembic.ini)

## Best Practices

1. **Always review autogenerated migrations** - Alembic may not capture all changes correctly
2. **Test migrations both ways** - Verify both `upgrade()` and `downgrade()` work
3. **Use descriptive revision messages** - Makes history easier to understand
4. **Keep migrations small** - One logical change per migration
5. **Never modify applied migrations** - Create new migrations instead

## Integration with Application

The application uses SQLAlchemy 2.0 async patterns with asyncpg, while Alembic uses synchronous connections. The `env.py` handles this by:

1. Converting the async database URL to sync format
2. Using standard psycopg2 driver for migrations
3. Sharing the same model metadata (`Base.metadata`) as the application

## Related Documentation

- `/backend/core/database.py` - Application database module
- `/backend/models/AGENTS.md` - SQLAlchemy model documentation
- `/backend/AGENTS.md` - Backend overview

[project]
name = "home-security-intelligence"
version = "0.1.0"
description = "AI-powered home security monitoring system"
requires-python = ">=3.14"

[tool.ruff]
target-version = "py314"
line-length = 100
src = ["backend"]

[tool.ruff.lint]
select = [
    "E",      # pycodestyle errors
    "W",      # pycodestyle warnings
    "F",      # Pyflakes
    "I",      # isort
    "B",      # flake8-bugbear
    "C4",     # flake8-comprehensions
    "UP",     # pyupgrade
    "ARG",    # flake8-unused-arguments
    "SIM",    # flake8-simplify
    "TCH",    # flake8-type-checking
    "PTH",    # flake8-use-pathlib
    "ERA",    # eradicate (commented-out code)
    "PL",     # Pylint
    "RUF",    # Ruff-specific rules
    "ASYNC",  # flake8-async
    "S",      # flake8-bandit (security)
]
ignore = [
    "E501",   # line too long (handled by formatter)
    "B008",   # do not perform function calls in argument defaults
    "PLR0913",# too many arguments
    "PLR0915",# too many statements (complex business logic)
    "PLR2004",# magic value comparison
    "S101",   # use of assert detected (ok in tests)
    "PLC0415",# import not at top level (necessary for circular imports/isolation)
    "ASYNC109",# timeout parameter in async function (standard in Redis blpop)
    "ASYNC110",# asyncio.sleep in while loop (valid for shutdown monitoring)
    "ASYNC230",# open in async function (acceptable for small file I/O)
    "SIM105",  # contextlib.suppress not suitable for async CancelledError patterns
    "RUF006",  # asyncio.create_task without storing (valid in signal handlers)
    "PTH110", # os.path.exists() - acceptable pattern
    "PTH123", # open() instead of Path.open() - acceptable pattern
    "TC001",  # TYPE_CHECKING imports break mocking in tests - keep imports at runtime
    "TC002",  # TYPE_CHECKING imports break mocking in tests - keep imports at runtime
    "TC003",  # TYPE_CHECKING imports break mocking in tests - keep imports at runtime
]

[tool.ruff.lint.per-file-ignores]
"backend/tests/**/*.py" = [
    "S101",   # assert is fine in tests
    "ARG001", # unused function argument in fixtures
    "ARG002", # unused method argument for fixtures used via side effects
    "PLR2004",# magic values ok in tests
    "B007",   # unused loop control variable ok in tests
]
"backend/examples/**/*.py" = [
    "ERA001", # commented code ok in examples
]
"ai/**/*.py" = [
    "ASYNC230", # blocking I/O in async ok for example clients
]
"scripts/**/*.py" = [
    "SIM102",  # nested ifs more readable in utility scripts
]

[tool.ruff.format]
quote-style = "double"
indent-style = "space"
skip-magic-trailing-comma = false
line-ending = "auto"

[tool.mypy]
python_version = "3.14"
warn_return_any = true
warn_unused_configs = true
disallow_untyped_defs = true
ignore_missing_imports = true
plugins = ["pydantic.mypy"]

[[tool.mypy.overrides]]
module = "backend.tests.*"
ignore_errors = true

[[tool.mypy.overrides]]
module = "backend.examples.*"
disallow_untyped_defs = false

[tool.pytest.ini_options]
testpaths = ["backend/tests"]
python_files = ["test_*.py"]
python_classes = ["Test*"]
python_functions = ["test_*"]
asyncio_mode = "auto"
asyncio_default_fixture_loop_scope = "function"
addopts = "-v --strict-markers --tb=short --timeout=30"
timeout_method = "signal"
markers = [
    "asyncio: mark test as an async test",
    "unit: mark test as a unit test",
    "integration: mark test as an integration test",
]

[tool.coverage.run]
source = ["backend"]
omit = [
    "backend/tests/*",
    "backend/examples/*",
    "backend/main.py",
    "*/__pycache__/*",
    "*/.venv/*",
    "*/venv/*",
    # Post-MVP features - need tests before enabling coverage
    "backend/api/routes/alerts.py",
    "backend/api/routes/audit.py",
    "backend/services/video_processor.py",
    "backend/services/degradation_manager.py",
    # TLS certificate generation - requires system-level testing
    "backend/core/tls.py",
]

[tool.coverage.report]
exclude_lines = [
    "pragma: no cover",
    "def __repr__",
    "raise NotImplementedError",
    "if __name__ == .__main__.:",
    "if TYPE_CHECKING:",
    "@abstractmethod",
]
fail_under = 93  # Temporarily lowered from 95 due to PostgreSQL migration
show_missing = true
precision = 2

[tool.coverage.html]
directory = "coverage/backend"

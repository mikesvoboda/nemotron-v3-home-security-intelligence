name: Documentation Drift Detection

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize]
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.14'
  UV_VERSION: '0.9.18'

jobs:
  detect-drift:
    name: Check Documentation Drift
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Set up uv
        uses: astral-sh/setup-uv@e4db8464a088ece1b920f60402e813ea4de65b8f # v4
        with:
          version: ${{ env.UV_VERSION }}
          enable-cache: true

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --extra dev --frozen

      - name: Analyze changes for doc drift
        id: drift-analysis
        run: |
          # Determine base and head references
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_REF="${{ github.event.pull_request.base.sha }}"
            HEAD_REF="${{ github.event.pull_request.head.sha }}"
            PR_NUMBER="${{ github.event.pull_request.number }}"
          else
            # For push to main, use last commit vs current
            BASE_REF="${{ github.event.before }}"
            HEAD_REF="${{ github.sha }}"
            PR_NUMBER=""
          fi

          # Run drift detection script
          uv run python scripts/check-docs-drift.py \
            --output drift-report.json \
            --base "$BASE_REF" \
            --head "$HEAD_REF" \
            ${PR_NUMBER:+--pr-number "$PR_NUMBER"}

      - name: Check if drift report exists
        id: check-drift
        run: |
          if [ -f drift-report.json ]; then
            # Check if there are any drift items
            DRIFT_COUNT=$(jq '.drift_items | length' drift-report.json)
            if [ "$DRIFT_COUNT" -gt 0 ]; then
              echo "drift_detected=true" >> $GITHUB_OUTPUT
              echo "drift_count=$DRIFT_COUNT" >> $GITHUB_OUTPUT
            else
              echo "drift_detected=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "drift_detected=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Linear tasks for drift
        if: steps.check-drift.outputs.drift_detected == 'true' && secrets.LINEAR_API_KEY
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        run: |
          uv run python scripts/create-docs-tasks.py drift-report.json

      - name: Comment on PR with drift summary
        if: github.event_name == 'pull_request' && steps.check-drift.outputs.drift_detected == 'true'
        uses: actions/github-script@e69f5dd54fb5a0ee7fbaf10f961ad06f6dcad5cb # v7
        with:
          github-token: ${{ github.token }}
          script: |
            const fs = require('fs');

            // Check if drift report exists and has content
            if (!fs.existsSync('drift-report.json')) {
              console.log('No drift report found, skipping comment');
              return;
            }

            const report = JSON.parse(fs.readFileSync('drift-report.json', 'utf8'));

            if (!report.drift_items || report.drift_items.length === 0) {
              console.log('No drift items detected, skipping comment');
              return;
            }

            // Build the comment markdown
            let body = '## Documentation Drift Detected\n\n';
            body += 'This PR introduces changes that may require documentation updates.\n\n';
            body += '| Priority | Description | Status |\n';
            body += '|----------|-------------|--------|\n';

            for (const item of report.drift_items) {
              let icon = 'ðŸŸ¢';
              if (item.priority === 'high') {
                icon = 'ðŸ”´';
              } else if (item.priority === 'medium') {
                icon = 'ðŸŸ¡';
              }

              const description = item.description.substring(0, 80);
              body += `| ${icon} ${item.priority} | ${description} | Task created |\n`;
            }

            body += '\n---\n';
            body += '<sub>Auto-generated by documentation drift detection. Tasks are non-blocking and have been added to the backlog.</sub>';

            // Post the comment
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Upload drift report
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: drift-report
          path: drift-report.json
          retention-days: 30

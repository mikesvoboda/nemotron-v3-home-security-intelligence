name: ZAP Security Scan

# Dynamic Application Security Testing (DAST) using OWASP ZAP.
# Runs as a non-blocking check that scans the running API for security vulnerabilities.
#
# Why non-blocking?
# - Some ZAP findings may be false positives requiring investigation
# - Low/Medium alerts are informational and don't block deployment
# - Only HIGH/CRITICAL alerts should warrant immediate attention
#
# Use the results to identify and prioritize security improvements.

on:
  pull_request:
    branches: [main]
    paths:
      - 'backend/**'
      - '.github/workflows/zap-security.yml'
      - 'zap-rules.tsv'
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - '.github/workflows/zap-security.yml'
      - 'zap-rules.tsv'
  # Manual trigger for on-demand security scanning
  workflow_dispatch:

concurrency:
  group: zap-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.14'

jobs:
  # ============================================================================
  # OWASP ZAP API Security Scan
  # ============================================================================
  zap-api-scan:
    name: ZAP API Scan
    runs-on: ubuntu-latest
    # Non-blocking: failures are informational
    continue-on-error: true
    timeout-minutes: 20

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres # pragma: allowlist secret
          POSTGRES_DB: security_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/security_test # pragma: allowlist secret
      TEST_DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/security_test # pragma: allowlist secret
      REDIS_URL: redis://localhost:6379
      # Disable AI restart since we're in CI (no AI services running)
      AI_RESTART_ENABLED: 'false'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v4
        with:
          version: '0.9.18'
          enable-cache: true

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --extra dev --frozen

      - name: Initialize database
        run: |
          cd backend && PYTHONPATH=.. uv run alembic upgrade head

      - name: Start backend server
        run: |
          uv run uvicorn backend.main:app --host 0.0.0.0 --port 8000 &
          echo "Waiting for backend to start..."
          for i in {1..30}; do
            if curl -s http://localhost:8000/api/system/health/ready > /dev/null 2>&1; then
              echo "Backend is ready!"
              break
            fi
            echo "Attempt $i/30..."
            sleep 2
          done
          # Final check
          if ! curl -s http://localhost:8000/api/system/health/ready > /dev/null 2>&1; then
            echo "Backend failed to start!"
            exit 1
          fi

      - name: Verify OpenAPI spec is accessible
        run: |
          curl -s http://localhost:8000/openapi.json | head -100
          echo ""
          echo "OpenAPI spec is accessible"

      - name: Download OpenAPI spec for ZAP
        run: |
          curl -s http://localhost:8000/openapi.json -o openapi.json
          echo "OpenAPI spec downloaded ($(wc -c < openapi.json) bytes)"

      - name: Run ZAP API Scan
        id: zap_scan
        uses: zaproxy/action-api-scan@v0.9.0
        with:
          target: 'openapi.json'
          format: 'openapi'
          rules_file_name: 'zap-rules.tsv'
          # Don't fail on alerts - we handle this ourselves
          fail_action: false
          # Disable GitHub issue creation (we use Linear instead)
          allow_issue_writing: false
          # Additional scan options for baseline scan
          cmd_options: '-I -a'

      - name: Check for HIGH/CRITICAL alerts
        id: check_alerts
        run: |
          # Parse ZAP HTML report for alert counts
          # ZAP creates a report in the working directory
          if [ -f "zap-report.html" ] || [ -f "report_html.html" ]; then
            REPORT_FILE=$(ls zap-report.html report_html.html 2>/dev/null | head -1)
            echo "Found ZAP report: $REPORT_FILE"

            # Check for High and Critical risk alerts in the HTML
            # ZAP marks these with "High" or "Critical" risk levels
            # Use tr to remove newlines and ensure single integer output
            HIGH_COUNT=$(grep -c "Risk.*High\|High.*Risk" "$REPORT_FILE" 2>/dev/null | tr -d '\n' || echo "0")
            CRITICAL_COUNT=$(grep -c "Risk.*Critical\|Critical.*Risk" "$REPORT_FILE" 2>/dev/null | tr -d '\n' || echo "0")

            # Ensure counts are valid integers (default to 0 if empty or non-numeric)
            HIGH_COUNT=${HIGH_COUNT:-0}
            CRITICAL_COUNT=${CRITICAL_COUNT:-0}
            [[ "$HIGH_COUNT" =~ ^[0-9]+$ ]] || HIGH_COUNT=0
            [[ "$CRITICAL_COUNT" =~ ^[0-9]+$ ]] || CRITICAL_COUNT=0

            echo "high_count=$HIGH_COUNT" >> $GITHUB_OUTPUT
            echo "critical_count=$CRITICAL_COUNT" >> $GITHUB_OUTPUT

            if [ "$HIGH_COUNT" -gt 0 ] || [ "$CRITICAL_COUNT" -gt 0 ]; then
              echo "has_critical_alerts=true" >> $GITHUB_OUTPUT
              echo "::warning::Found HIGH ($HIGH_COUNT) / CRITICAL ($CRITICAL_COUNT) security alerts"
            else
              echo "has_critical_alerts=false" >> $GITHUB_OUTPUT
              echo "No HIGH/CRITICAL alerts found"
            fi
          else
            echo "No ZAP report found"
            echo "has_critical_alerts=false" >> $GITHUB_OUTPUT
            echo "high_count=0" >> $GITHUB_OUTPUT
            echo "critical_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Generate results summary
        if: always()
        run: |
          echo "## ZAP Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Type:** API Scan (OpenAPI)" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** http://localhost:8000" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_alerts.outputs.has_critical_alerts }}" == "true" ]; then
            echo "### :warning: Security Alerts Found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| HIGH | ${{ steps.check_alerts.outputs.high_count }} |" >> $GITHUB_STEP_SUMMARY
            echo "| CRITICAL | ${{ steps.check_alerts.outputs.critical_count }} |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Review the uploaded ZAP report artifact for details." >> $GITHUB_STEP_SUMMARY
          else
            echo "### :white_check_mark: No HIGH/CRITICAL Alerts" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No high-severity security vulnerabilities detected." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Resources" >> $GITHUB_STEP_SUMMARY
          echo "- [OWASP ZAP](https://www.zaproxy.org/)" >> $GITHUB_STEP_SUMMARY
          echo "- [ZAP API Scan](https://www.zaproxy.org/docs/docker/api-scan/)" >> $GITHUB_STEP_SUMMARY
          echo "- Configure alert rules in \`zap-rules.tsv\`" >> $GITHUB_STEP_SUMMARY

      - name: Rename and prepare reports
        if: always()
        run: |
          mkdir -p zap-reports
          # ZAP action creates various report files - collect them all
          for f in zap-report.html report_html.html zap-report.json report_json.json zap-report.md report_md.md; do
            if [ -f "$f" ]; then
              cp "$f" zap-reports/
            fi
          done
          # Also copy the OpenAPI spec for reference
          if [ -f "openapi.json" ]; then
            cp openapi.json zap-reports/
          fi
          ls -la zap-reports/ || echo "No reports generated"

      - name: Upload ZAP report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: zap-security-report
          path: zap-reports/
          retention-days: 30

  # ============================================================================
  # Summary Job
  # ============================================================================
  zap-summary:
    name: ZAP Scan Summary
    runs-on: ubuntu-latest
    needs: [zap-api-scan]
    if: always()
    steps:
      - name: Check ZAP scan results
        run: |
          if [ "${{ needs.zap-api-scan.result }}" == "failure" ]; then
            echo "::warning::ZAP security scan detected issues. Review the artifacts for details."
            echo ""
            echo "To investigate ZAP findings:"
            echo "  1. Download the zap-security-report artifact"
            echo "  2. Review the HTML report for vulnerability details"
            echo "  3. Update zap-rules.tsv to ignore false positives"
          else
            echo "ZAP security scan completed successfully!"
          fi

      - name: Create Linear issue on failure
        if: needs.zap-api-scan.result == 'failure' && github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        run: |
          # Only create issue for failures on main branch pushes (not PRs)
          curl -X POST https://api.linear.app/graphql \
            -H "Content-Type: application/json" \
            -H "Authorization: $LINEAR_API_KEY" \
            -d '{
              "query": "mutation CreateIssue($input: IssueCreateInput!) { issueCreate(input: $input) { success issue { id identifier url } } }",
              "variables": {
                "input": {
                  "teamId": "998946a2-aa75-491b-a39d-189660131392",
                  "title": "ZAP security scan found vulnerabilities on main",
                  "description": "## ZAP Security Scan Failure\n\nThe OWASP ZAP security scan found potential vulnerabilities after a merge to main.\n\n**Commit:** ${{ github.sha }}\n**Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n\n### Action Required\n\n1. Download the zap-security-report artifact from the workflow run\n2. Review the HTML report for vulnerability details\n3. Prioritize HIGH and CRITICAL findings\n4. Either fix the vulnerability or add to `zap-rules.tsv` if false positive\n\n### Resources\n\n- [OWASP ZAP Documentation](https://www.zaproxy.org/docs/)\n- [ZAP Alert Reference](https://www.zaproxy.org/docs/alerts/)",
                  "priority": 2,
                  "labelIds": ["fef74b6f-0631-42e2-87f9-3c31e4bab170"]
                }
              }
            }'

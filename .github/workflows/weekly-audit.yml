name: Weekly Audit

on:
  schedule:
    - cron: '0 9 * * 1' # Monday 9 AM UTC
  workflow_dispatch: # Allow manual trigger

env:
  PYTHON_VERSION: '3.14'
  NODE_VERSION: '20'
  UV_VERSION: '0.9.18'

jobs:
  security-audit:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@713efdd345f3035192eaa63f56867b88e63e4e5d # v1
        with:
          config: p/python p/typescript p/security-audit
        continue-on-error: true

      - name: Set up uv
        uses: astral-sh/setup-uv@e4db8464a088ece1b920f60402e813ea4de65b8f # v4
        with:
          version: ${{ env.UV_VERSION }}

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install pip-audit
        run: uv tool install pip-audit

      - name: Python Dependency Audit
        run: |
          # Export dependencies to requirements format for pip-audit
          uv export --no-hashes > requirements-audit.txt
          pip-audit -r requirements-audit.txt --desc || true

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up uv
        uses: astral-sh/setup-uv@e4db8464a088ece1b920f60402e813ea4de65b8f # v4
        with:
          version: ${{ env.UV_VERSION }}

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Sync dependencies
        run: uv sync --extra dev --frozen

      - name: Dead Code Detection (Vulture)
        run: |
          echo "=== Dead Code Analysis ==="
          uv run vulture backend/ vulture_whitelist.py --min-confidence 80 || true

      - name: Complexity Analysis (Radon)
        run: |
          echo "=== Cyclomatic Complexity (C+ only) ==="
          uv run radon cc backend/ -a -nc || true
          echo ""
          echo "=== Maintainability Index ==="
          uv run radon mi backend/ -s || true

  frontend-quality:
    name: Frontend Quality
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Dead Code Detection (Knip)
        run: npx knip || true

  audit-summary:
    name: Generate Summary
    runs-on: ubuntu-latest
    needs: [security-audit, code-quality, frontend-quality]
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Generate audit summary
        run: |
          echo "## Weekly Audit Summary - $(date +'%Y-%m-%d')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Quality | ${{ needs.frontend-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "Review the job logs above for detailed findings." >> $GITHUB_STEP_SUMMARY
          echo "Create beads for issues with: \`bd create '<title>' --labels weekly-audit\`" >> $GITHUB_STEP_SUMMARY

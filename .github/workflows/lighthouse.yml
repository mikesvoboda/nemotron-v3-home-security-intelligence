name: Lighthouse Performance Tests

# Runs on merge to main only (not PRs) to save runner capacity.

on:
  push:
    branches: [main]
    paths:
      - 'frontend/**'
      - '.github/workflows/lighthouse.yml'

concurrency:
  group: lighthouse-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'

jobs:
  lighthouse:
    name: Lighthouse Performance Audit
    runs-on: ubuntu-latest
    # Non-blocking for now while baselines are established
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: cd frontend && npm ci

      - name: Build frontend
        run: cd frontend && npm run build

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli

      - name: Run Lighthouse CI
        id: lighthouse
        run: |
          cd frontend
          lhci autorun --config=lighthouserc.js 2>&1 | tee lighthouse-output.txt
          # Extract scores for summary
          echo "lighthouse_completed=true" >> $GITHUB_OUTPUT

      - name: Generate Lighthouse Summary
        if: always()
        run: |
          cd frontend
          echo "## Lighthouse Performance Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pages Tested" >> $GITHUB_STEP_SUMMARY
          echo "- \`/\` (Dashboard)" >> $GITHUB_STEP_SUMMARY
          echo "- \`/timeline\` (Event Timeline)" >> $GITHUB_STEP_SUMMARY
          echo "- \`/settings\` (Settings)" >> $GITHUB_STEP_SUMMARY
          echo "- \`/system\` (System Status)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Thresholds" >> $GITHUB_STEP_SUMMARY
          echo "| Category | Minimum Score |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|---------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Performance | 70 |" >> $GITHUB_STEP_SUMMARY
          echo "| Accessibility | 80 |" >> $GITHUB_STEP_SUMMARY
          echo "| Best Practices | 80 |" >> $GITHUB_STEP_SUMMARY
          echo "| SEO | 70 |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f lighthouse-output.txt ]; then
            echo "### Lighthouse Output" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            tail -50 lighthouse-output.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Run:** [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

      - name: Upload Lighthouse HTML reports
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: lighthouse-reports
          path: frontend/.lighthouseci/
          retention-days: 14

      - name: Upload Lighthouse output log
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: lighthouse-output
          path: frontend/lighthouse-output.txt
          retention-days: 14

  # Summary job for PR status and Linear issue creation
  lighthouse-summary:
    name: Lighthouse Summary
    runs-on: ubuntu-latest
    needs: [lighthouse]
    if: always()
    steps:
      - name: Check Lighthouse results
        run: |
          if [ "${{ needs.lighthouse.result }}" == "failure" ]; then
            echo "::warning::Lighthouse performance tests detected issues. Review the artifacts for details."
            echo "Consider optimizing:"
            echo "  - Image sizes and formats"
            echo "  - JavaScript bundle size"
            echo "  - CSS delivery"
            echo "  - Core Web Vitals metrics"
          else
            echo "Lighthouse performance tests passed!"
          fi

      - name: Create Linear issue on failure
        if: needs.lighthouse.result == 'failure' && github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        run: |
          curl -X POST https://api.linear.app/graphql \
            -H "Content-Type: application/json" \
            -H "Authorization: $LINEAR_API_KEY" \
            -d '{
              "query": "mutation CreateIssue($input: IssueCreateInput!) { issueCreate(input: $input) { success issue { id identifier url } } }",
              "variables": {
                "input": {
                  "teamId": "998946a2-aa75-491b-a39d-189660131392",
                  "title": "Lighthouse performance regression on main",
                  "description": "## Lighthouse Performance Regression\n\nThe Lighthouse performance tests failed after a merge to main.\n\n**Commit:** ${{ github.sha }}\n**Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n\n### Thresholds\n\n| Category | Minimum Score |\n|----------|---------------|\n| Performance | 70 |\n| Accessibility | 80 |\n| Best Practices | 80 |\n| SEO | 70 |\n\n### Pages Tested\n\n- `/` (Dashboard)\n- `/timeline` (Event Timeline)\n- `/settings` (Settings)\n- `/system` (System Status)\n\n### Action Required\n\n1. Review the Lighthouse reports in the workflow artifacts\n2. Identify which category/page failed the threshold\n3. Optimize the affected areas:\n   - **Performance**: Reduce bundle size, optimize images, improve Core Web Vitals\n   - **Accessibility**: Fix ARIA labels, color contrast, keyboard navigation\n   - **Best Practices**: Update deprecated APIs, fix console errors, use HTTPS\n   - **SEO**: Add meta descriptions, improve semantic HTML",
                  "priority": 3,
                  "labelIds": ["fef74b6f-0631-42e2-87f9-3c31e4bab170"]
                }
              }
            }'

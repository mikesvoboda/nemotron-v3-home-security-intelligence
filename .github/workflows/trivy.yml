name: Trivy Container Scan

# Only run on push to main (post-merge) to avoid disk space issues on PR checks.
# The backend image includes heavy ML dependencies (PyTorch, transformers) that
# exhaust GitHub runner disk space when building + scanning during PR workflows.
on:
  push:
    branches: [main]
    paths:
      - '**/Dockerfile*'
      - 'backend/requirements.txt'
      - 'backend/requirements-prod.txt'
      - 'frontend/package.json'
      - 'pyproject.toml'
      - 'uv.lock'

permissions:
  contents: read
  security-events: write

env:
  # Linear team ID for NEM team
  LINEAR_TEAM_ID: '998946a2-aa75-491b-a39d-189660131392'

jobs:
  scan-backend:
    name: Scan Backend Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free up disk space
        # Backend image includes heavy ML dependencies (PyTorch, transformers)
        # which require more disk space than default GitHub runners provide
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Build backend image
        id: build
        # Use production Dockerfile which has minimal dependencies
        # Context must be project root because Dockerfile.prod copies pyproject.toml/uv.lock from root
        run: docker build -t backend:${{ github.sha }} -f backend/Dockerfile.prod .

      - name: Run Trivy vulnerability scanner (blocking)
        id: trivy-scan
        # Fail build on CRITICAL/HIGH vulnerabilities not in .trivyignore
        # Only run if build succeeded
        # Note: SARIF upload skipped for backend due to disk space constraints
        # (large ML image + Trivy cache exhausts GitHub runner disk)
        if: steps.build.outcome == 'success'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'backend:${{ github.sha }}'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          trivyignores: '.trivyignore'

      - name: Create Linear issue on vulnerability found
        if: failure() && steps.trivy-scan.outcome == 'failure'
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        run: |
          curl -s -X POST https://api.linear.app/graphql \
            -H "Content-Type: application/json" \
            -H "Authorization: $LINEAR_API_KEY" \
            -d '{
              "query": "mutation CreateIssue($input: IssueCreateInput!) { issueCreate(input: $input) { success issue { id identifier url } } }",
              "variables": {
                "input": {
                  "teamId": "'"$LINEAR_TEAM_ID"'",
                  "title": "ðŸ”´ Trivy: Backend container vulnerabilities detected",
                  "description": "## Security Alert\n\nTrivy detected **CRITICAL/HIGH** vulnerabilities in the backend container image.\n\n### Details\n- **Commit:** `${{ github.sha }}`\n- **Branch:** `${{ github.ref_name }}`\n- **Workflow Run:** [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n- **Triggered by:** ${{ github.actor }}\n\n### Next Steps\n1. Review the Trivy scan output in the workflow logs\n2. Update vulnerable dependencies or add to `.trivyignore` if false positive\n3. Re-run the workflow to verify fix\n\n### References\n- [Trivy Documentation](https://aquasecurity.github.io/trivy/)\n- [.trivyignore file](https://github.com/${{ github.repository }}/blob/main/.trivyignore)",
                  "priority": 1,
                  "labelIds": []
                }
              }
            }'

  scan-frontend:
    name: Scan Frontend Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build frontend image
        id: build
        # Use production Dockerfile which has minimal dependencies
        run: docker build -t frontend:${{ github.sha }} -f frontend/Dockerfile.prod frontend/

      - name: Run Trivy vulnerability scanner (blocking)
        id: trivy-scan
        # Fail build on CRITICAL/HIGH vulnerabilities not in .trivyignore
        # Only run if build succeeded
        if: steps.build.outcome == 'success'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'frontend:${{ github.sha }}'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          trivyignores: '.trivyignore'

      - name: Run Trivy for SARIF upload
        # Run SARIF generation for GitHub Security tab if build succeeded
        # Runs even if blocking scan above failed (found vulnerabilities)
        if: always() && steps.build.outcome == 'success'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'frontend:${{ github.sha }}'
          format: 'sarif'
          output: 'trivy-frontend.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
          trivyignores: '.trivyignore'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always() && steps.build.outcome == 'success'
        with:
          sarif_file: 'trivy-frontend.sarif'

      - name: Create Linear issue on vulnerability found
        if: failure() && steps.trivy-scan.outcome == 'failure'
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        run: |
          curl -s -X POST https://api.linear.app/graphql \
            -H "Content-Type: application/json" \
            -H "Authorization: $LINEAR_API_KEY" \
            -d '{
              "query": "mutation CreateIssue($input: IssueCreateInput!) { issueCreate(input: $input) { success issue { id identifier url } } }",
              "variables": {
                "input": {
                  "teamId": "'"$LINEAR_TEAM_ID"'",
                  "title": "ðŸ”´ Trivy: Frontend container vulnerabilities detected",
                  "description": "## Security Alert\n\nTrivy detected **CRITICAL/HIGH** vulnerabilities in the frontend container image.\n\n### Details\n- **Commit:** `${{ github.sha }}`\n- **Branch:** `${{ github.ref_name }}`\n- **Workflow Run:** [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n- **Triggered by:** ${{ github.actor }}\n\n### Next Steps\n1. Review the Trivy scan output in the workflow logs\n2. Update vulnerable dependencies or add to `.trivyignore` if false positive\n3. Re-run the workflow to verify fix\n\n### References\n- [Trivy Documentation](https://aquasecurity.github.io/trivy/)\n- [.trivyignore file](https://github.com/${{ github.repository }}/blob/main/.trivyignore)",
                  "priority": 1,
                  "labelIds": []
                }
              }
            }'

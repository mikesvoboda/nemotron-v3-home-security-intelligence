name: Trivy Container Scan

# Only run on push to main (post-merge) to avoid disk space issues on PR checks.
# The backend image includes heavy ML dependencies (PyTorch, transformers) that
# exhaust GitHub runner disk space when building + scanning during PR workflows.
on:
  push:
    branches: [main]
    paths:
      - '**/Dockerfile*'
      - 'backend/requirements.txt'
      - 'backend/requirements-prod.txt'
      - 'frontend/package.json'
      - 'pyproject.toml'
      - 'uv.lock'
      - '.trivyignore'
  # Weekly check for expired CVE reviews (every Monday at 9am UTC)
  schedule:
    - cron: '0 9 * * 1'
  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

env:
  # Linear team ID for NEM team
  LINEAR_TEAM_ID: '998946a2-aa75-491b-a39d-189660131392'

jobs:
  check-cve-expiry:
    name: Check CVE Review Dates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for expired CVE review dates
        id: expiry-check
        run: |
          ./scripts/check-trivyignore-expiry.sh --warn-days 14
        continue-on-error: true

      - name: Create Linear issue on expired CVEs
        if: steps.expiry-check.outcome == 'failure'
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        run: |
          curl -s -X POST https://api.linear.app/graphql \
            -H "Content-Type: application/json" \
            -H "Authorization: $LINEAR_API_KEY" \
            -d '{
              "query": "mutation CreateIssue($input: IssueCreateInput!) { issueCreate(input: $input) { success issue { id identifier url } } }",
              "variables": {
                "input": {
                  "teamId": "'"$LINEAR_TEAM_ID"'",
                  "title": "CVE review dates expired in .trivyignore",
                  "description": "## CVE Review Required\n\nOne or more CVEs in `.trivyignore` have expired review dates.\n\n### Details\n- **Workflow Run:** [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\n### Next Steps\n1. Review each expired CVE in `.trivyignore`\n2. Check if a fix is now available\n3. Either remove the CVE (if fixed) or extend the review date\n4. Update the `Last reviewed` date at the bottom of the file\n\n### References\n- [.trivyignore file](https://github.com/${{ github.repository }}/blob/main/.trivyignore)\n- [Trivy ignore documentation](https://aquasecurity.github.io/trivy/latest/docs/configuration/filtering/)",
                  "priority": 2,
                  "labelIds": []
                }
              }
            }'

      - name: Fail on expired CVEs
        if: steps.expiry-check.outcome == 'failure'
        run: exit 1

  scan-backend:
    needs: check-cve-expiry
    # Run scans even if CVE check fails (for visibility)
    if: always() && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    name: Scan Backend Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free up disk space
        # Backend image includes heavy ML dependencies (PyTorch, transformers)
        # which require more disk space than default GitHub runners provide
        uses: jlumbroso/free-disk-space@54081f138730dfa15788a46383842cd2f914a1be # v1.3.1
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Build backend image
        id: build
        # Use production target which has minimal dependencies
        # Context must be project root because Dockerfile copies pyproject.toml/uv.lock from root
        run: docker build -t backend:${{ github.sha }} -f backend/Dockerfile --target prod .

      - name: Clean up Docker build cache to free space
        # Remove only build cache and intermediate layers, NOT the built image
        # IMPORTANT: Don't use 'docker system prune -af' as it deletes ALL unused images
        # including the image we just built but haven't scanned yet
        run: |
          docker builder prune -af
          df -h

      - name: Run Trivy vulnerability scanner (blocking)
        id: trivy-scan
        # Fail build on CRITICAL/HIGH vulnerabilities not in .trivyignore
        # Only run if build succeeded
        # Note: SARIF upload skipped for backend due to disk space constraints
        # (large ML image + Trivy cache exhausts GitHub runner disk)
        # Using scanners: 'vuln' to skip secret scanning and reduce disk usage
        if: steps.build.outcome == 'success'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'backend:${{ github.sha }}'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          trivyignores: '.trivyignore'
          scanners: 'vuln'

      - name: Create Linear issue on vulnerability found
        if: failure() && steps.trivy-scan.outcome == 'failure'
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        run: |
          curl -s -X POST https://api.linear.app/graphql \
            -H "Content-Type: application/json" \
            -H "Authorization: $LINEAR_API_KEY" \
            -d '{
              "query": "mutation CreateIssue($input: IssueCreateInput!) { issueCreate(input: $input) { success issue { id identifier url } } }",
              "variables": {
                "input": {
                  "teamId": "'"$LINEAR_TEAM_ID"'",
                  "title": "ðŸ”´ Trivy: Backend container vulnerabilities detected",
                  "description": "## Security Alert\n\nTrivy detected **CRITICAL/HIGH** vulnerabilities in the backend container image.\n\n### Details\n- **Commit:** `${{ github.sha }}`\n- **Branch:** `${{ github.ref_name }}`\n- **Workflow Run:** [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n- **Triggered by:** ${{ github.actor }}\n\n### Next Steps\n1. Review the Trivy scan output in the workflow logs\n2. Update vulnerable dependencies or add to `.trivyignore` if false positive\n3. Re-run the workflow to verify fix\n\n### References\n- [Trivy Documentation](https://aquasecurity.github.io/trivy/)\n- [.trivyignore file](https://github.com/${{ github.repository }}/blob/main/.trivyignore)",
                  "priority": 1,
                  "labelIds": []
                }
              }
            }'

  scan-frontend:
    needs: check-cve-expiry
    # Run scans even if CVE check fails (for visibility)
    if: always() && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    name: Scan Frontend Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build frontend image
        id: build
        # Use production target which has minimal dependencies
        run: docker build -t frontend:${{ github.sha }} -f frontend/Dockerfile --target prod frontend/

      - name: Run Trivy vulnerability scanner (blocking)
        id: trivy-scan
        # Fail build on CRITICAL/HIGH vulnerabilities not in .trivyignore
        # Only run if build succeeded
        if: steps.build.outcome == 'success'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'frontend:${{ github.sha }}'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          trivyignores: '.trivyignore'

      - name: Run Trivy for SARIF upload
        # Run SARIF generation for GitHub Security tab if build succeeded
        # Runs even if blocking scan above failed (found vulnerabilities)
        if: always() && steps.build.outcome == 'success'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'frontend:${{ github.sha }}'
          format: 'sarif'
          output: 'trivy-frontend.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
          trivyignores: '.trivyignore'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always() && steps.build.outcome == 'success'
        with:
          sarif_file: 'trivy-frontend.sarif'

      - name: Create Linear issue on vulnerability found
        if: failure() && steps.trivy-scan.outcome == 'failure'
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        run: |
          curl -s -X POST https://api.linear.app/graphql \
            -H "Content-Type: application/json" \
            -H "Authorization: $LINEAR_API_KEY" \
            -d '{
              "query": "mutation CreateIssue($input: IssueCreateInput!) { issueCreate(input: $input) { success issue { id identifier url } } }",
              "variables": {
                "input": {
                  "teamId": "'"$LINEAR_TEAM_ID"'",
                  "title": "ðŸ”´ Trivy: Frontend container vulnerabilities detected",
                  "description": "## Security Alert\n\nTrivy detected **CRITICAL/HIGH** vulnerabilities in the frontend container image.\n\n### Details\n- **Commit:** `${{ github.sha }}`\n- **Branch:** `${{ github.ref_name }}`\n- **Workflow Run:** [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n- **Triggered by:** ${{ github.actor }}\n\n### Next Steps\n1. Review the Trivy scan output in the workflow logs\n2. Update vulnerable dependencies or add to `.trivyignore` if false positive\n3. Re-run the workflow to verify fix\n\n### References\n- [Trivy Documentation](https://aquasecurity.github.io/trivy/)\n- [.trivyignore file](https://github.com/${{ github.repository }}/blob/main/.trivyignore)",
                  "priority": 1,
                  "labelIds": []
                }
              }
            }'

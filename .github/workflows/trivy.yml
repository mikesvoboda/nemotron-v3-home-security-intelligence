name: Trivy Security Scan

# Filesystem and config scanning runs on PRs (lightweight, no Docker build required).
# Container image scanning runs on push to main (heavy ML dependencies exhaust disk space).
on:
  push:
    branches: [main]
    paths:
      - '**/Dockerfile*'
      - 'backend/requirements.txt'
      - 'backend/requirements-prod.txt'
      - 'frontend/package.json'
      - 'pyproject.toml'
      - 'uv.lock'
      - '.trivyignore'
  pull_request:
    branches: [main]
    paths:
      - '**/*.py'
      - '**/*.ts'
      - '**/*.tsx'
      - '**/*.js'
      - '**/Dockerfile*'
      - '**/docker-compose*.yml'
      - 'pyproject.toml'
      - 'uv.lock'
      - 'frontend/package.json'
      - 'frontend/package-lock.json'
  # Weekly check for expired CVE reviews (every Monday at 9am UTC)
  schedule:
    - cron: '0 9 * * 1'
  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

env:
  # Linear team ID for NEM team
  LINEAR_TEAM_ID: '998946a2-aa75-491b-a39d-189660131392'

jobs:
  # =============================================================================
  # FILESYSTEM SCANNING - Runs on PRs (lightweight)
  # =============================================================================
  scan-filesystem:
    name: Filesystem Vulnerability Scan
    runs-on: ubuntu-latest
    # Run on PRs and pushes
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          trivyignores: '.trivyignore'
          scanners: 'vuln,secret'
          # Skip scanning node_modules and .venv to reduce scan time
          skip-dirs: 'node_modules,.venv,coverage,dist,build,mutants'

      - name: Run Trivy filesystem scan (SARIF)
        if: always()
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'
          trivyignores: '.trivyignore'
          scanners: 'vuln,secret'
          skip-dirs: 'node_modules,.venv,coverage,dist,build,mutants'

      - name: Upload Trivy filesystem results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-fs.sarif'
          category: 'trivy-filesystem'

  # =============================================================================
  # CONFIG/IAC SCANNING - Runs on PRs (lightweight)
  # =============================================================================
  scan-config:
    name: Config/IaC Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Run Trivy config scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '1'
          trivyignores: '.trivyignore'
          # Skip test and generated directories
          skip-dirs: 'node_modules,.venv,coverage,dist,build,mutants,tests'

      - name: Run Trivy config scan (SARIF)
        if: always()
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-config.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'
          trivyignores: '.trivyignore'
          skip-dirs: 'node_modules,.venv,coverage,dist,build,mutants,tests'

      - name: Upload Trivy config results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-config.sarif'
          category: 'trivy-config'

  # =============================================================================
  # SBOM GENERATION - Generate Software Bill of Materials
  # =============================================================================
  generate-sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    # Only generate SBOM on push to main (not PRs)
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Generate SBOM for Python dependencies
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'cyclonedx'
          output: 'sbom-python.json'
          scanners: 'vuln'
          skip-dirs: 'node_modules,frontend,coverage,dist,build,mutants'

      - name: Generate SBOM for Node.js dependencies
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './frontend'
          format: 'cyclonedx'
          output: 'sbom-nodejs.json'
          scanners: 'vuln'
          skip-dirs: 'node_modules,coverage,dist'

      - name: Upload SBOMs as artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: sbom-${{ github.sha }}
          path: |
            sbom-python.json
            sbom-nodejs.json
          retention-days: 90

  # =============================================================================
  # CVE EXPIRY CHECK - Weekly review date validation
  # =============================================================================
  check-cve-expiry:
    name: Check CVE Review Dates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Check for expired CVE review dates
        id: expiry-check
        run: |
          ./scripts/check-trivyignore-expiry.sh --warn-days 14
        continue-on-error: true

      - name: Create Linear issue on expired CVEs
        if: steps.expiry-check.outcome == 'failure'
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        run: |
          curl -s -X POST https://api.linear.app/graphql \
            -H "Content-Type: application/json" \
            -H "Authorization: $LINEAR_API_KEY" \
            -d '{
              "query": "mutation CreateIssue($input: IssueCreateInput!) { issueCreate(input: $input) { success issue { id identifier url } } }",
              "variables": {
                "input": {
                  "teamId": "'"$LINEAR_TEAM_ID"'",
                  "title": "CVE review dates expired in .trivyignore",
                  "description": "## CVE Review Required\n\nOne or more CVEs in `.trivyignore` have expired review dates.\n\n### Details\n- **Workflow Run:** [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\n### Next Steps\n1. Review each expired CVE in `.trivyignore`\n2. Check if a fix is now available\n3. Either remove the CVE (if fixed) or extend the review date\n4. Update the `Last reviewed` date at the bottom of the file\n\n### References\n- [.trivyignore file](https://github.com/${{ github.repository }}/blob/main/.trivyignore)\n- [Trivy ignore documentation](https://aquasecurity.github.io/trivy/latest/docs/configuration/filtering/)",
                  "priority": 2,
                  "labelIds": []
                }
              }
            }'

      - name: Fail on expired CVEs
        if: steps.expiry-check.outcome == 'failure'
        run: exit 1

  scan-backend:
    needs: check-cve-expiry
    # Run scans even if CVE check fails (for visibility)
    if: always() && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    name: Scan Backend Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Free up disk space
        # Backend image includes heavy ML dependencies (PyTorch, transformers)
        # which require more disk space than default GitHub runners provide
        uses: jlumbroso/free-disk-space@54081f138730dfa15788a46383842cd2f914a1be # v1.3.1
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Build backend image
        id: build
        # Use production target which has minimal dependencies
        # Context must be project root because Dockerfile copies pyproject.toml/uv.lock from root
        run: docker build -t backend:${{ github.sha }} -f backend/Dockerfile --target prod .

      - name: Clean up Docker build cache to free space
        # Remove only build cache and intermediate layers, NOT the built image
        # IMPORTANT: Don't use 'docker system prune -af' as it deletes ALL unused images
        # including the image we just built but haven't scanned yet
        run: |
          docker builder prune -af
          df -h

      - name: Run Trivy vulnerability scanner (blocking)
        id: trivy-scan
        # Fail build on CRITICAL/HIGH vulnerabilities not in .trivyignore
        # Only run if build succeeded
        # Note: SARIF upload skipped for backend due to disk space constraints
        # (large ML image + Trivy cache exhausts GitHub runner disk)
        # Using scanners: 'vuln' to skip secret scanning and reduce disk usage
        # Updated to v0.68.2 for proper 2026 CVE database coverage and ignore file support
        if: steps.build.outcome == 'success'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'backend:${{ github.sha }}'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          trivyignores: '.trivyignore'
          scanners: 'vuln'
          version: 'v0.68.2'

      - name: Create Linear issue on vulnerability found
        if: failure() && steps.trivy-scan.outcome == 'failure'
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        run: |
          curl -s -X POST https://api.linear.app/graphql \
            -H "Content-Type: application/json" \
            -H "Authorization: $LINEAR_API_KEY" \
            -d '{
              "query": "mutation CreateIssue($input: IssueCreateInput!) { issueCreate(input: $input) { success issue { id identifier url } } }",
              "variables": {
                "input": {
                  "teamId": "'"$LINEAR_TEAM_ID"'",
                  "title": "ðŸ”´ Trivy: Backend container vulnerabilities detected",
                  "description": "## Security Alert\n\nTrivy detected **CRITICAL/HIGH** vulnerabilities in the backend container image.\n\n### Details\n- **Commit:** `${{ github.sha }}`\n- **Branch:** `${{ github.ref_name }}`\n- **Workflow Run:** [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n- **Triggered by:** ${{ github.actor }}\n\n### Next Steps\n1. Review the Trivy scan output in the workflow logs\n2. Update vulnerable dependencies or add to `.trivyignore` if false positive\n3. Re-run the workflow to verify fix\n\n### References\n- [Trivy Documentation](https://aquasecurity.github.io/trivy/)\n- [.trivyignore file](https://github.com/${{ github.repository }}/blob/main/.trivyignore)",
                  "priority": 1,
                  "labelIds": []
                }
              }
            }'

  scan-frontend:
    needs: check-cve-expiry
    # Run scans even if CVE check fails (for visibility)
    if: always() && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    name: Scan Frontend Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Build frontend image
        id: build
        # Use production target which has minimal dependencies
        run: docker build -t frontend:${{ github.sha }} -f frontend/Dockerfile --target prod frontend/

      - name: Run Trivy vulnerability scanner (blocking)
        id: trivy-scan
        # Fail build on CRITICAL/HIGH vulnerabilities not in .trivyignore
        # Only run if build succeeded
        if: steps.build.outcome == 'success'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'frontend:${{ github.sha }}'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          trivyignores: '.trivyignore'

      - name: Run Trivy for SARIF upload
        # Run SARIF generation for GitHub Security tab if build succeeded
        # Runs even if blocking scan above failed (found vulnerabilities)
        if: always() && steps.build.outcome == 'success'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'frontend:${{ github.sha }}'
          format: 'sarif'
          output: 'trivy-frontend.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
          trivyignores: '.trivyignore'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always() && steps.build.outcome == 'success'
        with:
          sarif_file: 'trivy-frontend.sarif'

      - name: Create Linear issue on vulnerability found
        if: failure() && steps.trivy-scan.outcome == 'failure'
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        run: |
          curl -s -X POST https://api.linear.app/graphql \
            -H "Content-Type: application/json" \
            -H "Authorization: $LINEAR_API_KEY" \
            -d '{
              "query": "mutation CreateIssue($input: IssueCreateInput!) { issueCreate(input: $input) { success issue { id identifier url } } }",
              "variables": {
                "input": {
                  "teamId": "'"$LINEAR_TEAM_ID"'",
                  "title": "ðŸ”´ Trivy: Frontend container vulnerabilities detected",
                  "description": "## Security Alert\n\nTrivy detected **CRITICAL/HIGH** vulnerabilities in the frontend container image.\n\n### Details\n- **Commit:** `${{ github.sha }}`\n- **Branch:** `${{ github.ref_name }}`\n- **Workflow Run:** [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n- **Triggered by:** ${{ github.actor }}\n\n### Next Steps\n1. Review the Trivy scan output in the workflow logs\n2. Update vulnerable dependencies or add to `.trivyignore` if false positive\n3. Re-run the workflow to verify fix\n\n### References\n- [Trivy Documentation](https://aquasecurity.github.io/trivy/)\n- [.trivyignore file](https://github.com/${{ github.repository }}/blob/main/.trivyignore)",
                  "priority": 1,
                  "labelIds": []
                }
              }
            }'

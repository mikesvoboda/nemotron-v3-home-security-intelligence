name: Trivy Container Scan

on:
  push:
    branches: [main]
    paths:
      - '**/Dockerfile*'
      - 'backend/requirements.txt'
      - 'backend/requirements-prod.txt'
      - 'frontend/package.json'
  pull_request:
    branches: [main]
    paths:
      - '**/Dockerfile*'
      - 'backend/requirements.txt'
      - 'backend/requirements-prod.txt'
      - 'frontend/package.json'

permissions:
  contents: read
  security-events: write

jobs:
  scan-backend:
    name: Scan Backend Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free up disk space
        # Backend image includes heavy ML dependencies (PyTorch, transformers)
        # which require more disk space than default GitHub runners provide
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Build backend image
        id: build
        # Use production Dockerfile which has minimal dependencies
        # Context must be project root because Dockerfile.prod copies pyproject.toml/uv.lock from root
        run: docker build -t backend:${{ github.sha }} -f backend/Dockerfile.prod .

      - name: Run Trivy vulnerability scanner (blocking)
        # Fail build on CRITICAL/HIGH vulnerabilities not in .trivyignore
        # Only run if build succeeded
        if: steps.build.outcome == 'success'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'backend:${{ github.sha }}'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          trivyignores: '.trivyignore'

      - name: Run Trivy for SARIF upload
        # Run SARIF generation for GitHub Security tab if build succeeded
        # Runs even if blocking scan above failed (found vulnerabilities)
        if: always() && steps.build.outcome == 'success'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'backend:${{ github.sha }}'
          format: 'sarif'
          output: 'trivy-backend.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
          trivyignores: '.trivyignore'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always() && steps.build.outcome == 'success'
        with:
          sarif_file: 'trivy-backend.sarif'

  scan-frontend:
    name: Scan Frontend Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build frontend image
        id: build
        # Use production Dockerfile which has minimal dependencies
        run: docker build -t frontend:${{ github.sha }} -f frontend/Dockerfile.prod frontend/

      - name: Run Trivy vulnerability scanner (blocking)
        # Fail build on CRITICAL/HIGH vulnerabilities not in .trivyignore
        # Only run if build succeeded
        if: steps.build.outcome == 'success'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'frontend:${{ github.sha }}'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          trivyignores: '.trivyignore'

      - name: Run Trivy for SARIF upload
        # Run SARIF generation for GitHub Security tab if build succeeded
        # Runs even if blocking scan above failed (found vulnerabilities)
        if: always() && steps.build.outcome == 'success'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'frontend:${{ github.sha }}'
          format: 'sarif'
          output: 'trivy-frontend.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
          trivyignores: '.trivyignore'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always() && steps.build.outcome == 'success'
        with:
          sarif_file: 'trivy-frontend.sarif'

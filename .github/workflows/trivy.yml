name: Trivy Container Scan

on:
  push:
    branches: [main]
    paths:
      - "**/Dockerfile*"
      - "backend/requirements.txt"
      - "backend/requirements-prod.txt"
      - "frontend/package.json"
  pull_request:
    branches: [main]
    paths:
      - "**/Dockerfile*"
      - "backend/requirements.txt"
      - "backend/requirements-prod.txt"
      - "frontend/package.json"

permissions:
  contents: read
  security-events: write

jobs:
  scan-backend:
    name: Scan Backend Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build backend image
        # Use production Dockerfile which has minimal dependencies
        run: docker build -t backend:${{ github.sha }} -f backend/Dockerfile.prod backend/

      - name: Show Trivy vulnerabilities (table format)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "backend:${{ github.sha }}"
          format: "table"
          severity: "CRITICAL,HIGH"
          exit-code: "0"
          trivyignores: ".trivyignore"

      - name: Run Trivy vulnerability scanner
        # Note: exit-code: 0 because trivyignore only works properly with table format
        # SARIF results are still uploaded to GitHub Security tab for review
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "backend:${{ github.sha }}"
          format: "sarif"
          output: "trivy-backend.sarif"
          severity: "CRITICAL,HIGH"
          exit-code: "0"
          trivyignores: ".trivyignore"

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: "trivy-backend.sarif"

  scan-frontend:
    name: Scan Frontend Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build frontend image
        # Use production Dockerfile which has minimal dependencies
        run: docker build -t frontend:${{ github.sha }} -f frontend/Dockerfile.prod frontend/

      - name: Run Trivy vulnerability scanner
        # Note: exit-code: 0 because trivyignore only works properly with table format
        # SARIF results are still uploaded to GitHub Security tab for review
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "frontend:${{ github.sha }}"
          format: "sarif"
          output: "trivy-frontend.sarif"
          severity: "CRITICAL,HIGH"
          exit-code: "0"
          trivyignores: ".trivyignore"

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: "trivy-frontend.sarif"

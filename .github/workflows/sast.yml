name: SAST (Static Analysis)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  UV_VERSION: '0.9.18'

jobs:
  bandit:
    name: Bandit Python Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v4
        with:
          version: ${{ env.UV_VERSION }}
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.14

      - name: Run Bandit
        run: |
          uv tool run bandit -r backend/ \
            -c .bandit.yml \
            -b .bandit.baseline \
            -x "backend/tests/*" \
            -f json \
            -o bandit-report.json \
            --severity-level medium \
            || true

      - name: Check for high/critical issues
        run: |
          if [ -f bandit-report.json ]; then
            HIGH=$(cat bandit-report.json | python -c "import sys,json; r=json.load(sys.stdin); print(sum(1 for i in r.get('results',[]) if i['issue_severity'] in ['HIGH','CRITICAL']))")
            if [ "$HIGH" -gt 0 ]; then
              echo "Found $HIGH high/critical security issues"
              cat bandit-report.json | python -c "import sys,json; r=json.load(sys.stdin); [print(f\"{i['filename']}:{i['line_number']} - {i['issue_text']}\") for i in r.get('results',[]) if i['issue_severity'] in ['HIGH','CRITICAL']]"
              exit 1
            fi
          fi

  semgrep:
    name: Semgrep Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@713efdd345f3035192eaa63f56867b88e63e4e5d # v1
        with:
          config: >-
            p/python
            p/typescript
            p/react
            p/owasp-top-ten
            semgrep.yml

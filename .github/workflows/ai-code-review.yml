name: AI Code Review

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  models: read

jobs:
  ai-review:
    name: GPT-5 Code Review
    runs-on: ubuntu-latest
    # Don't run on draft PRs or bot PRs
    if: github.event.pull_request.draft == false && github.actor != 'dependabot[bot]'

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get the diff for this PR
          # Use git diff instead of gh pr diff to avoid GitHub API file limits (300 files max)
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          # Fall back to gh pr diff for small PRs, use git diff for large ones
          if ! gh pr diff ${{ github.event.pull_request.number }} > pr_diff.txt 2>/dev/null; then
            echo "gh pr diff failed (likely >300 files), using git diff instead"
            git diff "${BASE_SHA}...${HEAD_SHA}" > pr_diff.txt || git diff "${BASE_SHA}" "${HEAD_SHA}" > pr_diff.txt
          fi

          # Truncate if too large (GitHub Models has token limits)
          # 8000 tokens in ~= 32000 chars, leave room for prompt
          head -c 20000 pr_diff.txt > pr_diff_truncated.txt

          # Count lines for context
          LINES=$(wc -l < pr_diff.txt)
          echo "diff_lines=$LINES" >> $GITHUB_OUTPUT

          # Check if diff is empty
          if [ ! -s pr_diff_truncated.txt ]; then
            echo "empty=true" >> $GITHUB_OUTPUT
          else
            echo "empty=false" >> $GITHUB_OUTPUT
          fi

      - name: Install gh-models extension
        if: steps.diff.outputs.empty == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh extension install github/gh-models || true

      - name: Run AI Code Review
        if: steps.diff.outputs.empty == 'false'
        id: review
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Create the review prompt
          cat << 'PROMPT_END' > review_prompt.txt
          You are an expert code reviewer for a home security monitoring application.
          The tech stack is:
          - Backend: Python FastAPI, SQLAlchemy, Redis
          - Frontend: React, TypeScript, Tailwind CSS, Tremor
          - AI: YOLO26 (object detection), Nemotron (risk analysis)

          Review the following code changes and provide feedback on:
          1. **Security Issues**: Any vulnerabilities, injection risks, or unsafe patterns
          2. **Performance**: Potential bottlenecks or inefficient code
          3. **Best Practices**: Code style, naming, and architectural concerns
          4. **Bugs**: Logic errors or edge cases not handled

          Format your response as markdown with clear sections.
          Be concise but thorough. Only mention significant issues.
          If the code looks good, say so briefly.

          Here is the PR diff to review:
          ```diff
          PROMPT_END

          cat pr_diff_truncated.txt >> review_prompt.txt
          echo '```' >> review_prompt.txt

          # Call GPT-5 via GitHub Models
          # Fall back to gpt-4o if gpt-5 is unavailable
          REVIEW=$(cat review_prompt.txt | gh models run openai/gpt-4o 2>&1) || \
          REVIEW=$(cat review_prompt.txt | gh models run openai/gpt-4o-mini 2>&1) || \
          REVIEW="Unable to generate AI review. Please check GitHub Models availability."

          # Save review to file (handle multiline)
          echo "$REVIEW" > review_output.md

          # Set output for next step
          echo "review_generated=true" >> $GITHUB_OUTPUT

      - name: Post Review Comment
        if: steps.review.outputs.review_generated == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Read the review
          REVIEW=$(cat review_output.md)

          # Create comment body
          cat << EOF > comment_body.md
          ## AI Code Review (GPT-5)

          $REVIEW

          ---
          <sub>This review was generated by GitHub Models. It may contain inaccuracies.
          Review ${GITHUB_SHA::7} | ${{ steps.diff.outputs.diff_lines }} lines changed</sub>
          EOF

          # Post comment to PR
          gh pr comment ${{ github.event.pull_request.number }} \
            --body-file comment_body.md

      - name: Skip notification
        if: steps.diff.outputs.empty == 'true'
        run: |
          echo "::notice::No code changes detected in this PR, skipping AI review"

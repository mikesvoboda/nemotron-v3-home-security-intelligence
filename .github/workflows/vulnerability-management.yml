name: Vulnerability Management

# Daily dependency vulnerability scanning with automated issue creation
on:
  schedule:
    - cron: '0 8 * * *' # Daily at 8am UTC
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

env:
  LINEAR_TEAM_ID: '998946a2-aa75-491b-a39d-189660131392'

jobs:
  # =============================================================================
  # PYTHON DEPENDENCY AUDIT
  # =============================================================================
  python-audit:
    name: Python Dependency Audit
    runs-on: ubuntu-latest
    outputs:
      has_vulnerabilities: ${{ steps.check.outputs.has_vulnerabilities }}
      vulnerability_count: ${{ steps.check.outputs.vulnerability_count }}
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6
        with:
          python-version: '3.14'

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Install uv
        run: pip install uv

      - name: Run pip-audit
        id: audit
        continue-on-error: true
        run: |
          # Export dependencies from uv.lock to requirements format
          uv export --no-hashes > requirements-audit.txt

          # Run pip-audit and save output
          pip-audit -r requirements-audit.txt \
            --format json \
            --output pip-audit-results.json \
            --desc on \
            || true

          # Also output human-readable format
          pip-audit -r requirements-audit.txt --desc on || true

      - name: Check for vulnerabilities
        id: check
        run: |
          if [ -f pip-audit-results.json ]; then
            VULN_COUNT=$(cat pip-audit-results.json | python -c "import sys,json; data=json.load(sys.stdin); print(len(data.get('vulnerabilities', data if isinstance(data, list) else [])))")
            echo "vulnerability_count=$VULN_COUNT" >> $GITHUB_OUTPUT
            if [ "$VULN_COUNT" -gt 0 ]; then
              echo "has_vulnerabilities=true" >> $GITHUB_OUTPUT
            else
              echo "has_vulnerabilities=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "has_vulnerabilities=false" >> $GITHUB_OUTPUT
            echo "vulnerability_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Upload audit results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: python-audit-results
          path: pip-audit-results.json
          retention-days: 30

  # =============================================================================
  # NODE.JS DEPENDENCY AUDIT
  # =============================================================================
  nodejs-audit:
    name: Node.js Dependency Audit
    runs-on: ubuntu-latest
    outputs:
      has_vulnerabilities: ${{ steps.check.outputs.has_vulnerabilities }}
      vulnerability_count: ${{ steps.check.outputs.vulnerability_count }}
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v4
        with:
          node-version: '20'

      - name: Run npm audit
        id: audit
        continue-on-error: true
        working-directory: ./frontend
        run: |
          # Run npm audit and save output
          npm audit --json > npm-audit-results.json 2>/dev/null || true

          # Also output human-readable format
          npm audit || true

      - name: Check for vulnerabilities
        id: check
        working-directory: ./frontend
        run: |
          if [ -f npm-audit-results.json ]; then
            # Count high and critical vulnerabilities
            VULN_COUNT=$(cat npm-audit-results.json | python -c "
          import sys, json
          try:
              data = json.load(sys.stdin)
              metadata = data.get('metadata', {})
              vulns = metadata.get('vulnerabilities', {})
              # Count high + critical
              high = vulns.get('high', 0)
              critical = vulns.get('critical', 0)
              print(high + critical)
          except:
              print(0)
          ")
            echo "vulnerability_count=$VULN_COUNT" >> $GITHUB_OUTPUT
            if [ "$VULN_COUNT" -gt 0 ]; then
              echo "has_vulnerabilities=true" >> $GITHUB_OUTPUT
            else
              echo "has_vulnerabilities=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "has_vulnerabilities=false" >> $GITHUB_OUTPUT
            echo "vulnerability_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Upload audit results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: nodejs-audit-results
          path: frontend/npm-audit-results.json
          retention-days: 30

  # =============================================================================
  # CREATE ISSUES FOR VULNERABILITIES
  # =============================================================================
  create-issues:
    name: Create Linear Issues
    runs-on: ubuntu-latest
    needs: [python-audit, nodejs-audit]
    if: needs.python-audit.outputs.has_vulnerabilities == 'true' || needs.nodejs-audit.outputs.has_vulnerabilities == 'true'
    steps:
      - name: Create Python vulnerability issue
        if: needs.python-audit.outputs.has_vulnerabilities == 'true'
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
          VULN_COUNT: ${{ needs.python-audit.outputs.vulnerability_count }}
        run: |
          curl -s -X POST https://api.linear.app/graphql \
            -H "Content-Type: application/json" \
            -H "Authorization: $LINEAR_API_KEY" \
            -d '{
              "query": "mutation CreateIssue($input: IssueCreateInput!) { issueCreate(input: $input) { success issue { id identifier url } } }",
              "variables": {
                "input": {
                  "teamId": "'"$LINEAR_TEAM_ID"'",
                  "title": "Security: '"$VULN_COUNT"' Python dependency vulnerabilities found",
                  "description": "## Vulnerability Scan Results\n\n**pip-audit** detected **'"$VULN_COUNT"'** vulnerabilities in Python dependencies.\n\n### SLA\n- Critical: 24 hours\n- High: 7 days\n- Medium: 30 days\n- Low: 90 days\n\n### Next Steps\n1. Review the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n2. Download the audit artifact for details\n3. Update vulnerable packages with `uv add <package>@latest`\n4. Run `uv lock` to update lockfile\n5. Test and verify fixes\n\n### Resources\n- [pip-audit documentation](https://pypi.org/project/pip-audit/)\n- [GitHub Advisory Database](https://github.com/advisories)",
                  "priority": 2,
                  "labelIds": []
                }
              }
            }'

      - name: Create Node.js vulnerability issue
        if: needs.nodejs-audit.outputs.has_vulnerabilities == 'true'
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
          VULN_COUNT: ${{ needs.nodejs-audit.outputs.vulnerability_count }}
        run: |
          curl -s -X POST https://api.linear.app/graphql \
            -H "Content-Type: application/json" \
            -H "Authorization: $LINEAR_API_KEY" \
            -d '{
              "query": "mutation CreateIssue($input: IssueCreateInput!) { issueCreate(input: $input) { success issue { id identifier url } } }",
              "variables": {
                "input": {
                  "teamId": "'"$LINEAR_TEAM_ID"'",
                  "title": "Security: '"$VULN_COUNT"' Node.js HIGH/CRITICAL vulnerabilities found",
                  "description": "## Vulnerability Scan Results\n\n**npm audit** detected **'"$VULN_COUNT"'** HIGH or CRITICAL vulnerabilities in Node.js dependencies.\n\n### SLA\n- Critical: 24 hours\n- High: 7 days\n\n### Next Steps\n1. Review the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n2. Download the audit artifact for details\n3. Run `npm audit fix` for automatic fixes\n4. For breaking changes: `npm audit fix --force` (test thoroughly)\n5. Manual updates may be needed for some packages\n\n### Resources\n- [npm audit documentation](https://docs.npmjs.com/cli/v10/commands/npm-audit)\n- [GitHub Advisory Database](https://github.com/advisories)",
                  "priority": 1,
                  "labelIds": []
                }
              }
            }'

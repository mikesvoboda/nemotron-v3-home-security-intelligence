name: Dependency Audit

on:
  push:
    branches: [main]
    paths:
      - 'pyproject.toml'
      - 'uv.lock'
      - 'frontend/package.json'
      - 'frontend/package-lock.json'
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 6 * * 1' # Weekly on Monday at 6 AM UTC

env:
  PYTHON_VERSION: '3.14'
  NODE_VERSION: '20'
  UV_VERSION: '0.9.18'

jobs:
  python-audit:
    name: Python Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up uv
        uses: astral-sh/setup-uv@e4db8464a088ece1b920f60402e813ea4de65b8f # v4
        with:
          version: ${{ env.UV_VERSION }}
          enable-cache: true

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install pip-audit
        run: uv tool install pip-audit

      - name: Run pip-audit on dependencies
        run: |
          # Export dependencies to requirements format for pip-audit
          uv export --no-hashes > requirements-audit.txt
          # Remove torch packages with +cpu suffix (from PyTorch custom index, not on PyPI)
          # These packages are audited separately via their official security advisories
          grep -v '+cpu' requirements-audit.txt > requirements-audit-filtered.txt || true
          # Run pip-audit with ignored CVEs
          # CVE-2026-0994: protobuf DoS in json_format.ParseDict() with nested Any messages
          #   - Severity: Moderate (DoS only, no data breach/RCE)
          #   - Impact: We don't use ParseDict() with untrusted nested Any messages
          #   - Status: Awaiting upstream fix from google/protobuf
          #   - Review date: 2026-01-23
          pip-audit -r requirements-audit-filtered.txt --desc \
            --ignore-vuln CVE-2026-0994
        continue-on-error: false

  npm-audit:
    name: NPM Dependency Audit
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit for high severity vulnerabilities
        run: npm audit --audit-level=high
        continue-on-error: false

  audit-summary:
    name: Audit Summary
    runs-on: ubuntu-latest
    needs: [python-audit, npm-audit]
    if: always()
    steps:
      - name: Generate audit summary
        run: |
          echo "## Dependency Audit Summary - $(date +'%Y-%m-%d')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "| Scan | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Python Audit | ${{ needs.python-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| NPM Audit | ${{ needs.npm-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if ${{ needs.python-audit.result != 'success' || needs.npm-audit.result != 'success' }}; then
            echo "### Action Required" >> $GITHUB_STEP_SUMMARY
            echo "Dependency vulnerabilities detected. Review the job logs above for details and update dependencies." >> $GITHUB_STEP_SUMMARY
          fi

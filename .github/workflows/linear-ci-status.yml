name: Linear CI Status Sync

# This workflow automatically updates Linear issue status based on CI/CD events.
# - When a PR passes all CI checks -> Move linked issue to "In Review"
# - When a PR is merged to main -> Move linked issue to "Done"
# - When CI fails on a PR -> Add a comment to the Linear issue
# - When CI fails on main branch -> Create a new Linear issue to track the failure

on:
  # Triggered when CI workflow completes on a PR
  workflow_run:
    workflows: ['CI']
    types: [completed]

  # Triggered when a PR is merged to main
  push:
    branches: [main]

  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to process (optional)'
        required: false
        type: string
      action:
        description: 'Action to perform'
        required: true
        default: 'check'
        type: choice
        options:
          - check
          - move-to-review
          - move-to-done

concurrency:
  group: linear-ci-status-${{ github.event.workflow_run.head_sha || github.sha }}
  cancel-in-progress: false

env:
  # Linear team ID for NEM team
  LINEAR_TEAM_ID: '998946a2-aa75-491b-a39d-189660131392'
  # Linear workflow state UUIDs
  LINEAR_STATE_TODO: '50ef9730-7d5e-43d6-b5e0-d7cac07af58f'
  LINEAR_STATE_IN_PROGRESS: 'b88c8ae2-2545-4c1b-b83a-bf2dde2c03e7'
  LINEAR_STATE_IN_REVIEW: 'ec90a3c4-c160-44fc-aa7e-82bdca77aa46'
  LINEAR_STATE_DONE: '38267c1e-4458-4875-aa66-4b56381786e9'

jobs:
  # Handle CI completion on PRs
  ci-completion:
    name: Update Linear on CI Completion
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run' && github.event.workflow_run.event == 'pull_request'
    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Get PR information
        id: pr-info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get PR number from workflow_run event
          # The head_sha is the commit SHA that triggered the workflow
          HEAD_SHA="${{ github.event.workflow_run.head_sha }}"
          REPO="${{ github.repository }}"

          echo "Looking for PR with head SHA: $HEAD_SHA"

          # Find the PR associated with this commit
          PR_DATA=$(gh api "repos/$REPO/commits/$HEAD_SHA/pulls" --jq '.[0] | {number: .number, title: .title, head_ref: .head.ref, merged: .merged}' || echo "{}")

          if [ -z "$PR_DATA" ] || [ "$PR_DATA" = "{}" ]; then
            echo "No PR found for commit $HEAD_SHA"
            echo "found=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          PR_NUMBER=$(echo "$PR_DATA" | jq -r '.number // empty')
          PR_TITLE=$(echo "$PR_DATA" | jq -r '.title // empty')
          PR_BRANCH=$(echo "$PR_DATA" | jq -r '.head_ref // empty')

          echo "Found PR #$PR_NUMBER: $PR_TITLE (branch: $PR_BRANCH)"
          echo "found=true" >> "$GITHUB_OUTPUT"
          echo "number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "title=$PR_TITLE" >> "$GITHUB_OUTPUT"
          echo "branch=$PR_BRANCH" >> "$GITHUB_OUTPUT"

      - name: Extract Linear issue IDs
        id: extract-issues
        if: steps.pr-info.outputs.found == 'true'
        run: |
          PR_TITLE="${{ steps.pr-info.outputs.title }}"
          PR_BRANCH="${{ steps.pr-info.outputs.branch }}"

          # Extract issue IDs from PR title and branch name
          # Patterns: NEM-123, nem-123, NEM_123
          ISSUE_IDS=""

          # Extract from title (case-insensitive)
          TITLE_MATCHES=$(echo "$PR_TITLE" | grep -oiE 'NEM[_-][0-9]+' | tr '[:lower:]' '[:upper:]' | tr '_' '-' | sort -u || true)
          if [ -n "$TITLE_MATCHES" ]; then
            ISSUE_IDS="$TITLE_MATCHES"
          fi

          # Extract from branch (case-insensitive)
          BRANCH_MATCHES=$(echo "$PR_BRANCH" | grep -oiE 'NEM[_-][0-9]+' | tr '[:lower:]' '[:upper:]' | tr '_' '-' | sort -u || true)
          if [ -n "$BRANCH_MATCHES" ]; then
            ISSUE_IDS="$ISSUE_IDS $BRANCH_MATCHES"
          fi

          # Remove duplicates and format as comma-separated list
          UNIQUE_IDS=$(echo "$ISSUE_IDS" | tr ' ' '\n' | sort -u | tr '\n' ',' | sed 's/,$//')

          if [ -z "$UNIQUE_IDS" ]; then
            echo "No Linear issue IDs found in PR title or branch"
            echo "found=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Found Linear issue IDs: $UNIQUE_IDS"
          echo "found=true" >> "$GITHUB_OUTPUT"
          echo "ids=$UNIQUE_IDS" >> "$GITHUB_OUTPUT"

      - name: Update Linear issues on CI success
        if: steps.extract-issues.outputs.found == 'true' && github.event.workflow_run.conclusion == 'success'
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        run: |
          ISSUE_IDS="${{ steps.extract-issues.outputs.ids }}"
          PR_NUMBER="${{ steps.pr-info.outputs.number }}"
          PR_TITLE="${{ steps.pr-info.outputs.title }}"

          echo "CI passed - Moving issues to 'In Review': $ISSUE_IDS"

          # Process each issue ID
          IFS=',' read -ra IDS <<< "$ISSUE_IDS"
          for ISSUE_ID in "${IDS[@]}"; do
            echo "Processing $ISSUE_ID..."

            # First, get the issue UUID from the identifier
            ISSUE_UUID=$(curl -s -X POST https://api.linear.app/graphql \
              -H "Content-Type: application/json" \
              -H "Authorization: $LINEAR_API_KEY" \
              -d '{
                "query": "query GetIssue($id: String!) { issue(id: $id) { id identifier state { id name } } }",
                "variables": { "id": "'"$ISSUE_ID"'" }
              }' | jq -r '.data.issue.id // empty')

            if [ -z "$ISSUE_UUID" ]; then
              echo "Warning: Could not find issue $ISSUE_ID"
              continue
            fi

            # Get current state
            CURRENT_STATE=$(curl -s -X POST https://api.linear.app/graphql \
              -H "Content-Type: application/json" \
              -H "Authorization: $LINEAR_API_KEY" \
              -d '{
                "query": "query GetIssue($id: String!) { issue(id: $id) { state { name } } }",
                "variables": { "id": "'"$ISSUE_ID"'" }
              }' | jq -r '.data.issue.state.name // empty')

            echo "Issue $ISSUE_ID is currently in state: $CURRENT_STATE"

            # Only move to "In Review" if currently "In Progress" or "Todo"
            if [ "$CURRENT_STATE" = "In Progress" ] || [ "$CURRENT_STATE" = "Todo" ]; then
              echo "Moving $ISSUE_ID to 'In Review'..."

              RESULT=$(curl -s -X POST https://api.linear.app/graphql \
                -H "Content-Type: application/json" \
                -H "Authorization: $LINEAR_API_KEY" \
                -d '{
                  "query": "mutation UpdateIssue($id: String!, $input: IssueUpdateInput!) { issueUpdate(id: $id, input: $input) { success issue { identifier state { name } } } }",
                  "variables": {
                    "id": "'"$ISSUE_UUID"'",
                    "input": { "stateId": "'"$LINEAR_STATE_IN_REVIEW"'" }
                  }
                }')

              SUCCESS=$(echo "$RESULT" | jq -r '.data.issueUpdate.success // false')
              if [ "$SUCCESS" = "true" ]; then
                echo "Successfully moved $ISSUE_ID to 'In Review'"
              else
                echo "Warning: Failed to update $ISSUE_ID: $RESULT"
              fi
            else
              echo "Skipping $ISSUE_ID - already in state: $CURRENT_STATE"
            fi
          done

      - name: Comment on Linear issues on CI failure
        if: steps.extract-issues.outputs.found == 'true' && github.event.workflow_run.conclusion == 'failure'
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        run: |
          ISSUE_IDS="${{ steps.extract-issues.outputs.ids }}"
          PR_NUMBER="${{ steps.pr-info.outputs.number }}"
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}"

          echo "CI failed - Adding comment to issues: $ISSUE_IDS"

          # Process each issue ID
          IFS=',' read -ra IDS <<< "$ISSUE_IDS"
          for ISSUE_ID in "${IDS[@]}"; do
            echo "Adding failure comment to $ISSUE_ID..."

            # Get the issue UUID
            ISSUE_UUID=$(curl -s -X POST https://api.linear.app/graphql \
              -H "Content-Type: application/json" \
              -H "Authorization: $LINEAR_API_KEY" \
              -d '{
                "query": "query GetIssue($id: String!) { issue(id: $id) { id } }",
                "variables": { "id": "'"$ISSUE_ID"'" }
              }' | jq -r '.data.issue.id // empty')

            if [ -z "$ISSUE_UUID" ]; then
              echo "Warning: Could not find issue $ISSUE_ID"
              continue
            fi

            # Add a comment about CI failure
            COMMENT="**CI Failed** on PR #$PR_NUMBER\n\n[View workflow run]($WORKFLOW_URL)\n\nThe CI checks failed. Please review the logs and fix any issues before the PR can be merged."

            curl -s -X POST https://api.linear.app/graphql \
              -H "Content-Type: application/json" \
              -H "Authorization: $LINEAR_API_KEY" \
              -d '{
                "query": "mutation CreateComment($input: CommentCreateInput!) { commentCreate(input: $input) { success } }",
                "variables": {
                  "input": {
                    "issueId": "'"$ISSUE_UUID"'",
                    "body": "'"$COMMENT"'"
                  }
                }
              }'

            echo "Added CI failure comment to $ISSUE_ID"
          done

  # Handle PR merge to main
  pr-merged:
    name: Update Linear on PR Merge
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Get merged PR information
        id: merged-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the commit message to find the PR number
          # GitHub merge commits include "Merge pull request #123" or "(#123)"
          COMMIT_MESSAGE=$(gh api "repos/${{ github.repository }}/commits/${{ github.sha }}" --jq '.commit.message')

          echo "Commit message: $COMMIT_MESSAGE"

          # Extract PR number from merge commit message
          PR_NUMBER=$(echo "$COMMIT_MESSAGE" | grep -oE '#[0-9]+' | head -1 | tr -d '#')

          if [ -z "$PR_NUMBER" ]; then
            echo "No PR number found in commit message"
            echo "found=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Found PR #$PR_NUMBER from merge commit"

          # Get PR details
          PR_DATA=$(gh api "repos/${{ github.repository }}/pulls/$PR_NUMBER" --jq '{title: .title, head_ref: .head.ref}' || echo "{}")

          if [ -z "$PR_DATA" ] || [ "$PR_DATA" = "{}" ]; then
            echo "Could not get PR details"
            echo "found=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          PR_TITLE=$(echo "$PR_DATA" | jq -r '.title // empty')
          PR_BRANCH=$(echo "$PR_DATA" | jq -r '.head_ref // empty')

          echo "PR Title: $PR_TITLE"
          echo "PR Branch: $PR_BRANCH"

          echo "found=true" >> "$GITHUB_OUTPUT"
          echo "number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "title=$PR_TITLE" >> "$GITHUB_OUTPUT"
          echo "branch=$PR_BRANCH" >> "$GITHUB_OUTPUT"

      - name: Extract Linear issue IDs
        id: extract-issues
        if: steps.merged-pr.outputs.found == 'true'
        run: |
          PR_TITLE="${{ steps.merged-pr.outputs.title }}"
          PR_BRANCH="${{ steps.merged-pr.outputs.branch }}"

          # Extract issue IDs from PR title and branch name
          ISSUE_IDS=""

          # Extract from title (case-insensitive)
          TITLE_MATCHES=$(echo "$PR_TITLE" | grep -oiE 'NEM[_-][0-9]+' | tr '[:lower:]' '[:upper:]' | tr '_' '-' | sort -u || true)
          if [ -n "$TITLE_MATCHES" ]; then
            ISSUE_IDS="$TITLE_MATCHES"
          fi

          # Extract from branch (case-insensitive)
          BRANCH_MATCHES=$(echo "$PR_BRANCH" | grep -oiE 'NEM[_-][0-9]+' | tr '[:lower:]' '[:upper:]' | tr '_' '-' | sort -u || true)
          if [ -n "$BRANCH_MATCHES" ]; then
            ISSUE_IDS="$ISSUE_IDS $BRANCH_MATCHES"
          fi

          # Remove duplicates and format as comma-separated list
          UNIQUE_IDS=$(echo "$ISSUE_IDS" | tr ' ' '\n' | sort -u | tr '\n' ',' | sed 's/,$//')

          if [ -z "$UNIQUE_IDS" ]; then
            echo "No Linear issue IDs found in PR title or branch"
            echo "found=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Found Linear issue IDs: $UNIQUE_IDS"
          echo "found=true" >> "$GITHUB_OUTPUT"
          echo "ids=$UNIQUE_IDS" >> "$GITHUB_OUTPUT"

      - name: Move Linear issues to Done
        if: steps.extract-issues.outputs.found == 'true'
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        run: |
          ISSUE_IDS="${{ steps.extract-issues.outputs.ids }}"
          PR_NUMBER="${{ steps.merged-pr.outputs.number }}"

          echo "PR #$PR_NUMBER merged - Moving issues to 'Done': $ISSUE_IDS"

          # Process each issue ID
          IFS=',' read -ra IDS <<< "$ISSUE_IDS"
          for ISSUE_ID in "${IDS[@]}"; do
            echo "Processing $ISSUE_ID..."

            # Get the issue UUID and current state
            ISSUE_DATA=$(curl -s -X POST https://api.linear.app/graphql \
              -H "Content-Type: application/json" \
              -H "Authorization: $LINEAR_API_KEY" \
              -d '{
                "query": "query GetIssue($id: String!) { issue(id: $id) { id identifier state { id name } } }",
                "variables": { "id": "'"$ISSUE_ID"'" }
              }')

            ISSUE_UUID=$(echo "$ISSUE_DATA" | jq -r '.data.issue.id // empty')
            CURRENT_STATE=$(echo "$ISSUE_DATA" | jq -r '.data.issue.state.name // empty')

            if [ -z "$ISSUE_UUID" ]; then
              echo "Warning: Could not find issue $ISSUE_ID"
              continue
            fi

            echo "Issue $ISSUE_ID is currently in state: $CURRENT_STATE"

            # Only move to "Done" if not already Done or Canceled
            if [ "$CURRENT_STATE" != "Done" ] && [ "$CURRENT_STATE" != "Canceled" ] && [ "$CURRENT_STATE" != "Duplicate" ]; then
              echo "Moving $ISSUE_ID to 'Done'..."

              RESULT=$(curl -s -X POST https://api.linear.app/graphql \
                -H "Content-Type: application/json" \
                -H "Authorization: $LINEAR_API_KEY" \
                -d '{
                  "query": "mutation UpdateIssue($id: String!, $input: IssueUpdateInput!) { issueUpdate(id: $id, input: $input) { success issue { identifier state { name } } } }",
                  "variables": {
                    "id": "'"$ISSUE_UUID"'",
                    "input": { "stateId": "'"$LINEAR_STATE_DONE"'" }
                  }
                }')

              SUCCESS=$(echo "$RESULT" | jq -r '.data.issueUpdate.success // false')
              if [ "$SUCCESS" = "true" ]; then
                echo "Successfully moved $ISSUE_ID to 'Done'"
              else
                echo "Warning: Failed to update $ISSUE_ID: $RESULT"
              fi
            else
              echo "Skipping $ISSUE_ID - already in terminal state: $CURRENT_STATE"
            fi
          done

  # Handle CI failures on main branch - create Linear issue
  main-branch-failure:
    name: Create Linear Issue on Main CI Failure
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_run' &&
      github.event.workflow_run.head_branch == 'main' &&
      github.event.workflow_run.conclusion == 'failure'
    permissions:
      contents: read
      actions: read

    steps:
      - name: Get failed jobs information
        id: failed-jobs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          WORKFLOW_RUN_ID="${{ github.event.workflow_run.id }}"
          REPO="${{ github.repository }}"

          echo "Fetching failed jobs for workflow run $WORKFLOW_RUN_ID..."

          # Get all jobs from the workflow run
          JOBS_DATA=$(gh api "repos/$REPO/actions/runs/$WORKFLOW_RUN_ID/jobs" --jq '.jobs')

          # Extract failed job names
          FAILED_JOBS=$(echo "$JOBS_DATA" | jq -r '[.[] | select(.conclusion == "failure") | .name] | join(", ")')

          if [ -z "$FAILED_JOBS" ]; then
            echo "No failed jobs found"
            echo "has_failures=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Failed jobs: $FAILED_JOBS"
          echo "has_failures=true" >> "$GITHUB_OUTPUT"
          echo "failed_jobs=$FAILED_JOBS" >> "$GITHUB_OUTPUT"

          # Get the first failed job's URL for detailed link
          FIRST_FAILED_JOB_URL=$(echo "$JOBS_DATA" | jq -r '[.[] | select(.conclusion == "failure")][0].html_url // empty')
          echo "job_url=$FIRST_FAILED_JOB_URL" >> "$GITHUB_OUTPUT"

      - name: Check for existing open CI failure issue
        id: check-existing
        if: steps.failed-jobs.outputs.has_failures == 'true'
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        run: |
          # Search for existing open CI failure issues to avoid duplicates
          SEARCH_RESULT=$(curl -s -X POST https://api.linear.app/graphql \
            -H "Content-Type: application/json" \
            -H "Authorization: $LINEAR_API_KEY" \
            -d '{
              "query": "query SearchIssues($filter: IssueFilter) { issues(filter: $filter) { nodes { id identifier title state { name } } } }",
              "variables": {
                "filter": {
                  "team": { "key": { "eq": "NEM" } },
                  "title": { "contains": "[CI] Main branch" },
                  "state": { "type": { "nin": ["completed", "canceled"] } }
                }
              }
            }')

          EXISTING_ISSUE=$(echo "$SEARCH_RESULT" | jq -r '.data.issues.nodes[0].identifier // empty')

          if [ -n "$EXISTING_ISSUE" ]; then
            echo "Found existing open CI failure issue: $EXISTING_ISSUE"
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "issue_id=$EXISTING_ISSUE" >> "$GITHUB_OUTPUT"
            ISSUE_UUID=$(echo "$SEARCH_RESULT" | jq -r '.data.issues.nodes[0].id')
            echo "issue_uuid=$ISSUE_UUID" >> "$GITHUB_OUTPUT"
          else
            echo "No existing open CI failure issue found"
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Update existing issue with new failure
        if: steps.failed-jobs.outputs.has_failures == 'true' && steps.check-existing.outputs.exists == 'true'
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        run: |
          ISSUE_UUID="${{ steps.check-existing.outputs.issue_uuid }}"
          ISSUE_ID="${{ steps.check-existing.outputs.issue_id }}"
          FAILED_JOBS="${{ steps.failed-jobs.outputs.failed_jobs }}"
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}"
          COMMIT_SHA="${{ github.event.workflow_run.head_sha }}"
          COMMIT_SHORT="${COMMIT_SHA:0:7}"

          echo "Adding comment to existing issue $ISSUE_ID..."

          COMMENT="**New CI Failure** on main branch\n\n**Commit:** [\`$COMMIT_SHORT\`](https://github.com/${{ github.repository }}/commit/$COMMIT_SHA)\n**Failed Jobs:** $FAILED_JOBS\n**Workflow Run:** [View logs]($WORKFLOW_URL)\n**Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

          curl -s -X POST https://api.linear.app/graphql \
            -H "Content-Type: application/json" \
            -H "Authorization: $LINEAR_API_KEY" \
            -d '{
              "query": "mutation CreateComment($input: CommentCreateInput!) { commentCreate(input: $input) { success } }",
              "variables": {
                "input": {
                  "issueId": "'"$ISSUE_UUID"'",
                  "body": "'"$COMMENT"'"
                }
              }
            }'

          echo "Added failure comment to $ISSUE_ID"

      - name: Create new Linear issue for CI failure
        if: steps.failed-jobs.outputs.has_failures == 'true' && steps.check-existing.outputs.exists == 'false'
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        run: |
          FAILED_JOBS="${{ steps.failed-jobs.outputs.failed_jobs }}"
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}"
          JOB_URL="${{ steps.failed-jobs.outputs.job_url }}"
          COMMIT_SHA="${{ github.event.workflow_run.head_sha }}"
          COMMIT_SHORT="${COMMIT_SHA:0:7}"
          COMMIT_MSG="${{ github.event.workflow_run.display_title }}"

          echo "Creating new Linear issue for CI failure..."

          # Create issue title
          TITLE="[CI] Main branch failing: $FAILED_JOBS"

          # Truncate title if too long (Linear has a limit)
          if [ ${#TITLE} -gt 200 ]; then
            TITLE="${TITLE:0:197}..."
          fi

          # Create issue description
          DESCRIPTION="## CI Failure on Main Branch\n\n**Status:** ðŸ”´ Blocking container publish to GHCR\n\n### Details\n\n| Field | Value |\n|-------|-------|\n| **Failed Jobs** | $FAILED_JOBS |\n| **Commit** | [\`$COMMIT_SHORT\`](https://github.com/${{ github.repository }}/commit/$COMMIT_SHA) |\n| **Commit Message** | $COMMIT_MSG |\n| **Workflow Run** | [View logs]($WORKFLOW_URL) |\n| **Detected** | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |\n\n### Impact\n\n- Container images are not being published to GHCR\n- Deployments are blocked until this is resolved\n\n### Resolution\n\nFix the failing CI job(s) and merge to main. This issue will be automatically closed when CI passes.\n\n---\n*Auto-generated by Linear CI Status Sync*"

          # Create the issue via Linear API
          RESULT=$(curl -s -X POST https://api.linear.app/graphql \
            -H "Content-Type: application/json" \
            -H "Authorization: $LINEAR_API_KEY" \
            -d '{
              "query": "mutation CreateIssue($input: IssueCreateInput!) { issueCreate(input: $input) { success issue { identifier url } } }",
              "variables": {
                "input": {
                  "teamId": "'"$LINEAR_TEAM_ID"'",
                  "title": "'"$TITLE"'",
                  "description": "'"$DESCRIPTION"'",
                  "priority": 1,
                  "labelIds": []
                }
              }
            }')

          SUCCESS=$(echo "$RESULT" | jq -r '.data.issueCreate.success // false')
          ISSUE_ID=$(echo "$RESULT" | jq -r '.data.issueCreate.issue.identifier // empty')
          ISSUE_URL=$(echo "$RESULT" | jq -r '.data.issueCreate.issue.url // empty')

          if [ "$SUCCESS" = "true" ]; then
            echo "âœ… Created Linear issue: $ISSUE_ID"
            echo "   URL: $ISSUE_URL"
          else
            echo "âŒ Failed to create Linear issue"
            echo "Response: $RESULT"
            exit 1
          fi

  # Handle CI success on main branch - close any open CI failure issues
  main-branch-success:
    name: Close Linear Issue on Main CI Success
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_run' &&
      github.event.workflow_run.head_branch == 'main' &&
      github.event.workflow_run.conclusion == 'success'
    permissions:
      contents: read

    steps:
      - name: Find and close open CI failure issues
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        run: |
          echo "CI passed on main - checking for open CI failure issues to close..."

          # Search for open CI failure issues
          SEARCH_RESULT=$(curl -s -X POST https://api.linear.app/graphql \
            -H "Content-Type: application/json" \
            -H "Authorization: $LINEAR_API_KEY" \
            -d '{
              "query": "query SearchIssues($filter: IssueFilter) { issues(filter: $filter) { nodes { id identifier title } } }",
              "variables": {
                "filter": {
                  "team": { "key": { "eq": "NEM" } },
                  "title": { "contains": "[CI] Main branch" },
                  "state": { "type": { "nin": ["completed", "canceled"] } }
                }
              }
            }')

          ISSUES=$(echo "$SEARCH_RESULT" | jq -r '.data.issues.nodes')
          ISSUE_COUNT=$(echo "$ISSUES" | jq 'length')

          if [ "$ISSUE_COUNT" = "0" ]; then
            echo "No open CI failure issues found"
            exit 0
          fi

          echo "Found $ISSUE_COUNT open CI failure issue(s) to close"

          # Close each issue
          echo "$ISSUES" | jq -c '.[]' | while read -r issue; do
            ISSUE_UUID=$(echo "$issue" | jq -r '.id')
            ISSUE_ID=$(echo "$issue" | jq -r '.identifier')

            echo "Closing $ISSUE_ID..."

            # Add a comment before closing
            WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}"
            COMMENT="**CI Passed** âœ…\n\nMain branch CI is now passing. Closing this issue.\n\n[View successful workflow run]($WORKFLOW_URL)"

            curl -s -X POST https://api.linear.app/graphql \
              -H "Content-Type: application/json" \
              -H "Authorization: $LINEAR_API_KEY" \
              -d '{
                "query": "mutation CreateComment($input: CommentCreateInput!) { commentCreate(input: $input) { success } }",
                "variables": {
                  "input": {
                    "issueId": "'"$ISSUE_UUID"'",
                    "body": "'"$COMMENT"'"
                  }
                }
              }'

            # Move to Done state
            RESULT=$(curl -s -X POST https://api.linear.app/graphql \
              -H "Content-Type: application/json" \
              -H "Authorization: $LINEAR_API_KEY" \
              -d '{
                "query": "mutation UpdateIssue($id: String!, $input: IssueUpdateInput!) { issueUpdate(id: $id, input: $input) { success } }",
                "variables": {
                  "id": "'"$ISSUE_UUID"'",
                  "input": { "stateId": "'"$LINEAR_STATE_DONE"'" }
                }
              }')

            SUCCESS=$(echo "$RESULT" | jq -r '.data.issueUpdate.success // false')
            if [ "$SUCCESS" = "true" ]; then
              echo "âœ… Closed $ISSUE_ID"
            else
              echo "âš ï¸ Failed to close $ISSUE_ID"
            fi
          done

  # Manual trigger handler
  manual-trigger:
    name: Manual Linear Update
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Get PR information
        id: pr-info
        if: github.event.inputs.pr_number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.inputs.pr_number }}
        run: |
          # PR_NUMBER is set via env to avoid shell injection

          PR_DATA=$(gh api "repos/${{ github.repository }}/pulls/$PR_NUMBER" --jq '{title: .title, head_ref: .head.ref, state: .state, merged: .merged}' || echo "{}")

          if [ -z "$PR_DATA" ] || [ "$PR_DATA" = "{}" ]; then
            echo "Could not find PR #$PR_NUMBER"
            echo "found=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          PR_TITLE=$(echo "$PR_DATA" | jq -r '.title // empty')
          PR_BRANCH=$(echo "$PR_DATA" | jq -r '.head_ref // empty')

          echo "Found PR #$PR_NUMBER: $PR_TITLE"
          echo "found=true" >> "$GITHUB_OUTPUT"
          echo "number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "title=$PR_TITLE" >> "$GITHUB_OUTPUT"
          echo "branch=$PR_BRANCH" >> "$GITHUB_OUTPUT"

      - name: Extract Linear issue IDs
        id: extract-issues
        if: steps.pr-info.outputs.found == 'true'
        run: |
          PR_TITLE="${{ steps.pr-info.outputs.title }}"
          PR_BRANCH="${{ steps.pr-info.outputs.branch }}"

          # Extract issue IDs from PR title and branch name
          ISSUE_IDS=""

          TITLE_MATCHES=$(echo "$PR_TITLE" | grep -oiE 'NEM[_-][0-9]+' | tr '[:lower:]' '[:upper:]' | tr '_' '-' | sort -u || true)
          if [ -n "$TITLE_MATCHES" ]; then
            ISSUE_IDS="$TITLE_MATCHES"
          fi

          BRANCH_MATCHES=$(echo "$PR_BRANCH" | grep -oiE 'NEM[_-][0-9]+' | tr '[:lower:]' '[:upper:]' | tr '_' '-' | sort -u || true)
          if [ -n "$BRANCH_MATCHES" ]; then
            ISSUE_IDS="$ISSUE_IDS $BRANCH_MATCHES"
          fi

          UNIQUE_IDS=$(echo "$ISSUE_IDS" | tr ' ' '\n' | sort -u | tr '\n' ',' | sed 's/,$//')

          if [ -z "$UNIQUE_IDS" ]; then
            echo "No Linear issue IDs found"
            echo "found=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Found Linear issue IDs: $UNIQUE_IDS"
          echo "found=true" >> "$GITHUB_OUTPUT"
          echo "ids=$UNIQUE_IDS" >> "$GITHUB_OUTPUT"

      - name: Check current status
        if: github.event.inputs.action == 'check' && steps.extract-issues.outputs.found == 'true'
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        run: |
          ISSUE_IDS="${{ steps.extract-issues.outputs.ids }}"

          echo "Checking status of issues: $ISSUE_IDS"

          IFS=',' read -ra IDS <<< "$ISSUE_IDS"
          for ISSUE_ID in "${IDS[@]}"; do
            ISSUE_DATA=$(curl -s -X POST https://api.linear.app/graphql \
              -H "Content-Type: application/json" \
              -H "Authorization: $LINEAR_API_KEY" \
              -d '{
                "query": "query GetIssue($id: String!) { issue(id: $id) { identifier title state { name } url } }",
                "variables": { "id": "'"$ISSUE_ID"'" }
              }')

            IDENTIFIER=$(echo "$ISSUE_DATA" | jq -r '.data.issue.identifier // "Not found"')
            TITLE=$(echo "$ISSUE_DATA" | jq -r '.data.issue.title // "N/A"')
            STATE=$(echo "$ISSUE_DATA" | jq -r '.data.issue.state.name // "N/A"')
            URL=$(echo "$ISSUE_DATA" | jq -r '.data.issue.url // "N/A"')

            echo "---"
            echo "Issue: $IDENTIFIER"
            echo "Title: $TITLE"
            echo "State: $STATE"
            echo "URL: $URL"
          done

      - name: Move to In Review
        if: github.event.inputs.action == 'move-to-review' && steps.extract-issues.outputs.found == 'true'
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        run: |
          ISSUE_IDS="${{ steps.extract-issues.outputs.ids }}"

          echo "Moving issues to 'In Review': $ISSUE_IDS"

          IFS=',' read -ra IDS <<< "$ISSUE_IDS"
          for ISSUE_ID in "${IDS[@]}"; do
            ISSUE_UUID=$(curl -s -X POST https://api.linear.app/graphql \
              -H "Content-Type: application/json" \
              -H "Authorization: $LINEAR_API_KEY" \
              -d '{
                "query": "query GetIssue($id: String!) { issue(id: $id) { id } }",
                "variables": { "id": "'"$ISSUE_ID"'" }
              }' | jq -r '.data.issue.id // empty')

            if [ -z "$ISSUE_UUID" ]; then
              echo "Warning: Could not find issue $ISSUE_ID"
              continue
            fi

            RESULT=$(curl -s -X POST https://api.linear.app/graphql \
              -H "Content-Type: application/json" \
              -H "Authorization: $LINEAR_API_KEY" \
              -d '{
                "query": "mutation UpdateIssue($id: String!, $input: IssueUpdateInput!) { issueUpdate(id: $id, input: $input) { success } }",
                "variables": {
                  "id": "'"$ISSUE_UUID"'",
                  "input": { "stateId": "'"$LINEAR_STATE_IN_REVIEW"'" }
                }
              }')

            SUCCESS=$(echo "$RESULT" | jq -r '.data.issueUpdate.success // false')
            echo "$ISSUE_ID: $SUCCESS"
          done

      - name: Move to Done
        if: github.event.inputs.action == 'move-to-done' && steps.extract-issues.outputs.found == 'true'
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        run: |
          ISSUE_IDS="${{ steps.extract-issues.outputs.ids }}"

          echo "Moving issues to 'Done': $ISSUE_IDS"

          IFS=',' read -ra IDS <<< "$ISSUE_IDS"
          for ISSUE_ID in "${IDS[@]}"; do
            ISSUE_UUID=$(curl -s -X POST https://api.linear.app/graphql \
              -H "Content-Type: application/json" \
              -H "Authorization: $LINEAR_API_KEY" \
              -d '{
                "query": "query GetIssue($id: String!) { issue(id: $id) { id } }",
                "variables": { "id": "'"$ISSUE_ID"'" }
              }' | jq -r '.data.issue.id // empty')

            if [ -z "$ISSUE_UUID" ]; then
              echo "Warning: Could not find issue $ISSUE_ID"
              continue
            fi

            RESULT=$(curl -s -X POST https://api.linear.app/graphql \
              -H "Content-Type: application/json" \
              -H "Authorization: $LINEAR_API_KEY" \
              -d '{
                "query": "mutation UpdateIssue($id: String!, $input: IssueUpdateInput!) { issueUpdate(id: $id, input: $input) { success } }",
                "variables": {
                  "id": "'"$ISSUE_UUID"'",
                  "input": { "stateId": "'"$LINEAR_STATE_DONE"'" }
                }
              }')

            SUCCESS=$(echo "$RESULT" | jq -r '.data.issueUpdate.success // false')
            echo "$ISSUE_ID: $SUCCESS"
          done

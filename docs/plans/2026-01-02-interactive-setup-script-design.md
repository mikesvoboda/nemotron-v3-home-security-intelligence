# Interactive Setup Script Design

**Date:** 2026-01-02
**Status:** Approved
**Goal:** Make onboarding easy for new users by providing an interactive setup script that generates configuration files for their environment.

## Overview

Create a cross-platform Python setup script that guides users through configuration, detects port conflicts, generates `.env` and `docker-compose.override.yml` files, and optionally configures Linux firewalls.

## Design Decisions

| Decision          | Choice                                 | Rationale                                                   |
| ----------------- | -------------------------------------- | ----------------------------------------------------------- |
| Deployment model  | Docker-first                           | Users run `docker-compose up` with minimal config           |
| Required settings | Paths + credentials + all 14 ports     | Comprehensive customization                                 |
| Config format     | Interactive script generates files     | Best onboarding UX                                          |
| Script language   | Python (cross-platform)                | Project already requires Python 3.14, better error handling |
| Generated files   | `.env` + `docker-compose.override.yml` | Separates values from structural changes                    |
| Firewall config   | Ask permission first (Linux only)      | Balances convenience with safety                            |

## Services and Ports

All 14 services have configurable ports:

| Service        | Default Port | Category   |
| -------------- | ------------ | ---------- |
| Backend API    | 8000         | Core       |
| Frontend       | 5173         | Core       |
| PostgreSQL     | 5432         | Core       |
| Redis          | 6379         | Core       |
| RT-DETRv2      | 8090         | AI         |
| Nemotron LLM   | 8091         | AI         |
| Florence-2     | 8092         | AI         |
| CLIP           | 8093         | AI         |
| Enrichment     | 8094         | AI         |
| Grafana        | 3002         | Monitoring |
| Prometheus     | 9090         | Monitoring |
| Alertmanager   | 3000         | Monitoring |
| Redis Exporter | 9121         | Monitoring |
| JSON Exporter  | 7979         | Monitoring |

## Setup Script Modes

### Quick Mode (`./setup.sh`)

Shows defaults, user presses Enter to accept or types new value:

```
═══════════════════════════════════════════════════════════
  Home Security Intelligence - Quick Setup
═══════════════════════════════════════════════════════════

Checking for port conflicts...
✓ All default ports available

── Paths ──────────────────────────────────────────────────
Camera upload path [/export/foscam]:
AI models path [/export/ai_models]:

── Credentials ────────────────────────────────────────────
Database password [auto-generate]:
FTP password [auto-generate]:

── Ports (press Enter to keep defaults) ───────────────────
Backend API [8000]:
Frontend [5173]:
(... remaining 12 ports ...)

═══════════════════════════════════════════════════════════
Generated:
  • .env
  • docker-compose.override.yml

Open firewall ports for frontend (5173) and Grafana (3002)? [y/N]:

Ready! Run: docker-compose -f docker-compose.prod.yml up -d
═══════════════════════════════════════════════════════════
```

### Guided Mode (`./setup.sh --guided`)

Step-by-step with explanations:

```
═══════════════════════════════════════════════════════════
  Step 1 of 5: Camera Upload Path
═══════════════════════════════════════════════════════════

This is where your Foscam cameras upload images via FTP.
The backend watches this directory for new files.

Requirements:
  • Must exist and be readable by Docker
  • Recommended: SSD or fast storage for real-time processing
  • Typical size: 10-50GB depending on camera count/retention

? Enter camera upload path [/export/foscam]: /mnt/cameras
✓ Directory exists and is readable
```

Guided mode extras:

- Disk space check for AI models path (~15GB needed)
- Explains each port's purpose when prompting
- Offers to run `ai/download_models.sh` after setup
- Shows summary before writing files

## Generated Files

### `.env`

```env
# Generated by setup.sh on 2026-01-02
# ═══════════════════════════════════════════════════════════

# ── Paths ──────────────────────────────────────────────────
CAMERA_PATH=/export/foscam
AI_MODELS_PATH=/export/ai_models

# ── Credentials ────────────────────────────────────────────
POSTGRES_PASSWORD=aX9#kL2$mP7qR4
FTP_PASSWORD=bY8@nM3!vQ6wS1

# ── Database ───────────────────────────────────────────────
POSTGRES_USER=security
POSTGRES_DB=security
DATABASE_URL=postgresql+asyncpg://security:aX9#kL2$mP7qR4@postgres:5432/security

# ── Service URLs (auto-constructed from ports) ─────────────
RTDETR_URL=http://ai-detector:8090
NEMOTRON_URL=http://ai-llm:8091
FLORENCE_URL=http://ai-florence:8092
CLIP_URL=http://ai-clip:8093
ENRICHMENT_URL=http://ai-enrichment:8094
REDIS_URL=redis://redis:6379

# ── Frontend Runtime Config ────────────────────────────────
GRAFANA_URL=http://localhost:3002
```

### `docker-compose.override.yml`

```yaml
# Generated by setup.sh on 2026-01-02
# This file is auto-merged with docker-compose.prod.yml

services:
  postgres:
    ports:
      - '5432:5432'

  redis:
    ports:
      - '6379:6379'

  backend:
    ports:
      - '8000:8000'
    volumes:
      - /export/foscam:/cameras:ro
      - ${AI_MODELS_PATH}/model-zoo:/models/model-zoo:ro

  ai-detector:
    ports:
      - '8090:8090'

  ai-llm:
    ports:
      - '8091:8091'

  ai-florence:
    ports:
      - '8092:8092'

  ai-clip:
    ports:
      - '8093:8093'

  ai-enrichment:
    ports:
      - '8094:8094'

  frontend:
    ports:
      - '5173:80'

  grafana:
    ports:
      - '3002:3000'

  prometheus:
    ports:
      - '9090:9090'

  alertmanager:
    ports:
      - '3000:9093'

  redis-exporter:
    ports:
      - '9121:9121'

  json-exporter:
    ports:
      - '7979:7979'
```

## Technical Implementation

### Script Structure

```
setup.py          # Main setup script (Python, cross-platform)
setup.sh          # Thin wrapper: #!/bin/bash → python3 setup.py "$@"
setup.bat         # Windows wrapper: python setup.py %*
```

### Key Functions

```python
# Port conflict detection (cross-platform)
def check_port_available(port: int) -> bool:
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
        return s.connect_ex(('localhost', port)) != 0

# Find next available port if default is taken
def find_available_port(start: int) -> int:
    port = start
    while not check_port_available(port):
        port += 1
    return port

# Secure password generation
def generate_password(length: int = 16) -> str:
    return secrets.token_urlsafe(length)[:length]

# Firewall configuration (Linux only)
def configure_firewall(port: int) -> bool:
    if platform.system() != 'Linux':
        return False

    if shutil.which('firewall-cmd'):
        subprocess.run(['firewall-cmd', '--permanent', f'--add-port={port}/tcp'])
        subprocess.run(['firewall-cmd', '--reload'])
        return True
    elif shutil.which('ufw'):
        subprocess.run(['ufw', 'allow', f'{port}/tcp'])
        return True
    return False
```

### Validation

- Check paths exist or offer to create them
- Verify ports are numeric and in valid range (1024-65535)
- Warn if running as root (recommend non-root)
- Check Docker/Podman is installed and running

### Idempotent Behavior

Running `setup.sh` again detects existing `.env`:

```
Existing configuration found. What would you like to do?
[1] Reconfigure from scratch
[2] Update specific values
[3] Cancel
```

### Dependencies

```python
# Use only stdlib for zero-dependency setup
import os, sys, socket, subprocess, secrets, json, platform, shutil, pathlib

# Optional: rich (for pretty output) - graceful fallback if missing
try:
    from rich.console import Console
    from rich.prompt import Prompt
    RICH_AVAILABLE = True
except ImportError:
    RICH_AVAILABLE = False
```

## Code Changes Required

### 1. Frontend - Dynamic Grafana URL

**File:** `frontend/src/components/system/SystemMonitoringPage.tsx`

```typescript
// Before (hardcoded):
href="http://localhost:3002"

// After (fetched from backend):
const [grafanaUrl, setGrafanaUrl] = useState<string>('');

useEffect(() => {
  fetchConfig().then(config => setGrafanaUrl(config.grafana_url));
}, []);

// In JSX:
href={grafanaUrl || '#'}
```

### 2. Backend - Add Grafana URL Setting

**File:** `backend/core/config.py`

```python
grafana_url: str = Field(
    default="http://localhost:3002",
    description="Grafana dashboard URL for frontend link"
)
```

### 3. Backend - Expose in Config Response

**File:** `backend/api/schemas/system.py`

```python
class ConfigResponse(BaseModel):
    # ... existing fields ...
    grafana_url: str
```

**File:** `backend/api/routes/system.py`

```python
# In get_config endpoint, include grafana_url in response
```

### 4. Frontend - Dev Proxy Configuration

**File:** `frontend/vite.config.ts`

```typescript
// Before:
target: 'http://localhost:8000';

// After:
target: process.env.VITE_DEV_BACKEND_URL || 'http://localhost:8000';
```

## Documentation Updates

| File                                   | Change                                 |
| -------------------------------------- | -------------------------------------- |
| `README.md`                            | Update Quick Start to use `./setup.sh` |
| `docs/getting-started/installation.md` | Full setup.sh walkthrough              |
| `docs/RUNTIME_CONFIG.md`               | Reference generated files              |
| `CLAUDE.md`                            | Update deployment instructions         |

## Testing Strategy

1. **Unit tests** for setup.py functions (port detection, password generation, file generation)
2. **Integration test** that runs setup.sh in a container and verifies generated files
3. **Manual testing** on Linux (with firewall), macOS, and Windows

## Rollout Plan

1. Implement setup script and code changes
2. Update documentation
3. Test on fresh clone
4. Update README quick start
5. Consider: add `setup.sh` check to CI that verifies it runs without error

# Dashboard Summaries Feature Design

**Date:** 2026-01-18
**Status:** Approved
**Author:** Mike Svoboda + maui

## Overview

Add hourly and daily summary cards to the main dashboard that provide high-level narrative descriptions of high and critical security events. Summaries are generated by Nemotron every 5 minutes and displayed above the Activity Feed.

## Requirements

- **Hourly Summary:** Covers the past 60 minutes, focuses on high/critical events only
- **Daily Summary:** Covers since midnight today, focuses on high/critical events only
- **Update Frequency:** Both regenerate every 5 minutes via background job
- **Format:** Natural language narrative (2-4 sentences) generated by Nemotron
- **Empty State:** "All clear" reassuring message when no high/critical events
- **Placement:** Stacked vertically above the Activity Feed (hourly on top, daily below)

## Data Model

### New Table: `summaries`

| Column         | Type                                   | Description                             |
| -------------- | -------------------------------------- | --------------------------------------- |
| `id`           | SERIAL PRIMARY KEY                     | Auto-increment                          |
| `summary_type` | VARCHAR(10) NOT NULL                   | `'hourly'` or `'daily'`                 |
| `content`      | TEXT NOT NULL                          | LLM-generated narrative                 |
| `event_count`  | INTEGER NOT NULL                       | Number of high/critical events included |
| `event_ids`    | INTEGER[]                              | References to events summarized         |
| `window_start` | TIMESTAMP WITH TIME ZONE NOT NULL      | Start of time window                    |
| `window_end`   | TIMESTAMP WITH TIME ZONE NOT NULL      | End of time window                      |
| `generated_at` | TIMESTAMP WITH TIME ZONE NOT NULL      | When LLM produced this                  |
| `created_at`   | TIMESTAMP WITH TIME ZONE DEFAULT NOW() | Row creation time                       |

### Indexes

- `idx_summaries_type_created` on `(summary_type, created_at DESC)` - fast latest-summary lookups

### Retention

- Old summaries retained for 7 days for audit/debugging
- Cleanup handled by existing `CleanupService`

## Backend Service

### SummaryGenerator (`backend/services/summary_generator.py`)

**Responsibilities:**

1. Query high/critical events for time window (risk_level IN ('high', 'critical'))
2. Build context for Nemotron (event summaries, timestamps, cameras, risk scores)
3. Call Nemotron with summary-specific prompt
4. Store result in `summaries` table
5. Broadcast update via WebSocket

**Time Windows:**

- Hourly: `window_start = NOW() - INTERVAL '60 minutes'`, `window_end = NOW()`
- Daily: `window_start = DATE_TRUNC('day', NOW())`, `window_end = NOW()`

### Background Job

- **Job type:** `generate_summaries`
- **Schedule:** Every 5 minutes via existing scheduler
- **Behavior:** Generates both hourly and daily in same job run
- **Timeout:** 60 seconds (fail-safe if LLM hangs)
- **Infrastructure:** Uses existing `JobSystem` (Job, JobAttempt, JobLog)

### Prompt Template

Add to `backend/services/prompts.py`:

```python
SUMMARY_PROMPT = """You are a security analyst summarizing events for a homeowner.

Time window: {window_start} to {window_end}
Events ({count} high/critical):
{event_list}

Write a concise narrative (2-4 sentences) highlighting:
- What happened and when
- Any patterns (e.g., person + vehicle arriving together)
- Which areas of the property were affected

If no events: Write a brief reassuring "all clear" message mentioning routine activity count if available."""
```

### Fallback Behavior

If Nemotron is unavailable, store fallback message:

> "Summary temporarily unavailable. {N} high/critical events in this period."

## API Endpoints

### New Route: `backend/api/routes/summaries.py`

| Method | Path                    | Description                             |
| ------ | ----------------------- | --------------------------------------- |
| `GET`  | `/api/summaries/latest` | Returns both hourly and daily summaries |
| `GET`  | `/api/summaries/hourly` | Returns latest hourly summary only      |
| `GET`  | `/api/summaries/daily`  | Returns latest daily summary only       |

### Response Schema

**GET `/api/summaries/latest`:**

```json
{
  "hourly": {
    "content": "Over the past hour, one critical event occurred at 2:15 PM when an unrecognized person approached the front door. The individual remained at the door for approximately 45 seconds before leaving via the driveway.",
    "event_count": 1,
    "window_start": "2026-01-18T14:00:00Z",
    "window_end": "2026-01-18T15:00:00Z",
    "generated_at": "2026-01-18T14:55:00Z"
  },
  "daily": {
    "content": "Today has seen minimal high-priority activity. The only notable event was at 2:15 PM at the front door. Morning and evening periods have been quiet with routine traffic only.",
    "event_count": 1,
    "window_start": "2026-01-18T00:00:00Z",
    "window_end": "2026-01-18T15:00:00Z",
    "generated_at": "2026-01-18T14:55:00Z"
  }
}
```

### WebSocket Integration

Broadcast on existing `/ws/events` channel when new summaries are generated:

```json
{
  "type": "summary_update",
  "data": {
    "hourly": { ... },
    "daily": { ... }
  }
}
```

### Caching

- Redis cache with 5-minute TTL on `/api/summaries/latest`
- Cache invalidated when new summaries generated

## Frontend Components

### SummaryCards (`frontend/src/components/dashboard/SummaryCards.tsx`)

**Component Structure:**

```tsx
<SummaryCards>
  <SummaryCard type="hourly" ... />
  <SummaryCard type="daily" ... />
</SummaryCards>
```

**SummaryCard Props:**

| Prop          | Type                  | Description                   |
| ------------- | --------------------- | ----------------------------- |
| `type`        | `'hourly' \| 'daily'` | Which summary to display      |
| `content`     | `string`              | The narrative text            |
| `eventCount`  | `number`              | Badge showing event count     |
| `generatedAt` | `Date`                | "Updated 2 min ago" timestamp |
| `windowStart` | `Date`                | For tooltip context           |
| `windowEnd`   | `Date`                | For tooltip context           |

**Visual Design:**

- Tremor `Card` component with subtle background
- Header: "Hourly Summary" / "Daily Summary" with event count badge
- Body: Narrative text (2-4 sentences)
- Footer: "Updated X minutes ago" in muted text
- When `eventCount === 0`: Green-tinted "all clear" styling
- When `eventCount > 0` with critical events: Amber/red accent border

### Data Hook: `useSummaries()` (`frontend/src/hooks/useSummaries.ts`)

- Fetches `/api/summaries/latest` on mount via React Query
- Subscribes to WebSocket `summary_update` events
- Auto-refreshes when WebSocket broadcast received
- Returns `{ hourly, daily, isLoading, error }`

### Dashboard Integration

Modify `DashboardPage.tsx` to include `<SummaryCards />` between Camera Grid and Activity Feed:

```
┌──────────────────────────────────────┐
│ Stats Row                            │
├──────────────────────────────────────┤
│ Camera Grid                          │
├──────────────────────────────────────┤
│ ┌──────────────────────────────────┐ │
│ │ Hourly Summary           [1]     │ │
│ │ Over the past hour...            │ │
│ │ Updated 2 minutes ago            │ │
│ └──────────────────────────────────┘ │
│ ┌──────────────────────────────────┐ │
│ │ Daily Summary            [3]     │ │
│ │ Today saw 3 high-priority...     │ │
│ │ Updated 2 minutes ago            │ │
│ └──────────────────────────────────┘ │
├──────────────────────────────────────┤
│ Activity Feed                        │
└──────────────────────────────────────┘
```

## Implementation Files

| Layer                  | File                                                  | Status |
| ---------------------- | ----------------------------------------------------- | ------ |
| **Model**              | `backend/models/summary.py`                           | New    |
| **Repository**         | `backend/repositories/summary_repository.py`          | New    |
| **Service**            | `backend/services/summary_generator.py`               | New    |
| **Prompts**            | `backend/services/prompts.py`                         | Modify |
| **Jobs**               | `backend/services/jobs/summary_job.py`                | New    |
| **API Route**          | `backend/api/routes/summaries.py`                     | New    |
| **API Init**           | `backend/api/routes/__init__.py`                      | Modify |
| **WebSocket**          | `backend/api/routes/websocket.py`                     | Modify |
| **Scheduler**          | `backend/main.py`                                     | Modify |
| **Frontend Component** | `frontend/src/components/dashboard/SummaryCards.tsx`  | New    |
| **Frontend Hook**      | `frontend/src/hooks/useSummaries.ts`                  | New    |
| **Dashboard**          | `frontend/src/components/dashboard/DashboardPage.tsx` | Modify |
| **Types**              | `frontend/src/types/summary.ts`                       | New    |
| **API Client**         | `frontend/src/services/api.ts`                        | Modify |
| **Migration**          | `backend/alembic/versions/xxx_add_summaries_table.py` | New    |

## Testing Strategy

### Backend Tests

- **Unit:** `SummaryGenerator` prompt building, time window calculation
- **Unit:** Summary repository CRUD operations
- **Integration:** Job scheduling and execution
- **Integration:** API endpoint responses

### Frontend Tests

- **Unit:** `SummaryCard` rendering with various states (events, no events, loading)
- **Unit:** `useSummaries` hook behavior
- **Integration:** WebSocket update handling

## Open Questions

None - all decisions made during brainstorming.

## Changelog

- 2026-01-18: Initial design approved

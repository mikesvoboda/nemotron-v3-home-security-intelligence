<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 850 500" width="850" height="500">
  <defs>
    <linearGradient id="greenGradient" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#10B981;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#059669;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="amberGradient" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#F59E0B;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#D97706;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="blueGradient" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#3B82F6;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#2563EB;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="purpleGradient" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#A855F7;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#9333EA;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="grayGradient" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#4B5563;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#374151;stop-opacity:1" />
    </linearGradient>
    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="2" dy="3" stdDeviation="4" flood-color="#000" flood-opacity="0.4"/>
    </filter>
    <marker id="arrowGray" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#6B7280"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="850" height="500" fill="#111827"/>

  <!-- Title -->
  <text x="425" y="35" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="20" font-weight="bold" fill="#F9FAFB">WebSocket Circuit Breaker Architecture</text>

  <!-- Backend Services Section -->
  <g transform="translate(30, 60)">
    <rect x="0" y="0" width="280" height="200" rx="10" fill="#1F2937" stroke="#374151" stroke-width="2"/>
    <text x="140" y="22" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="12" font-weight="600" fill="#9CA3AF">Backend Services</text>

    <!-- SystemBroadcaster -->
    <rect x="15" y="38" width="115" height="55" rx="6" fill="url(#blueGradient)" filter="url(#shadow)"/>
    <text x="72" y="58" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="9" font-weight="600" fill="white">SystemBroadcaster</text>
    <text x="72" y="73" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#BFDBFE">Port: /ws/system</text>
    <text x="72" y="85" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#BFDBFE">Status updates</text>

    <!-- EventBroadcaster -->
    <rect x="150" y="38" width="115" height="55" rx="6" fill="url(#blueGradient)" filter="url(#shadow)"/>
    <text x="207" y="58" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="9" font-weight="600" fill="white">EventBroadcaster</text>
    <text x="207" y="73" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#BFDBFE">Port: /ws/events</text>
    <text x="207" y="85" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#BFDBFE">Security events</text>

    <!-- Circuit Breakers -->
    <rect x="15" y="105" width="115" height="45" rx="6" fill="url(#amberGradient)" filter="url(#shadow)"/>
    <text x="72" y="122" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="8" font-weight="600" fill="#1F2937">WebSocketCircuitBreaker</text>
    <text x="72" y="137" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#451A03">system_broadcaster</text>

    <rect x="150" y="105" width="115" height="45" rx="6" fill="url(#amberGradient)" filter="url(#shadow)"/>
    <text x="207" y="122" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="8" font-weight="600" fill="#1F2937">WebSocketCircuitBreaker</text>
    <text x="207" y="137" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#451A03">event_broadcaster</text>

    <!-- Arrows from broadcasters to breakers -->
    <line x1="72" y1="93" x2="72" y2="105" stroke="#6B7280" stroke-width="1.5" marker-end="url(#arrowGray)"/>
    <line x1="207" y1="93" x2="207" y2="105" stroke="#6B7280" stroke-width="1.5" marker-end="url(#arrowGray)"/>

    <!-- Divider -->
    <line x1="15" y1="160" x2="265" y2="160" stroke="#374151" stroke-width="1"/>

    <!-- Connection status -->
    <text x="140" y="178" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="9" fill="#6B7280">Pub/Sub Connection</text>
    <text x="140" y="192" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="9" fill="#6B7280">with Recovery</text>
  </g>

  <!-- Redis Pub/Sub Section -->
  <g transform="translate(350, 90)">
    <rect x="0" y="0" width="180" height="140" rx="10" fill="#1F2937" stroke="#A855F7" stroke-width="2"/>
    <text x="90" y="22" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="12" font-weight="600" fill="#A855F7">Redis Pub/Sub</text>

    <rect x="20" y="45" width="140" height="35" rx="6" fill="url(#purpleGradient)" filter="url(#shadow)"/>
    <text x="90" y="68" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="10" font-weight="600" fill="white">system_status channel</text>

    <rect x="20" y="92" width="140" height="35" rx="6" fill="url(#purpleGradient)" filter="url(#shadow)"/>
    <text x="90" y="115" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="10" font-weight="600" fill="white">security_events channel</text>
  </g>

  <!-- Frontend Clients Section -->
  <g transform="translate(570, 60)">
    <rect x="0" y="0" width="250" height="200" rx="10" fill="#1F2937" stroke="#374151" stroke-width="2"/>
    <text x="125" y="22" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="12" font-weight="600" fill="#9CA3AF">Frontend Clients</text>

    <rect x="20" y="40" width="210" height="55" rx="6" fill="url(#greenGradient)" filter="url(#shadow)"/>
    <text x="125" y="60" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="10" font-weight="600" fill="white">useWebSocket Hook</text>
    <text x="125" y="78" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="9" fill="#D1FAE5">Auto-reconnect with backoff</text>
    <text x="125" y="90" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#A7F3D0">Heartbeat handling</text>

    <rect x="20" y="105" width="210" height="55" rx="6" fill="url(#blueGradient)" filter="url(#shadow)"/>
    <text x="125" y="125" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="10" font-weight="600" fill="white">WebSocketManager</text>
    <text x="125" y="143" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="9" fill="#BFDBFE">Connection Deduplication</text>
    <text x="125" y="155" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#93C5FD">Reference counting</text>

    <line x1="125" y1="95" x2="125" y2="105" stroke="#6B7280" stroke-width="1.5" marker-end="url(#arrowGray)"/>

    <text x="125" y="178" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="9" fill="#6B7280">Client-side resilience</text>
    <text x="125" y="192" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="9" fill="#6B7280">Max 5 reconnect attempts</text>
  </g>

  <!-- Arrows between sections -->
  <!-- Backend to Redis -->
  <line x1="310" y1="140" x2="350" y2="140" stroke="#A855F7" stroke-width="2" marker-end="url(#arrowGray)"/>
  <text x="330" y="132" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#A855F7">Publish</text>

  <!-- Redis to Backend (subscribe) -->
  <path d="M350 180 Q330 180 330 200 Q330 220 310 220" fill="none" stroke="#A855F7" stroke-width="1.5" stroke-dasharray="4" marker-end="url(#arrowGray)"/>
  <text x="335" y="208" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#A855F7">Subscribe</text>

  <!-- Backend to Frontend -->
  <line x1="310" y1="160" x2="570" y2="90" stroke="#3B82F6" stroke-width="2" marker-end="url(#arrowGray)"/>
  <text x="440" y="110" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#3B82F6">WebSocket</text>
  <text x="440" y="122" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#3B82F6">Broadcast</text>

  <!-- Circuit Breaker States Table -->
  <g transform="translate(30, 290)">
    <rect x="0" y="0" width="790" height="180" rx="10" fill="#1F2937" stroke="#374151" stroke-width="2"/>
    <text x="395" y="22" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="13" font-weight="600" fill="#9CA3AF">WebSocket Circuit Breaker States</text>

    <!-- State Cards -->
    <g transform="translate(20, 40)">
      <!-- CLOSED -->
      <rect x="0" y="0" width="240" height="120" rx="8" fill="#0F1F1A" stroke="#10B981" stroke-width="2"/>
      <rect x="10" y="10" width="80" height="25" rx="4" fill="url(#greenGradient)"/>
      <text x="50" y="28" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="11" font-weight="bold" fill="white">CLOSED</text>
      <text x="120" y="53" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="10" fill="#10B981">Normal Operation</text>
      <text x="120" y="72" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="9" fill="#6B7280">WebSocket broadcasts pass through</text>
      <text x="120" y="88" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="9" fill="#6B7280">Track consecutive failures</text>
      <text x="120" y="104" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="9" fill="#6B7280">Reset failure count on success</text>
    </g>

    <g transform="translate(280, 40)">
      <!-- OPEN -->
      <rect x="0" y="0" width="240" height="120" rx="8" fill="#1C1917" stroke="#EF4444" stroke-width="2"/>
      <rect x="10" y="10" width="65" height="25" rx="4" fill="url(#amberGradient)"/>
      <text x="42" y="28" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="11" font-weight="bold" fill="#1F2937">OPEN</text>
      <text x="120" y="53" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="10" fill="#EF4444">Circuit Tripped</text>
      <text x="120" y="72" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="9" fill="#6B7280">Broadcasts rejected immediately</text>
      <text x="120" y="88" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="9" fill="#6B7280">Waiting for recovery timeout</text>
      <text x="120" y="104" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="9" fill="#6B7280">Degraded mode notification sent</text>
    </g>

    <g transform="translate(540, 40)">
      <!-- HALF_OPEN -->
      <rect x="0" y="0" width="240" height="120" rx="8" fill="#1A1815" stroke="#F59E0B" stroke-width="2"/>
      <rect x="10" y="10" width="90" height="25" rx="4" fill="url(#amberGradient)"/>
      <text x="55" y="28" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="11" font-weight="bold" fill="#1F2937">HALF_OPEN</text>
      <text x="120" y="53" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="10" fill="#F59E0B">Recovery Testing</text>
      <text x="120" y="72" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="9" fill="#6B7280">Single test operation allowed</text>
      <text x="120" y="88" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="9" fill="#6B7280">Track success/failure</text>
      <text x="120" y="104" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="9" fill="#6B7280">Careful service probing</text>
    </g>

    <!-- Transition arrows -->
    <path d="M260 95 Q270 80 280 95" fill="none" stroke="#EF4444" stroke-width="2" marker-end="url(#arrowGray)"/>
    <text x="270" y="75" font-family="system-ui, -apple-system, sans-serif" font-size="7" fill="#EF4444">failures >= 5</text>

    <path d="M520 95 Q530 80 540 95" fill="none" stroke="#F59E0B" stroke-width="2" marker-end="url(#arrowGray)"/>
    <text x="530" y="75" font-family="system-ui, -apple-system, sans-serif" font-size="7" fill="#F59E0B">30s timeout</text>
  </g>
</svg>

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 620" fill="none">
  <defs>
    <!-- Gradients -->
    <linearGradient id="bgGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" stop-color="#1a1a2e"/>
      <stop offset="100%" stop-color="#16213e"/>
    </linearGradient>
    <linearGradient id="clientGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#3B82F6"/>
      <stop offset="100%" stop-color="#2563EB"/>
    </linearGradient>
    <linearGradient id="wsGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#10B981"/>
      <stop offset="100%" stop-color="#059669"/>
    </linearGradient>
    <linearGradient id="broadcasterGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#F59E0B"/>
      <stop offset="100%" stop-color="#D97706"/>
    </linearGradient>
    <linearGradient id="gpuGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#8B5CF6"/>
      <stop offset="100%" stop-color="#7C3AED"/>
    </linearGradient>
    <linearGradient id="healthGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#EC4899"/>
      <stop offset="100%" stop-color="#DB2777"/>
    </linearGradient>
    <!-- Drop shadow filter -->
    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="0" dy="2" stdDeviation="3" flood-opacity="0.3"/>
    </filter>
    <!-- Arrow markers -->
    <marker id="arrowRight" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#60A5FA"/>
    </marker>
    <marker id="arrowLeft" markerWidth="10" markerHeight="7" refX="1" refY="3.5" orient="auto">
      <polygon points="10 0, 0 3.5, 10 7" fill="#60A5FA"/>
    </marker>
    <marker id="arrowRightDashed" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#34D399"/>
    </marker>
    <marker id="arrowLeftDashed" markerWidth="10" markerHeight="7" refX="1" refY="3.5" orient="auto">
      <polygon points="10 0, 0 3.5, 10 7" fill="#34D399"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="800" height="620" fill="url(#bgGrad)"/>

  <!-- Title -->
  <text x="400" y="35" fill="#E5E7EB" font-family="system-ui, -apple-system, sans-serif" font-size="20" font-weight="600" text-anchor="middle">System Channel Sequence</text>

  <!-- Participant headers -->
  <g transform="translate(0, 55)">
    <!-- Browser -->
    <g transform="translate(70, 0)" filter="url(#shadow)">
      <rect x="0" y="0" width="90" height="40" rx="6" fill="url(#clientGrad)"/>
      <text x="45" y="25" fill="white" font-family="system-ui, sans-serif" font-size="12" font-weight="500" text-anchor="middle">Browser</text>
    </g>

    <!-- /ws/system -->
    <g transform="translate(210, 0)" filter="url(#shadow)">
      <rect x="0" y="0" width="100" height="40" rx="6" fill="url(#wsGrad)"/>
      <text x="50" y="25" fill="white" font-family="monospace" font-size="11" font-weight="500" text-anchor="middle">/ws/system</text>
    </g>

    <!-- SystemBroadcaster -->
    <g transform="translate(360, 0)" filter="url(#shadow)">
      <rect x="0" y="0" width="130" height="40" rx="6" fill="url(#broadcasterGrad)"/>
      <text x="65" y="25" fill="white" font-family="system-ui, sans-serif" font-size="11" font-weight="500" text-anchor="middle">SystemBroadcaster</text>
    </g>

    <!-- GPUMonitor -->
    <g transform="translate(540, 0)" filter="url(#shadow)">
      <rect x="0" y="0" width="100" height="40" rx="6" fill="url(#gpuGrad)"/>
      <text x="50" y="25" fill="white" font-family="system-ui, sans-serif" font-size="11" font-weight="500" text-anchor="middle">GPUMonitor</text>
    </g>

    <!-- HealthMonitor -->
    <g transform="translate(680, 0)" filter="url(#shadow)">
      <rect x="0" y="0" width="100" height="40" rx="6" fill="url(#healthGrad)"/>
      <text x="50" y="25" fill="white" font-family="system-ui, sans-serif" font-size="11" font-weight="500" text-anchor="middle">HealthMonitor</text>
    </g>
  </g>

  <!-- Lifelines -->
  <g stroke="#4B5563" stroke-width="1" stroke-dasharray="4,4">
    <line x1="115" y1="100" x2="115" y2="580"/>
    <line x1="260" y1="100" x2="260" y2="580"/>
    <line x1="425" y1="100" x2="425" y2="580"/>
    <line x1="590" y1="100" x2="590" y2="580"/>
    <line x1="730" y1="100" x2="730" y2="580"/>
  </g>

  <!-- Connection Phase -->
  <g transform="translate(0, 120)">
    <!-- Connect (upgrade) -->
    <line x1="115" y1="0" x2="250" y2="0" stroke="#60A5FA" stroke-width="2" marker-end="url(#arrowRight)"/>
    <text x="182" y="-8" fill="#93C5FD" font-family="system-ui, sans-serif" font-size="11" text-anchor="middle">Connect (upgrade)</text>

    <!-- Register websocket -->
    <line x1="260" y1="40" x2="415" y2="40" stroke="#60A5FA" stroke-width="2" marker-end="url(#arrowRight)"/>
    <text x="337" y="32" fill="#93C5FD" font-family="system-ui, sans-serif" font-size="11" text-anchor="middle">register(websocket)</text>

    <!-- Connection accepted (dashed return) -->
    <line x1="425" y1="80" x2="125" y2="80" stroke="#34D399" stroke-width="2" stroke-dasharray="6,3" marker-end="url(#arrowRightDashed)"/>
    <text x="275" y="72" fill="#6EE7B7" font-family="system-ui, sans-serif" font-size="11" text-anchor="middle">Connection accepted</text>
  </g>

  <!-- Loop indicator -->
  <g transform="translate(60, 220)">
    <rect x="0" y="0" width="690" height="230" rx="6" fill="none" stroke="#6B7280" stroke-width="1.5"/>
    <rect x="0" y="0" width="120" height="25" rx="4" fill="#374151"/>
    <text x="10" y="17" fill="#9CA3AF" font-family="system-ui, sans-serif" font-size="11" font-weight="500">loop [Every 5 seconds]</text>
  </g>

  <!-- Periodic Update Flow -->
  <g transform="translate(0, 250)">
    <!-- get_current_stats() -->
    <line x1="425" y1="0" x2="580" y2="0" stroke="#A78BFA" stroke-width="2" marker-end="url(#arrowRight)"/>
    <text x="502" y="-8" fill="#C4B5FD" font-family="system-ui, sans-serif" font-size="10" text-anchor="middle">get_current_stats()</text>

    <!-- GPU metrics return -->
    <line x1="590" y1="35" x2="435" y2="35" stroke="#C4B5FD" stroke-width="2" stroke-dasharray="6,3" marker-end="url(#arrowLeftDashed)"/>
    <text x="512" y="27" fill="#DDD6FE" font-family="system-ui, sans-serif" font-size="10" text-anchor="middle">GPU metrics</text>

    <!-- get_status() -->
    <line x1="425" y1="70" x2="720" y2="70" stroke="#F472B6" stroke-width="2" marker-end="url(#arrowRight)"/>
    <text x="572" y="62" fill="#F9A8D4" font-family="system-ui, sans-serif" font-size="10" text-anchor="middle">get_status()</text>

    <!-- Service health return -->
    <line x1="730" y1="105" x2="435" y2="105" stroke="#F9A8D4" stroke-width="2" stroke-dasharray="6,3" marker-end="url(#arrowLeftDashed)"/>
    <text x="582" y="97" fill="#FBCFE8" font-family="system-ui, sans-serif" font-size="10" text-anchor="middle">Service health</text>

    <!-- send_text(json) -->
    <line x1="425" y1="145" x2="270" y2="145" stroke="#FBBF24" stroke-width="2" marker-end="url(#arrowLeft)"/>
    <text x="347" y="137" fill="#FCD34D" font-family="system-ui, sans-serif" font-size="10" text-anchor="middle">send_text(json)</text>

    <!-- System status to client -->
    <line x1="260" y1="180" x2="125" y2="180" stroke="#60A5FA" stroke-width="2" marker-end="url(#arrowLeft)"/>
    <rect x="75" y="158" width="180" height="18" rx="3" fill="#3B82F6" fill-opacity="0.2"/>
    <text x="165" y="171" fill="#93C5FD" font-family="monospace" font-size="9" text-anchor="middle">{"type": "system_status", ...}</text>
  </g>

  <!-- Disconnect Phase -->
  <g transform="translate(0, 490)">
    <!-- Disconnect -->
    <line x1="115" y1="0" x2="250" y2="0" stroke="#60A5FA" stroke-width="2" marker-end="url(#arrowRight)"/>
    <text x="182" y="-8" fill="#93C5FD" font-family="system-ui, sans-serif" font-size="11" text-anchor="middle">Disconnect</text>

    <!-- Unregister websocket -->
    <line x1="260" y1="40" x2="415" y2="40" stroke="#60A5FA" stroke-width="2" marker-end="url(#arrowRight)"/>
    <text x="337" y="32" fill="#93C5FD" font-family="system-ui, sans-serif" font-size="11" text-anchor="middle">unregister(websocket)</text>
  </g>

  <!-- Legend -->
  <g transform="translate(50, 575)">
    <rect x="0" y="-12" width="700" height="30" rx="4" fill="rgba(255,255,255,0.05)"/>
    <line x1="20" y1="3" x2="50" y2="3" stroke="#60A5FA" stroke-width="2"/>
    <text x="60" y="7" fill="#9CA3AF" font-family="system-ui, sans-serif" font-size="10">Request</text>
    <line x1="130" y1="3" x2="160" y2="3" stroke="#34D399" stroke-width="2" stroke-dasharray="6,3"/>
    <text x="170" y="7" fill="#9CA3AF" font-family="system-ui, sans-serif" font-size="10">Response</text>
    <line x1="250" y1="3" x2="280" y2="3" stroke="#A78BFA" stroke-width="2"/>
    <text x="290" y="7" fill="#9CA3AF" font-family="system-ui, sans-serif" font-size="10">GPU Query</text>
    <line x1="370" y1="3" x2="400" y2="3" stroke="#F472B6" stroke-width="2"/>
    <text x="410" y="7" fill="#9CA3AF" font-family="system-ui, sans-serif" font-size="10">Health Query</text>
    <line x1="500" y1="3" x2="530" y2="3" stroke="#FBBF24" stroke-width="2"/>
    <text x="540" y="7" fill="#9CA3AF" font-family="system-ui, sans-serif" font-size="10">Broadcast</text>
  </g>
</svg>

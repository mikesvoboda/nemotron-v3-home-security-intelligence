<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1400 850" width="1400" height="850">
  <defs>
    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="1" dy="1" stdDeviation="2" flood-opacity="0.1"/>
    </filter>
    <linearGradient id="blueGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#60A5FA"/>
      <stop offset="100%" style="stop-color:#3B82F6"/>
    </linearGradient>
    <linearGradient id="greenGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#34D399"/>
      <stop offset="100%" style="stop-color:#10B981"/>
    </linearGradient>
    <linearGradient id="amberGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#FBBF24"/>
      <stop offset="100%" style="stop-color:#F59E0B"/>
    </linearGradient>
    <linearGradient id="purpleGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#A78BFA"/>
      <stop offset="100%" style="stop-color:#8B5CF6"/>
    </linearGradient>
    <linearGradient id="roseGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#FB7185"/>
      <stop offset="100%" style="stop-color:#F43F5E"/>
    </linearGradient>
    <linearGradient id="grayGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#9CA3AF"/>
      <stop offset="100%" style="stop-color:#6B7280"/>
    </linearGradient>
    <marker id="arrowBlack" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L8,3 z" fill="#374151"/>
    </marker>
    <marker id="arrowDashed" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L8,3 z" fill="#9CA3AF"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="1400" height="850" fill="#FAFAFA"/>

  <!-- Title -->
  <text x="700" y="35" font-family="system-ui, -apple-system, sans-serif" font-size="24" font-weight="600" fill="#1F2937" text-anchor="middle">Complete Pipeline: Camera to Dashboard</text>
  <text x="700" y="55" font-family="system-ui, sans-serif" font-size="12" fill="#6B7280" text-anchor="middle">Sequence diagram showing data flow from image capture to real-time notification</text>

  <!-- Participant boxes at top -->
  <g transform="translate(0, 75)">
    <!-- Camera -->
    <g transform="translate(40, 0)">
      <rect x="0" y="0" width="70" height="40" rx="6" fill="url(#grayGrad)" filter="url(#shadow)"/>
      <text x="35" y="25" font-family="system-ui, sans-serif" font-size="10" font-weight="600" fill="white" text-anchor="middle">Camera</text>
      <line x1="35" y1="40" x2="35" y2="720" stroke="#9CA3AF" stroke-width="1" stroke-dasharray="4,4"/>
    </g>

    <!-- FTP -->
    <g transform="translate(130, 0)">
      <rect x="0" y="0" width="70" height="40" rx="6" fill="url(#grayGrad)" filter="url(#shadow)"/>
      <text x="35" y="18" font-family="system-ui, sans-serif" font-size="9" font-weight="600" fill="white" text-anchor="middle">/export/</text>
      <text x="35" y="32" font-family="system-ui, sans-serif" font-size="9" font-weight="600" fill="white" text-anchor="middle">foscam/</text>
      <line x1="35" y1="40" x2="35" y2="720" stroke="#9CA3AF" stroke-width="1" stroke-dasharray="4,4"/>
    </g>

    <!-- FileWatcher -->
    <g transform="translate(220, 0)">
      <rect x="0" y="0" width="80" height="40" rx="6" fill="url(#blueGrad)" filter="url(#shadow)"/>
      <text x="40" y="25" font-family="system-ui, sans-serif" font-size="9" font-weight="600" fill="white" text-anchor="middle">FileWatcher</text>
      <line x1="40" y1="40" x2="40" y2="720" stroke="#3B82F6" stroke-width="1" stroke-dasharray="4,4"/>
    </g>

    <!-- Detection Queue -->
    <g transform="translate(320, 0)">
      <rect x="0" y="0" width="80" height="40" rx="6" fill="url(#purpleGrad)" filter="url(#shadow)"/>
      <text x="40" y="18" font-family="system-ui, sans-serif" font-size="9" font-weight="600" fill="white" text-anchor="middle">detection</text>
      <text x="40" y="32" font-family="system-ui, sans-serif" font-size="9" font-weight="600" fill="white" text-anchor="middle">_queue</text>
      <line x1="40" y1="40" x2="40" y2="720" stroke="#8B5CF6" stroke-width="1" stroke-dasharray="4,4"/>
    </g>

    <!-- Detection Worker -->
    <g transform="translate(420, 0)">
      <rect x="0" y="0" width="80" height="40" rx="6" fill="url(#blueGrad)" filter="url(#shadow)"/>
      <text x="40" y="18" font-family="system-ui, sans-serif" font-size="9" font-weight="600" fill="white" text-anchor="middle">Detection</text>
      <text x="40" y="32" font-family="system-ui, sans-serif" font-size="9" font-weight="600" fill="white" text-anchor="middle">Worker</text>
      <line x1="40" y1="40" x2="40" y2="720" stroke="#3B82F6" stroke-width="1" stroke-dasharray="4,4"/>
    </g>

    <!-- RT-DETRv2 -->
    <g transform="translate(520, 0)">
      <rect x="0" y="0" width="80" height="40" rx="6" fill="url(#amberGrad)" filter="url(#shadow)"/>
      <text x="40" y="25" font-family="system-ui, sans-serif" font-size="9" font-weight="600" fill="white" text-anchor="middle">RT-DETRv2</text>
      <line x1="40" y1="40" x2="40" y2="720" stroke="#F59E0B" stroke-width="1" stroke-dasharray="4,4"/>
    </g>

    <!-- PostgreSQL -->
    <g transform="translate(620, 0)">
      <rect x="0" y="0" width="80" height="40" rx="6" fill="url(#greenGrad)" filter="url(#shadow)"/>
      <text x="40" y="25" font-family="system-ui, sans-serif" font-size="9" font-weight="600" fill="white" text-anchor="middle">PostgreSQL</text>
      <line x1="40" y1="40" x2="40" y2="720" stroke="#10B981" stroke-width="1" stroke-dasharray="4,4"/>
    </g>

    <!-- Enrichment -->
    <g transform="translate(720, 0)">
      <rect x="0" y="0" width="80" height="40" rx="6" fill="url(#amberGrad)" opacity="0.7" filter="url(#shadow)"/>
      <text x="40" y="18" font-family="system-ui, sans-serif" font-size="9" font-weight="600" fill="white" text-anchor="middle">Enrichment</text>
      <text x="40" y="32" font-family="system-ui, sans-serif" font-size="8" fill="white" text-anchor="middle">(optional)</text>
      <line x1="40" y1="40" x2="40" y2="720" stroke="#F59E0B" stroke-width="1" stroke-dasharray="4,4" opacity="0.5"/>
    </g>

    <!-- BatchAggregator -->
    <g transform="translate(820, 0)">
      <rect x="0" y="0" width="80" height="40" rx="6" fill="url(#blueGrad)" filter="url(#shadow)"/>
      <text x="40" y="18" font-family="system-ui, sans-serif" font-size="9" font-weight="600" fill="white" text-anchor="middle">Batch</text>
      <text x="40" y="32" font-family="system-ui, sans-serif" font-size="9" font-weight="600" fill="white" text-anchor="middle">Aggregator</text>
      <line x1="40" y1="40" x2="40" y2="720" stroke="#3B82F6" stroke-width="1" stroke-dasharray="4,4"/>
    </g>

    <!-- Analysis Queue -->
    <g transform="translate(920, 0)">
      <rect x="0" y="0" width="80" height="40" rx="6" fill="url(#purpleGrad)" filter="url(#shadow)"/>
      <text x="40" y="18" font-family="system-ui, sans-serif" font-size="9" font-weight="600" fill="white" text-anchor="middle">analysis</text>
      <text x="40" y="32" font-family="system-ui, sans-serif" font-size="9" font-weight="600" fill="white" text-anchor="middle">_queue</text>
      <line x1="40" y1="40" x2="40" y2="720" stroke="#8B5CF6" stroke-width="1" stroke-dasharray="4,4"/>
    </g>

    <!-- Analysis Worker -->
    <g transform="translate(1020, 0)">
      <rect x="0" y="0" width="80" height="40" rx="6" fill="url(#blueGrad)" filter="url(#shadow)"/>
      <text x="40" y="18" font-family="system-ui, sans-serif" font-size="9" font-weight="600" fill="white" text-anchor="middle">Analysis</text>
      <text x="40" y="32" font-family="system-ui, sans-serif" font-size="9" font-weight="600" fill="white" text-anchor="middle">Worker</text>
      <line x1="40" y1="40" x2="40" y2="720" stroke="#3B82F6" stroke-width="1" stroke-dasharray="4,4"/>
    </g>

    <!-- Nemotron -->
    <g transform="translate(1120, 0)">
      <rect x="0" y="0" width="80" height="40" rx="6" fill="url(#amberGrad)" filter="url(#shadow)"/>
      <text x="40" y="18" font-family="system-ui, sans-serif" font-size="9" font-weight="600" fill="white" text-anchor="middle">Nemotron</text>
      <text x="40" y="32" font-family="system-ui, sans-serif" font-size="9" font-weight="600" fill="white" text-anchor="middle">LLM</text>
      <line x1="40" y1="40" x2="40" y2="720" stroke="#F59E0B" stroke-width="1" stroke-dasharray="4,4"/>
    </g>

    <!-- EventBroadcaster -->
    <g transform="translate(1220, 0)">
      <rect x="0" y="0" width="80" height="40" rx="6" fill="url(#roseGrad)" filter="url(#shadow)"/>
      <text x="40" y="18" font-family="system-ui, sans-serif" font-size="9" font-weight="600" fill="white" text-anchor="middle">Event</text>
      <text x="40" y="32" font-family="system-ui, sans-serif" font-size="9" font-weight="600" fill="white" text-anchor="middle">Broadcaster</text>
      <line x1="40" y1="40" x2="40" y2="720" stroke="#F43F5E" stroke-width="1" stroke-dasharray="4,4"/>
    </g>

    <!-- Dashboard -->
    <g transform="translate(1320, 0)">
      <rect x="0" y="0" width="70" height="40" rx="6" fill="url(#blueGrad)" filter="url(#shadow)"/>
      <text x="35" y="25" font-family="system-ui, sans-serif" font-size="9" font-weight="600" fill="white" text-anchor="middle">Dashboard</text>
      <line x1="35" y1="40" x2="35" y2="720" stroke="#3B82F6" stroke-width="1" stroke-dasharray="4,4"/>
    </g>
  </g>

  <!-- Sequence arrows -->
  <g transform="translate(0, 140)">
    <!-- Step 1: Camera to FTP -->
    <line x1="75" y1="0" x2="155" y2="0" stroke="#374151" stroke-width="1.5" marker-end="url(#arrowBlack)"/>
    <text x="115" y="-5" font-family="system-ui, sans-serif" font-size="9" fill="#374151" text-anchor="middle">FTP upload</text>
    <rect x="62" y="-15" width="16" height="16" rx="8" fill="#3B82F6"/>
    <text x="70" y="-3" font-family="system-ui, sans-serif" font-size="9" font-weight="600" fill="white" text-anchor="middle">1</text>

    <!-- Step 2: FTP to FileWatcher -->
    <line x1="165" y1="35" x2="250" y2="35" stroke="#374151" stroke-width="1.5" marker-end="url(#arrowBlack)"/>
    <text x="207" y="30" font-family="system-ui, sans-serif" font-size="9" fill="#374151" text-anchor="middle">watchdog event</text>
    <rect x="152" y="20" width="16" height="16" rx="8" fill="#3B82F6"/>
    <text x="160" y="32" font-family="system-ui, sans-serif" font-size="9" font-weight="600" fill="white" text-anchor="middle">2</text>

    <!-- Step 3: FileWatcher self-loop (debounce) -->
    <path d="M260,70 Q280,55 280,70 Q280,85 260,70" stroke="#374151" stroke-width="1.5" fill="none"/>
    <text x="295" y="72" font-family="system-ui, sans-serif" font-size="8" fill="#6B7280">debounce 0.5s</text>
    <text x="295" y="84" font-family="system-ui, sans-serif" font-size="8" fill="#6B7280">validate image</text>

    <!-- Step 4: FileWatcher to Queue -->
    <line x1="260" y1="105" x2="350" y2="105" stroke="#374151" stroke-width="1.5" marker-end="url(#arrowBlack)"/>
    <text x="305" y="100" font-family="system-ui, sans-serif" font-size="9" fill="#374151" text-anchor="middle">queue job</text>
    <rect x="247" y="90" width="16" height="16" rx="8" fill="#3B82F6"/>
    <text x="255" y="102" font-family="system-ui, sans-serif" font-size="9" font-weight="600" fill="white" text-anchor="middle">3</text>

    <!-- Step 5: Queue to DetectionWorker -->
    <line x1="360" y1="140" x2="450" y2="140" stroke="#374151" stroke-width="1.5" marker-end="url(#arrowBlack)"/>
    <text x="405" y="135" font-family="system-ui, sans-serif" font-size="9" fill="#374151" text-anchor="middle">BLPOP</text>
    <rect x="347" y="125" width="16" height="16" rx="8" fill="#3B82F6"/>
    <text x="355" y="137" font-family="system-ui, sans-serif" font-size="9" font-weight="600" fill="white" text-anchor="middle">4</text>

    <!-- Step 6: DetectionWorker to RT-DETRv2 -->
    <line x1="460" y1="175" x2="550" y2="175" stroke="#374151" stroke-width="1.5" marker-end="url(#arrowBlack)"/>
    <text x="505" y="170" font-family="system-ui, sans-serif" font-size="9" fill="#374151" text-anchor="middle">POST /detect</text>
    <rect x="447" y="160" width="16" height="16" rx="8" fill="#3B82F6"/>
    <text x="455" y="172" font-family="system-ui, sans-serif" font-size="9" font-weight="600" fill="white" text-anchor="middle">5</text>

    <!-- RT-DETRv2 self-loop (inference) -->
    <path d="M560,205 Q580,190 580,205 Q580,220 560,205" stroke="#F59E0B" stroke-width="1.5" fill="none"/>
    <text x="600" y="207" font-family="system-ui, sans-serif" font-size="8" fill="#B45309">inference 30-50ms</text>

    <!-- Step 7: RT-DETRv2 response -->
    <line x1="550" y1="240" x2="460" y2="240" stroke="#9CA3AF" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arrowDashed)"/>
    <text x="505" y="235" font-family="system-ui, sans-serif" font-size="9" fill="#6B7280" text-anchor="middle">{detections}</text>

    <!-- Step 8: DetectionWorker to PostgreSQL -->
    <line x1="460" y1="275" x2="650" y2="275" stroke="#374151" stroke-width="1.5" marker-end="url(#arrowBlack)"/>
    <text x="555" y="270" font-family="system-ui, sans-serif" font-size="9" fill="#374151" text-anchor="middle">INSERT detections</text>
    <rect x="447" y="260" width="16" height="16" rx="8" fill="#3B82F6"/>
    <text x="455" y="272" font-family="system-ui, sans-serif" font-size="9" font-weight="600" fill="white" text-anchor="middle">6</text>

    <!-- Optional: Enrichment -->
    <g opacity="0.6">
      <rect x="445" y="295" width="330" height="60" rx="4" fill="#FEF3C7" stroke="#F59E0B" stroke-width="1" stroke-dasharray="4,2"/>
      <text x="610" y="310" font-family="system-ui, sans-serif" font-size="8" fill="#92400E" text-anchor="middle">Optional: Enrichment Pipeline</text>
      <line x1="460" y1="325" x2="750" y2="325" stroke="#F59E0B" stroke-width="1" stroke-dasharray="3,3" marker-end="url(#arrowDashed)"/>
      <text x="605" y="340" font-family="system-ui, sans-serif" font-size="8" fill="#B45309" text-anchor="middle">enrich detections (Florence-2, CLIP)</text>
    </g>

    <!-- Fast Path Decision Box -->
    <g transform="translate(445, 370)">
      <polygon points="80,0 160,30 80,60 0,30" fill="#FEE2E2" stroke="#EF4444" stroke-width="1.5"/>
      <text x="80" y="28" font-family="system-ui, sans-serif" font-size="8" font-weight="600" fill="#991B1B" text-anchor="middle">person > 90%?</text>
      <text x="80" y="40" font-family="system-ui, sans-serif" font-size="8" fill="#B91C1C" text-anchor="middle">Fast Path?</text>
    </g>

    <!-- Fast Path: Yes -->
    <g transform="translate(445, 430)">
      <text x="170" y="-5" font-family="system-ui, sans-serif" font-size="9" font-weight="600" fill="#DC2626">Yes</text>
      <line x1="160" y1="0" x2="680" y2="0" stroke="#DC2626" stroke-width="1.5" marker-end="url(#arrowBlack)"/>
      <text x="420" y="-5" font-family="system-ui, sans-serif" font-size="8" fill="#DC2626" text-anchor="middle">immediate LLM analysis</text>
    </g>

    <!-- Normal Path: No -->
    <text x="420" y="445" font-family="system-ui, sans-serif" font-size="9" font-weight="600" fill="#374151">No</text>

    <!-- Step 9: DetectionWorker to BatchAggregator -->
    <line x1="460" y1="460" x2="850" y2="460" stroke="#374151" stroke-width="1.5" marker-end="url(#arrowBlack)"/>
    <text x="655" y="455" font-family="system-ui, sans-serif" font-size="9" fill="#374151" text-anchor="middle">add_detection()</text>
    <rect x="447" y="445" width="16" height="16" rx="8" fill="#3B82F6"/>
    <text x="455" y="457" font-family="system-ui, sans-serif" font-size="9" font-weight="600" fill="white" text-anchor="middle">7</text>

    <!-- BatchAggregator self-loop -->
    <path d="M860,490 Q880,475 880,490 Q880,505 860,490" stroke="#374151" stroke-width="1.5" fill="none"/>
    <text x="895" y="485" font-family="system-ui, sans-serif" font-size="8" fill="#6B7280">90s window</text>
    <text x="895" y="497" font-family="system-ui, sans-serif" font-size="8" fill="#6B7280">30s idle timeout</text>

    <!-- Step 10: BatchAggregator to Analysis Queue -->
    <line x1="860" y1="525" x2="950" y2="525" stroke="#374151" stroke-width="1.5" marker-end="url(#arrowBlack)"/>
    <text x="905" y="520" font-family="system-ui, sans-serif" font-size="9" fill="#374151" text-anchor="middle">queue batch</text>
    <rect x="847" y="510" width="16" height="16" rx="8" fill="#3B82F6"/>
    <text x="855" y="522" font-family="system-ui, sans-serif" font-size="9" font-weight="600" fill="white" text-anchor="middle">8</text>

    <!-- Step 11: Analysis Queue to AnalysisWorker -->
    <line x1="960" y1="555" x2="1050" y2="555" stroke="#374151" stroke-width="1.5" marker-end="url(#arrowBlack)"/>
    <text x="1005" y="550" font-family="system-ui, sans-serif" font-size="9" fill="#374151" text-anchor="middle">BLPOP</text>
    <rect x="947" y="540" width="16" height="16" rx="8" fill="#3B82F6"/>
    <text x="955" y="552" font-family="system-ui, sans-serif" font-size="9" font-weight="600" fill="white" text-anchor="middle">9</text>

    <!-- Step 12: AnalysisWorker to Nemotron -->
    <line x1="1060" y1="585" x2="1150" y2="585" stroke="#374151" stroke-width="1.5" marker-end="url(#arrowBlack)"/>
    <text x="1105" y="580" font-family="system-ui, sans-serif" font-size="9" fill="#374151" text-anchor="middle">POST /completion</text>
    <rect x="1047" y="570" width="20" height="16" rx="8" fill="#3B82F6"/>
    <text x="1057" y="582" font-family="system-ui, sans-serif" font-size="9" font-weight="600" fill="white" text-anchor="middle">10</text>

    <!-- Nemotron self-loop (inference) -->
    <path d="M1160,615 Q1180,600 1180,615 Q1180,630 1160,615" stroke="#F59E0B" stroke-width="1.5" fill="none"/>
    <text x="1195" y="617" font-family="system-ui, sans-serif" font-size="8" fill="#B45309">inference 2-5s</text>

    <!-- Step 13: Nemotron response -->
    <line x1="1150" y1="645" x2="1060" y2="645" stroke="#9CA3AF" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arrowDashed)"/>
    <text x="1105" y="640" font-family="system-ui, sans-serif" font-size="8" fill="#6B7280" text-anchor="middle">{risk_score, summary}</text>

    <!-- Step 14: AnalysisWorker to EventBroadcaster -->
    <line x1="1060" y1="670" x2="1250" y2="670" stroke="#374151" stroke-width="1.5" marker-end="url(#arrowBlack)"/>
    <text x="1155" y="665" font-family="system-ui, sans-serif" font-size="9" fill="#374151" text-anchor="middle">broadcast_event()</text>
    <rect x="1047" y="655" width="20" height="16" rx="8" fill="#3B82F6"/>
    <text x="1057" y="667" font-family="system-ui, sans-serif" font-size="9" font-weight="600" fill="white" text-anchor="middle">11</text>

    <!-- Step 15: EventBroadcaster to Dashboard -->
    <line x1="1260" y1="700" x2="1345" y2="700" stroke="#F43F5E" stroke-width="1.5" marker-end="url(#arrowBlack)"/>
    <text x="1302" y="695" font-family="system-ui, sans-serif" font-size="9" fill="#F43F5E" text-anchor="middle">WebSocket</text>
    <rect x="1247" y="685" width="20" height="16" rx="8" fill="#3B82F6"/>
    <text x="1257" y="697" font-family="system-ui, sans-serif" font-size="9" font-weight="600" fill="white" text-anchor="middle">12</text>
  </g>

  <!-- Legend -->
  <g transform="translate(30, 800)">
    <rect x="0" y="0" width="600" height="40" rx="6" fill="white" stroke="#E5E7EB" stroke-width="1"/>
    <text x="15" y="25" font-family="system-ui, sans-serif" font-size="10" font-weight="600" fill="#374151">Timing:</text>
    <text x="65" y="25" font-family="system-ui, sans-serif" font-size="10" fill="#6B7280">Fast Path ~3-6s</text>
    <text x="170" y="25" font-family="system-ui, sans-serif" font-size="10" fill="#6B7280">|</text>
    <text x="185" y="25" font-family="system-ui, sans-serif" font-size="10" fill="#6B7280">Normal Path 30-120s (batch dependent)</text>

    <line x1="420" y1="15" x2="460" y2="15" stroke="#374151" stroke-width="1.5" marker-end="url(#arrowBlack)"/>
    <text x="475" y="20" font-family="system-ui, sans-serif" font-size="10" fill="#6B7280">Request</text>

    <line x1="530" y1="15" x2="570" y2="15" stroke="#9CA3AF" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arrowDashed)"/>
    <text x="585" y="20" font-family="system-ui, sans-serif" font-size="10" fill="#6B7280">Response</text>
  </g>
</svg>
